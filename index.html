<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>碳足跡追蹤器</title>
    
    <!-- 多語言系統 -->
    <script>
        // 多語言配置
        const languages = {
            'zh-TW': {
                // 主要界面
                'app_title': '減碳日記',
                'app_subtitle': '自動偵測碳排，生活就是日記',
                'daily_record': '每日記錄',
                'feedback': '意見反饋',
                'scan_invoice': '📷 開啟相機掃描',
                'bind_carrier': '🔗 綁定電子發票載具',
                'today_carbon': '今日碳足跡',
                'total_carbon': '總碳足跡',
                'store_name': '商店名稱',
                'amount': '消費金額',
                'carbon_footprint': '碳足跡',
                'submit': '提交記錄',
                'reset': '重置',
                
                // 每日記錄模態框
                'daily_stats': '每日碳足跡統計',
                'today_total': '今日總計',
                'select_range': '選擇統計時間範圍：',
                'days_3': '近3天',
                'days_7': '近7天',
                'days_15': '近15天',
                'days_30': '近30天',
                'days_60': '近60天',
                'days_180': '近6個月',
                'custom_days': '自定義天數',
                'enter_days': '請輸入天數',
                'cumulative_stats': '累計統計',
                'average_daily': '平均每日',
                'close': '關閉',
                
                // 反饋模態框
                'feedback_title': '您的意見讓我們變得更好',
                'your_email': '您的Email',
                'feedback_content': '請告訴我們您的想法，建議或體驗的趣事...(150字內)',
                'send_feedback': '發送反饋',
                'cancel': '取消',
                'feedback_success': '感謝你的聲音，減碳日記因你而更好。',
                
                // 掃描相關
                'scanning': '掃描中...',
                'scan_success': '掃描成功！',
                'scan_failed': '掃描失敗',
                'auto_detected': '🤖 自動偵測到發票！',
                'continue_scanning': '繼續掃描',
                
                // 載具綁定
                'carrier_binding': '電子發票載具綁定',
                'carrier_code': '載具編號',
                'bind_success': '載具綁定成功',
                'bind_failed': '載具綁定失敗',
                
                // 通用
                'loading': '載入中...',
                'error': '錯誤',
                'success': '成功',
                'confirm': '確定',
                'kg_co2': 'kg CO₂',
                'ntd': 'NT$',
                'daily_target': '今日目標: 20.0 公斤 | 完成度: 0.0%',
                'gps_status': 'GPS定位成功 | 正在追蹤您的移動',
                'realtime_status_title': '📱 實時功能狀態：',
                'status_explanation': '📋 狀態說明：',
                'gps_desc': '定位您的位置，用於記錄移動軌跡',
                'sensor_desc': '檢測手機動作，判斷交通工具類型',
                'auto_tracking_desc': '自動記錄移動和發票，計算碳足跡',
                'auto_enabled_status': '✅ GPS和感應器已自動啟用，正在監測您的碳足跡',
                'breakdown_title': '今日碳足跡分解（實時偵測）',
                'transport_label': '🚗 交通運輸',
                'shopping_label': '🛒 購物消費',
                'activity_label': '📱 手機使用',
                'location_label': '📍 移動軌跡',
                'sensor_label': '📱 感應器數據',
                'daily_stats_title': '今日碳足跡統計',
                'daily_shopping': '🛒 購物消費:',
                'daily_transport': '🚗 交通移動:',
                'daily_activity': '🏃 活動感應:',
                'daily_other': '📱 其他來源:',
                'daily_invoice_count': '📋 發票數量:',
                'common_ranges': '常用時間範圍',
                'days_60_alt': '近2個月',
                'days_90': '近3個月',
                'days_120': '近4個月',
                'days_150': '近5個月',
                'movement_record': '移動記錄',
                'record_transport': '記錄交通方式',
                'invoice_management': '發票管理',
                'bind_scan_detect': '綁定載具 & 掃描發票',
                'auto_detect_carbon': '自動偵測碳足跡',
                'data_analysis': '數據分析',
                'view_detailed_stats': '查看詳細統計',
                'settings': '設定',
                'personalized_settings': '個人化設定',
                'invoice_management_title': '🧾 發票管理',
                'e_invoice_carrier': '📱 電子發票載具',
                'carrier_not_bound': '未綁定載具',
                'sync_carrier_invoices': '🔄 同步載具發票',
                'auto_sync_status': '自動同步:',
                'sync_enabled': '已啟用',
                'traditional_invoice_scan': '📷 傳統發票掃描',
                'store_placeholder': '例如: 全聯福利中心',
                'amount_placeholder': '例如: 150',
                'carbon_placeholder': '掃描後自動計算',
                'recent_invoice_records': '📋 最近發票記錄',
                'record_movement_title': '🚗 記錄移動',
                'movement_method': '移動方式',
                'driving': '開車',
                'walking': '步行',
                'cycling': '騎自行車',
                'public_transport': '大眾運輸',
                'distance_km': '距離 (公里)',
                'time_minutes': '時間 (分鐘)',
                'record_movement': '記錄移動',
                'manual_activity_title': '🏃 手動記錄活動',
                'activity_type': '活動類型',
                'activity_duration': '活動時長 (分鐘)',
                'activity_intensity': '活動強度',
                'low_intensity': '低強度',
                'medium_intensity': '中強度',
                'high_intensity': '高強度',
                'record_activity': '記錄活動',
                'settings_title': '⚙️ 設定',
                'daily_goal_kg': '每日碳足跡目標 (公斤)',
                'gps_positioning': '📍 GPS定位中...',
                'enabled': '啟用',
                'disabled': '停用',
                'save_settings': '儲存設定',
                'gps_status_loading': '🔄 GPS定位中...',
                'sensor_loading': '🔄 感應器啟動中...',
                'auto_tracking_enabled': '✅ 自動追蹤功能已啟用',
                'gps_status_checking': '📍 GPS狀態檢測中...',
                'gps_failed': '📍 GPS定位失敗 | 請檢查權限設定',
                'distance_placeholder': '例如: 5.2',
                'time_placeholder': '例如: 30',
                'sync_disabled': '已停用',
                'analytics_feature': '📊 數據分析功能',
                'full_version_features': '在完整版本中，這裡會顯示',
                'historical_trends': '歷史趨勢圖表',
                'categorized_stats': '分類統計',
                'eco_suggestions': '環保建議',
                'goal_achievement': '目標達成情況',
                'sensor_enabled': '✅ 感應器已啟用，持續監聽中...',
                'sensor_not_supported': '❌ 瀏覽器不支援感應器',
                'sensor_normal': '📊 感應器正常 (加速度: {acceleration}m/s²)',
                'sensor_permission_denied': '❌ 感應器權限被拒絕，請點擊「測試感應器」按鈕',
                'sensor_permission_failed': '❌ 感應器權限請求失敗，請點擊「測試感應器」按鈕',
                'gps_success_status': '📍 GPS定位成功 | 正在追蹤您的移動',
                'gps_success_accuracy': '✅ GPS定位成功 (精度: {accuracy}米)',
                'auto_tracking_enabled': '✅ 自動追蹤功能已啟用',
                'gps_sensor_monitoring': '✅ GPS和感應器已啟用，正在監測您的碳足跡',
                'gps_waiting_sensor': '⚠️ GPS已啟用，等待感應器就緒',
                'gps_waiting_permission': '✅ GPS已啟用，等待感應器權限',
                'sensor_label_short': '感應器',
                'auto_tracking_label_short': '自動追蹤',
                'settings_saved': '設定已儲存！',
                'email_placeholder': '請輸入您的email',
                'feedback_placeholder': '請告訴我們您的想法、建議或體驗的趣事...(150字內)',
                'confirm': '確定',
                'auto_tracking': '自動追蹤',
                'real_time_analytics': '基於您的自動偵測數據',
                'today_summary': '今日摘要',
                'today_carbon': '今日碳足跡 (kg)',
                'goal_progress': '目標進度',
                'category_breakdown': '分類統計',
                'weekly_trends': '近7天趨勢'
            },
            'zh-CN': {
                // 主要界面
                'app_title': '减碳日记',
                'app_subtitle': '自动侦测碳排，生活就是日记',
                'daily_record': '每日记录',
                'feedback': '意见反馈',
                'scan_invoice': '📷 开启相机扫描',
                'bind_carrier': '🔗 绑定电子发票载具',
                'today_carbon': '今日碳足迹',
                'total_carbon': '总碳足迹',
                'store_name': '商店名称',
                'amount': '消费金额',
                'carbon_footprint': '碳足迹',
                'submit': '提交记录',
                'reset': '重置',
                
                // 每日记录模态框
                'daily_stats': '每日碳足迹统计',
                'today_total': '今日总计',
                'select_range': '选择统计时间范围：',
                'days_3': '近3天',
                'days_7': '近7天',
                'days_15': '近15天',
                'days_30': '近30天',
                'days_60': '近60天',
                'days_180': '近6个月',
                'custom_days': '自定义天数',
                'enter_days': '请输入天数',
                'cumulative_stats': '累计统计',
                'average_daily': '平均每日',
                'close': '关闭',
                
                // 反馈模态框
                'feedback_title': '您的意见让我们变得更好',
                'your_email': '您的Email',
                'feedback_content': '请告诉我们您的想法，建议或体验的趣事...(150字内)',
                'send_feedback': '发送反馈',
                'cancel': '取消',
                'feedback_success': '感谢你的声音，减碳日记因你而更好。',
                
                // 扫描相关
                'scanning': '扫描中...',
                'scan_success': '扫描成功！',
                'scan_failed': '扫描失败',
                'auto_detected': '🤖 自动侦测到发票！',
                'continue_scanning': '继续扫描',
                
                // 载具绑定
                'carrier_binding': '电子发票载具绑定',
                'carrier_code': '载具编号',
                'bind_success': '载具绑定成功',
                'bind_failed': '载具绑定失败',
                
                // 通用
                'loading': '加载中...',
                'error': '错误',
                'success': '成功',
                'confirm': '确定',
                'kg_co2': 'kg CO₂',
                'ntd': '¥',
                'daily_target': '今日目标: 20.0 公斤 | 完成度: 0.0%',
                'gps_status': 'GPS定位成功 | 正在追踪您的移动',
                'realtime_status_title': '📱 实时功能状态：',
                'status_explanation': '📋 状态说明：',
                'gps_desc': '定位您的位置，用于记录移动轨迹',
                'sensor_desc': '检测手机动作，判断交通工具类型',
                'auto_tracking_desc': '自动记录移动和发票，计算碳足迹',
                'auto_enabled_status': '✅ GPS和感应器已自动启用，正在监测您的碳足迹',
                'breakdown_title': '今日碳足迹分解（实时侦测）',
                'transport_label': '🚗 交通运输',
                'shopping_label': '🛒 购物消费',
                'activity_label': '📱 手机使用',
                'location_label': '📍 移动轨迹',
                'sensor_label': '📱 感应器数据',
                'daily_stats_title': '今日碳足迹统计',
                'daily_shopping': '🛒 购物消费:',
                'daily_transport': '🚗 交通移动:',
                'daily_activity': '🏃 活动感应:',
                'daily_other': '📱 其他来源:',
                'daily_invoice_count': '📋 发票数量:',
                'common_ranges': '常用时间范围',
                'days_60_alt': '近2个月',
                'days_90': '近3个月',
                'days_120': '近4个月',
                'days_150': '近5个月',
                'movement_record': '移动记录',
                'record_transport': '记录交通方式',
                'invoice_management': '发票管理',
                'bind_scan_detect': '绑定载具 & 扫描发票',
                'auto_detect_carbon': '自动侦测碳足迹',
                'data_analysis': '数据分析',
                'view_detailed_stats': '查看详细统计',
                'settings': '设定',
                'personalized_settings': '个性化设定',
                'invoice_management_title': '🧾 发票管理',
                'e_invoice_carrier': '📱 电子发票载具',
                'carrier_not_bound': '未绑定载具',
                'sync_carrier_invoices': '🔄 同步载具发票',
                'auto_sync_status': '自动同步:',
                'sync_enabled': '已启用',
                'traditional_invoice_scan': '📷 传统发票扫描',
                'store_placeholder': '例如: 全联福利中心',
                'amount_placeholder': '例如: 150',
                'carbon_placeholder': '扫描后自动计算',
                'recent_invoice_records': '📋 最近发票记录',
                'record_movement_title': '🚗 记录移动',
                'movement_method': '移动方式',
                'driving': '开车',
                'walking': '步行',
                'cycling': '骑自行车',
                'public_transport': '大众运输',
                'distance_km': '距离 (公里)',
                'time_minutes': '时间 (分钟)',
                'record_movement': '记录移动',
                'manual_activity_title': '🏃 手动记录活动',
                'activity_type': '活动类型',
                'activity_duration': '活动时长 (分钟)',
                'activity_intensity': '活动强度',
                'low_intensity': '低强度',
                'medium_intensity': '中强度',
                'high_intensity': '高强度',
                'record_activity': '记录活动',
                'settings_title': '⚙️ 设定',
                'daily_goal_kg': '每日碳足迹目标 (公斤)',
                'gps_positioning': '📍 GPS定位中...',
                'enabled': '启用',
                'disabled': '停用',
                'save_settings': '储存设定',
                'gps_status_loading': '🔄 GPS定位中...',
                'sensor_loading': '🔄 感应器启动中...',
                'auto_tracking_enabled': '✅ 自动追踪功能已启用',
                'gps_status_checking': '📍 GPS状态检测中...',
                'gps_failed': '📍 GPS定位失败 | 请检查权限设定',
                'distance_placeholder': '例如: 5.2',
                'time_placeholder': '例如: 30',
                'sync_disabled': '已停用',
                'analytics_feature': '📊 数据分析功能',
                'full_version_features': '在完整版本中，这里会显示',
                'historical_trends': '历史趋势图表',
                'categorized_stats': '分类统计',
                'eco_suggestions': '环保建议',
                'goal_achievement': '目标达成情况',
                'sensor_enabled': '✅ 感应器已启用，持续监听中...',
                'sensor_not_supported': '❌ 浏览器不支持感应器',
                'sensor_normal': '📊 感应器正常 (加速度: {acceleration}m/s²)',
                'sensor_permission_denied': '❌ 感应器权限被拒绝，请点击「测试感应器」按钮',
                'sensor_permission_failed': '❌ 感应器权限请求失败，请点击「测试感应器」按钮',
                'gps_success_status': '📍 GPS定位成功 | 正在追踪您的移动',
                'gps_success_accuracy': '✅ GPS定位成功 (精度: {accuracy}米)',
                'auto_tracking_enabled': '✅ 自动追踪功能已启用',
                'gps_sensor_monitoring': '✅ GPS和感应器已启用，正在监测您的碳足迹',
                'gps_waiting_sensor': '⚠️ GPS已启用，等待感应器就绪',
                'gps_waiting_permission': '✅ GPS已启用，等待感应器权限',
                'sensor_label_short': '感应器',
                'auto_tracking_label_short': '自动追踪',
                'settings_saved': '设定已储存！',
                'auto_tracking': '自动追踪',
                'real_time_analytics': '基于您的自动侦测数据',
                'today_summary': '今日摘要',
                'today_carbon': '今日碳足迹 (kg)',
                'goal_progress': '目标进度',
                'category_breakdown': '分类统计',
                'weekly_trends': '近7天趋势'
            },
            'en': {
                // 主要界面
                'app_title': 'Carbon Diary',
                'app_subtitle': 'Auto-detect carbon emissions, life is a diary',
                'daily_record': 'Daily Record',
                'feedback': 'Feedback',
                'scan_invoice': '📷 Open Camera Scan',
                'bind_carrier': '🔗 Bind E-Invoice Carrier',
                'today_carbon': 'Today\'s Carbon',
                'total_carbon': 'Total Carbon',
                'store_name': 'Store Name',
                'amount': 'Amount',
                'carbon_footprint': 'Carbon Footprint',
                'submit': 'Submit',
                'reset': 'Reset',
                
                // 每日记录模态框
                'daily_stats': 'Daily Carbon Statistics',
                'today_total': 'Today\'s Total',
                'select_range': 'Select time range:',
                'days_3': 'Last 3 days',
                'days_7': 'Last 7 days',
                'days_15': 'Last 15 days',
                'days_30': 'Last 30 days',
                'days_60': 'Last 60 days',
                'days_180': 'Last 6 months',
                'custom_days': 'Custom days',
                'enter_days': 'Enter days',
                'cumulative_stats': 'Cumulative Stats',
                'average_daily': 'Daily Average',
                'close': 'Close',
                
                // 反馈模态框
                'feedback_title': 'Your feedback makes us better',
                'your_email': 'Your Email',
                'feedback_content': 'Tell us your thoughts, suggestions or interesting experiences... (within 150 characters)',
                'send_feedback': 'Send Feedback',
                'cancel': 'Cancel',
                'feedback_success': 'Thank you for your voice, Carbon Diary is better because of you.',
                
                // 扫描相关
                'scanning': 'Scanning...',
                'scan_success': 'Scan successful!',
                'scan_failed': 'Scan failed',
                'auto_detected': '🤖 Invoice auto-detected!',
                'continue_scanning': 'Continue Scanning',
                
                // 载具绑定
                'carrier_binding': 'E-Invoice Carrier Binding',
                'carrier_code': 'Carrier Code',
                'bind_success': 'Carrier bound successfully',
                'bind_failed': 'Carrier binding failed',
                
                // 通用
                'loading': 'Loading...',
                'error': 'Error',
                'success': 'Success',
                'confirm': 'Confirm',
                'kg_co2': 'kg CO₂',
                'ntd': '$',
                'daily_target': 'Daily Goal: 20.0 kg | Progress: 0.0%',
                'gps_status': 'GPS positioning successful | Tracking your movement',
                'realtime_status_title': '📱 Real-time Function Status:',
                'status_explanation': '📋 Status Explanation:',
                'gps_desc': 'Locate your position, used to record movement trajectories',
                'sensor_desc': 'Detect phone movements, determine transportation type',
                'auto_tracking_desc': 'Automatically record movements and invoices, calculate carbon footprint',
                'auto_enabled_status': '✅ GPS and sensors are automatically enabled, monitoring your carbon footprint',
                'breakdown_title': 'Today\'s Carbon Footprint Breakdown (Real-time Detection)',
                'transport_label': '🚗 Transportation',
                'shopping_label': '🛒 Shopping',
                'activity_label': '📱 Phone Usage',
                'location_label': '📍 Movement Tracking',
                'sensor_label': '📱 Sensor Data',
                'daily_stats_title': 'Today\'s Carbon Footprint Statistics',
                'daily_shopping': '🛒 Shopping:',
                'daily_transport': '🚗 Transportation:',
                'daily_activity': '🏃 Activity Detection:',
                'daily_other': '📱 Other Sources:',
                'daily_invoice_count': '📋 Invoice Count:',
                'common_ranges': 'Common Time Ranges',
                'days_60_alt': 'Last 2 Months',
                'days_90': 'Last 3 Months',
                'days_120': 'Last 4 Months',
                'days_150': 'Last 5 Months',
                'movement_record': 'Movement Record',
                'record_transport': 'Record Transportation',
                'invoice_management': 'Invoice Management',
                'bind_scan_detect': 'Bind Carrier & Scan Invoice',
                'auto_detect_carbon': 'Auto-detect Carbon Footprint',
                'data_analysis': 'Data Analysis',
                'view_detailed_stats': 'View Detailed Statistics',
                'settings': 'Settings',
                'personalized_settings': 'Personalized Settings',
                'invoice_management_title': '🧾 Invoice Management',
                'e_invoice_carrier': '📱 E-Invoice Carrier',
                'carrier_not_bound': 'Carrier Not Bound',
                'sync_carrier_invoices': '🔄 Sync Carrier Invoices',
                'auto_sync_status': 'Auto Sync:',
                'sync_enabled': 'Enabled',
                'traditional_invoice_scan': '📷 Traditional Invoice Scan',
                'store_placeholder': 'e.g., PX Mart',
                'amount_placeholder': 'e.g., 150',
                'carbon_placeholder': 'Auto-calculated after scan',
                'recent_invoice_records': '📋 Recent Invoice Records',
                'record_movement_title': '🚗 Record Movement',
                'movement_method': 'Movement Method',
                'driving': 'Driving',
                'walking': 'Walking',
                'cycling': 'Cycling',
                'public_transport': 'Public Transport',
                'distance_km': 'Distance (km)',
                'time_minutes': 'Time (minutes)',
                'record_movement': 'Record Movement',
                'manual_activity_title': '🏃 Manual Activity Record',
                'activity_type': 'Activity Type',
                'activity_duration': 'Duration (minutes)',
                'activity_intensity': 'Activity Intensity',
                'low_intensity': 'Low Intensity',
                'medium_intensity': 'Medium Intensity',
                'high_intensity': 'High Intensity',
                'record_activity': 'Record Activity',
                'settings_title': '⚙️ Settings',
                'daily_goal_kg': 'Daily Carbon Goal (kg)',
                'gps_positioning': '📍 GPS positioning...',
                'enabled': 'Enabled',
                'disabled': 'Disabled',
                'save_settings': 'Save Settings',
                'gps_status_loading': '🔄 GPS positioning...',
                'sensor_loading': '🔄 Sensors activating...',
                'auto_tracking_enabled': '✅ Automatic tracking enabled',
                'gps_status_checking': '📍 GPS status checking...',
                'gps_failed': '📍 GPS positioning failed | Please check permissions',
                'distance_placeholder': 'e.g., 5.2',
                'time_placeholder': 'e.g., 30',
                'sync_disabled': 'Disabled',
                'analytics_feature': '📊 Data Analysis Feature',
                'full_version_features': 'In the full version, this will display',
                'historical_trends': 'Historical trend charts',
                'categorized_stats': 'Categorized statistics',
                'eco_suggestions': 'Environmental protection suggestions',
                'goal_achievement': 'Goal achievement status',
                'sensor_enabled': '✅ Sensors enabled, continuously monitoring...',
                'sensor_not_supported': '❌ Browser does not support sensors',
                'sensor_normal': '📊 Sensors normal (acceleration: {acceleration}m/s²)',
                'sensor_permission_denied': '❌ Sensor permission denied, please click "Test Sensor" button',
                'sensor_permission_failed': '❌ Sensor permission request failed, please click "Test Sensor" button',
                'gps_success_status': '📍 GPS positioning successful | Tracking your movement',
                'gps_success_accuracy': '✅ GPS positioning successful (accuracy: {accuracy}m)',
                'auto_tracking_enabled': '✅ Automatic tracking function enabled',
                'gps_sensor_monitoring': '✅ GPS and sensors enabled, monitoring your carbon footprint',
                'gps_waiting_sensor': '⚠️ GPS enabled, waiting for sensors to be ready',
                'gps_waiting_permission': '✅ GPS enabled, waiting for sensor permissions',
                'sensor_label_short': 'Sensors',
                'auto_tracking_label_short': 'Auto Tracking',
                'settings_saved': 'Settings saved!',
                'email_placeholder': 'Please enter your email',
                'feedback_placeholder': 'Tell us your thoughts, suggestions or interesting experiences... (within 150 characters)',
                'confirm': 'OK',
                'auto_tracking': 'Auto Tracking',
                'real_time_analytics': 'Based on your auto-detected data',
                'today_summary': 'Today Summary',
                'today_carbon': 'Today Carbon Footprint (kg)',
                'goal_progress': 'Goal Progress',
                'category_breakdown': 'Category Breakdown',
                'weekly_trends': '7-Day Trends'
            }
        };
        
        // 當前語言
        let currentLanguage = localStorage.getItem('selectedLanguage') || 'zh-TW';
        
        // 語言切換函數
        function switchLanguage(lang) {
            console.log('切換語言到:', lang);
            currentLanguage = lang;
            localStorage.setItem('selectedLanguage', lang);
            updateLanguage();
            console.log('語言切換完成，當前語言:', currentLanguage);
        }
        
        // 更新界面語言
        function updateLanguage() {
            console.log('更新界面語言，當前語言:', currentLanguage);
            const lang = languages[currentLanguage];
            
            if (!lang) {
                console.error('找不到語言配置:', currentLanguage);
                return;
            }
            
            // 更新所有帶有 data-lang 屬性的元素
            const elements = document.querySelectorAll('[data-lang]');
            console.log('找到需要更新的元素數量:', elements.length);
            
            elements.forEach(element => {
                const key = element.getAttribute('data-lang');
                if (lang[key]) {
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'number')) {
                        element.placeholder = lang[key];
                    } else if (element.tagName === 'TEXTAREA') {
                        element.placeholder = lang[key];
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = lang[key];
                    } else {
                        element.textContent = lang[key];
                    }
                    console.log('更新元素:', key, '->', lang[key]);
                }
            });
            
            // 更新標題
            document.title = lang['app_title'];
            console.log('更新標題:', lang['app_title']);
            
            // 更新語言選擇器狀態
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                languageSelect.value = currentLanguage;
                console.log('更新語言選擇器值:', currentLanguage);
            } else {
                console.error('找不到語言選擇器元素');
            }
        }
        
        // 獲取翻譯文本
        function t(key) {
            return languages[currentLanguage][key] || key;
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            /* iPhone Chrome滾動修復 */
            overflow-x: hidden;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            position: relative;
            /* 強制啟用硬體加速 */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            /* iPhone Chrome滾動優化 */
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            position: relative;
            /* 強制啟用硬體加速 */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        /* .header 類別已刪除，不再使用 */
        
        .stats-card {
            margin: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .carbon-number {
            font-size: 48px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .carbon-unit {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 62.5%;
            transition: width 0.3s ease;
        }
        
        .goal-text {
            font-size: 14px;
            color: #666;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px;
            min-height: auto;
            position: relative;
            z-index: 10;
        }
        
        .menu-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
            /* 改善手機觸控 */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
        }
        
        .menu-item:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .menu-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .menu-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .menu-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* .location-status 類別已刪除，不再使用 */
        
        .status-text {
            font-size: 14px;
            color: #1976D2;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            /* 改善手機輸入體驗 */
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* 語言切換器樣式 */
        .language-switcher {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .lang-select {
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: normal;
            color: #4CAF50;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234CAF50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 10px;
            padding-right: 20px;
            min-width: 45px;
        }
        
        .lang-select:focus {
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .lang-select option {
            background: white;
            color: #333;
            padding: 8px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            /* 改善手機觸控 */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            min-height: 44px; /* 確保觸控目標足夠大 */
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .camera-btn {
            background: #FF9800;
        }
        
        .camera-btn:hover {
            background: #F57C00;
        }
        
        .breakdown {
            margin: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
            /* 改善手機滾動 */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }
        
        .breakdown-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-label {
            font-size: 14px;
        }
        
        .breakdown-value {
            font-weight: 600;
            color: #4CAF50;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- 語言切換器 -->
    <div class="language-switcher">
        <select class="lang-select" id="languageSelect" onchange="switchLanguage(this.value)">
            <option value="zh-TW">繁體</option>
            <option value="zh-CN">簡體</option>
            <option value="en">EN</option>
        </select>
    </div>
    
    <div class="container">
        <!-- 綠色標題卡片，貼著頁面上緣 -->
        <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 20px; margin: 0; border-radius: 0 0 15px 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative;">
            <!-- LOGO放在左上角，黏著邊界 -->
            <img src="ctx-logo.png?v=202509251400" alt="ctx-logo" style="position: absolute; top: 0; left: 0; width: 80px; height: 80px; border-radius: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="position: absolute; top: 0; left: 0; width: 80px; height: 80px; border-radius: 8px; background: #4CAF50; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                🌱
            </div>
            <!-- 標題文字區域 -->
            <div style="display: flex; align-items: center; justify-content: center; margin-left: 90px; margin-right: 90px;">
                <div style="text-align: center;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: bold;">
                            <span style="display: inline-block; width: 0; overflow: hidden;">🌱</span><span data-lang="app_title">減碳日記</span>
                        </h1>
                        <p style="margin: 5px 0 0 0; font-size: 16px; opacity: 0.9; white-space: nowrap;" data-lang="app_subtitle">自動偵測碳排，生活就是日記</p>
                </div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="carbon-number" id="realTimeCarbon">0.0</div>
            <div class="carbon-unit">公斤 CO₂</div>
            <div class="progress-bar">
                <div class="progress-fill" id="realTimeProgress"></div>
            </div>
            <div class="goal-text" id="realTimeGoal" data-lang="daily_target">今日目標: 20.0 公斤 | 完成度: 0.0%</div>
            <button onclick="openModal('settings')" style="
                background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                margin-top: 8px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(255,152,0,0.3);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                🎯 設定個人化目標
            </button>
        </div>
        
        <div style="margin: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div class="status-text" id="locationStatusText" data-lang="gps_status">GPS定位成功 | 正在追蹤您的移動</div>
        </div>
        
        <div style="margin: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <div style="font-size: 14px; color: #856404;">
                <strong data-lang="realtime_status_title">📱 實時功能狀態：</strong><br>
                <span id="gpsStatus"></span><br>
                <span id="sensorStatus"></span><br>
                <span id="autoTracking"></span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong data-lang="status_explanation">📋 狀態說明：</strong><br>
                • <strong>GPS</strong>：<span data-lang="gps_desc">定位您的位置，用於記錄移動軌跡</span><br>
                • <strong data-lang="sensor_label_short">感應器</strong>：<span data-lang="sensor_desc">檢測手機動作，判斷交通工具類型</span><br>
                • <strong data-lang="auto_tracking_label_short">自動追蹤</strong>：<span data-lang="auto_tracking_desc">自動記錄移動和發票，計算碳足跡</span>
            </div>
            <div style="margin-top: 10px; text-align: center; color: #666; font-size: 14px;" id="statusMessage">
                <span>📍 請點擊下方按鈕啟用GPS和感應器功能</span>
            </div>
            
            <!-- GPS和感應器啟用按鈕 -->
            <div id="enableBtn" style="display: block; margin: 10px 0;">
                <button onclick="enableGPSAndSensor()" style="
                    background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
                    width: 100%;
                    margin-bottom: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    🚀 啟用GPS和感應器功能
                </button>
            </div>
            
            <!-- Chrome專用GPS權限按鈕 -->
            <div id="chromeGPSButton" style="display: none; margin: 10px 0;">
                <button onclick="requestChromeGPSPermission()" style="
                    background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
                    transition: all 0.3s ease;
                    width: 100%;
                ">
                    📍 點擊啟用Chrome GPS定位
                </button>
            </div>
            
            <div style="margin-top: 10px;">
                <button class="btn" onclick="triggerDailyRecord()" id="dailyRecordBtn" data-lang="daily_record" style="background: #FF9800; color: white; font-size: 12px; padding: 8px; min-height: 36px; width: 100%; border: none; border-radius: 6px; cursor: pointer;">
                    🕛 每日記錄
                </button>
            </div>
            
            <div style="margin-top: 10px;">
                <button class="btn" onclick="showFeedbackForm()" data-lang="feedback" style="background: #9C27B0; color: white; font-size: 12px; padding: 8px; min-height: 36px; width: 100%; border: none; border-radius: 6px; cursor: pointer;">
                    📝 意見反饋
                </button>
            </div>
        </div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="openModal('settings')" style="background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%); color: #4A148C;">
                <div class="menu-icon">⚙️</div>
                <div class="menu-title" data-lang="settings" style="color: white;">設定</div>
                <div class="menu-desc" style="color: black;" data-lang="personalized_settings">個人化設定</div>
            </div>
            
            <div class="menu-item" onclick="openModal('invoice')" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;">
                <div class="menu-icon">🧾</div>
                <div class="menu-title" data-lang="invoice_management">發票管理</div>
                <div class="menu-desc" style="color: black;" data-lang="bind_scan_detect">綁定載具 & 掃描發票</div>
                <div class="menu-desc" style="color: black; font-size: 12px; margin-top: 2px;" data-lang="auto_detect_carbon">自動偵測碳足跡</div>
            </div>
            
            <div class="menu-item" onclick="openModal('movement')" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                <div class="menu-icon">🚗</div>
                <div class="menu-title" data-lang="movement_record">移動記錄</div>
                <div class="menu-desc" style="color: black;" data-lang="record_transport">記錄交通方式</div>
            </div>
            
            <div class="menu-item" onclick="showAnalytics()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">
                <div class="menu-icon">📊</div>
                <div class="menu-title" data-lang="data_analysis">數據分析</div>
                <div class="menu-desc" style="color: black;" data-lang="view_detailed_stats">查看詳細統計</div>
            </div>
        </div>
        
        <div class="breakdown">
            <div class="breakdown-title" data-lang="breakdown_title">今日碳足跡分解（實時偵測）</div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="transport_label">🚗 交通運輸</span>
                <span class="breakdown-value" id="transportCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="shopping_label">🛒 購物消費</span>
                <span class="breakdown-value" id="shoppingCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="activity_label">🏃 活動偵測</span>
                <span class="breakdown-value" id="activityCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="location_label">📍 位置變化</span>
                <span class="breakdown-value" id="locationCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="sensor_label">📱 感應器數據</span>
                <span class="breakdown-value" id="sensorCarbon">0.0 kg</span>
            </div>
        </div>
    </div>
    
    <!-- 移動記錄模態框 -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang="record_movement_title">🚗 記錄移動</h3>
                <button class="close-btn" onclick="closeModal('movementModal')">&times;</button>
            </div>
            <div class="form-group">
                <label data-lang="movement_method">移動方式</label>
                <select id="movementType">
                    <option value="driving" data-lang="driving">開車</option>
                    <option value="walking" data-lang="walking">步行</option>
                    <option value="cycling" data-lang="cycling">騎自行車</option>
                    <option value="public_transport" data-lang="public_transport">大眾運輸</option>
                    <option value="flying">飛機</option>
                </select>
            </div>
            <div class="form-group">
                <label data-lang="distance_km">距離 (公里)</label>
                <input type="number" id="distance" placeholder="例如: 5.2" step="0.1" data-lang="distance_placeholder">
            </div>
            <div class="form-group">
                <label data-lang="time_minutes">時間 (分鐘)</label>
                <input type="number" id="duration" placeholder="例如: 30" data-lang="time_placeholder">
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn" onclick="submitMovement()" data-lang="record_movement" style="background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    記錄移動
                </button>
                <button class="btn" onclick="showManualActivityForm()" data-lang="manual_activity_title" style="background: #FF9800; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    手動記錄活動
                </button>
            </div>
        </div>
    </div>
    
    <!-- 發票管理模態框 -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang="invoice_management_title">🧾 發票管理</h3>
                <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            
            <!-- 電子發票載具綁定 -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #4CAF50;">
                <h4 style="margin-bottom: 10px; color: #2e7d32;" data-lang="e_invoice_carrier">📱 電子發票載具</h4>
                <div id="carrierStatus" style="margin-bottom: 10px;">
                    <span id="carrierInfo" data-lang="carrier_not_bound">未綁定載具</span>
                </div>
                <button class="btn" onclick="bindCarrier()" data-lang="bind_carrier" style="background: #4CAF50; margin-bottom: 10px;">
                    🔗 綁定電子發票載具
                </button>
                <button class="btn" onclick="checkCarrierInvoices()" style="background: #2196F3; margin-bottom: 10px;" data-lang="sync_carrier_invoices">
                    🔄 同步載具發票
                </button>
                <div id="autoSyncStatus" style="font-size: 12px; color: #666; margin-top: 5px;" data-lang="auto_sync_status">
                    自動同步: <span id="syncStatus" data-lang="sync_enabled">已啟用</span>
                </div>
            </div>
            
            <!-- 傳統發票掃描 -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #FF9800;">
                <h4 style="margin-bottom: 10px; color: #e65100;" data-lang="traditional_invoice_scan">📷 傳統發票掃描</h4>
                <div class="form-group">
                    <label data-lang="store_name">商店名稱</label>
                    <input type="text" id="storeName" placeholder="例如: 全聯福利中心" data-lang="store_placeholder">
                </div>
                <div class="form-group">
                    <label data-lang="amount">消費金額</label>
                    <input type="number" id="amount" placeholder="例如: 150" step="0.01" data-lang="amount_placeholder">
                </div>
                <div class="form-group">
                    <label data-lang="carbon_footprint">碳足跡</label>
                    <input type="text" id="carbonFootprint" placeholder="掃描後自動計算" readonly style="background-color: #f8f9fa; color: #4CAF50; font-weight: bold;" data-lang="carbon_placeholder">
                </div>
                <button class="btn camera-btn" onclick="scanInvoice()" data-lang="scan_invoice">📷 開啟相機掃描</button>
            </div>
            
            <!-- 最近發票記錄 -->
            <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;" data-lang="recent_invoice_records">📋 最近發票記錄</h4>
                <div id="recentInvoices" style="max-height: 200px; overflow-y: auto;">
                    <div style="padding: 10px; text-align: center; color: #666;">
                        <span data-lang="loading">載入中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 設定模態框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang="settings_title">⚙️ 設定</h3>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label data-lang="user_profile">👤 用戶檔案</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 14px; font-weight: bold;">年齡層：</label>
                        <select id="ageGroup" onchange="updatePersonalizedGoal()" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="">請選擇年齡層</option>
                            <option value="18-25">18-25歲</option>
                            <option value="26-35">26-35歲</option>
                            <option value="36-50">36-50歲</option>
                            <option value="51-65">51-65歲</option>
                            <option value="65+">65歲以上</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 14px; font-weight: bold;">居住區域：</label>
                        <select id="residenceType" onchange="updatePersonalizedGoal()" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="">請選擇居住區域</option>
                            <option value="urban">都市</option>
                            <option value="suburban">郊區</option>
                            <option value="rural">鄉村</option>
                        </select>
                    </div>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                        <div style="font-size: 14px; font-weight: bold; color: #2e7d32;">個人化目標：</div>
                        <div id="personalizedGoalDisplay" style="font-size: 18px; color: #1b5e20; font-weight: bold;">20.0 公斤 CO₂/天</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">基於您的年齡層和居住區域調整</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label data-lang="daily_goal_kg">每日碳足跡目標 (公斤)</label>
                <input type="number" id="dailyGoal" value="20" step="0.1" onchange="updateGoalFromInput()">
                <div style="font-size: 12px; color: #666; margin-top: 5px;">手動調整目標或使用個人化建議</div>
            </div>
            <div class="form-group">
                <label data-lang="gps_positioning">GPS定位</label>
                <select id="gpsEnabled">
                    <option value="true" data-lang="enabled">啟用</option>
                    <option value="false" data-lang="disabled">停用</option>
                </select>
            </div>
            <div class="form-group">
                <label data-lang="auto_tracking">自動追蹤</label>
                <select id="autoTrackingSetting">
                    <option value="true" data-lang="enabled">啟用</option>
                    <option value="false" data-lang="disabled">停用</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveSettings()" data-lang="save_settings" style="flex: 1;">儲存設定</button>
                <button class="btn" onclick="testPersonalizedGoal()" style="flex: 1; background: #FF9800; color: white;">測試個人化目標</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://172.20.10.6:3002';
        
        // 開啟模態框
        function openModal(type) {
            if (type === 'movement') {
                document.getElementById('movementModal').style.display = 'block';
            } else if (type === 'invoice') {
                document.getElementById('invoiceModal').style.display = 'block';
            } else if (type === 'settings') {
                document.getElementById('settingsModal').style.display = 'block';
            }
        }
        
        // 關閉模態框
        function closeModal(modalIdOrElement) {
            let modal;
            if (typeof modalIdOrElement === 'string') {
                // 如果是字符串，當作ID處理
                modal = document.getElementById(modalIdOrElement);
            } else {
                // 如果是元素，當作元素處理
                modal = modalIdOrElement.closest('.modal');
            }
            
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 提交移動記錄
        async function submitMovement() {
            const type = document.getElementById('movementType').value;
            const distance = parseFloat(document.getElementById('distance').value);
            const duration = parseInt(document.getElementById('duration').value);
            
            if (!distance || !duration) {
                alert('請填寫完整信息');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/movement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type, distance, duration })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('移動記錄已保存！');
                    closeModal('movementModal');
                    updateStats();
                } else {
                    alert('保存失敗：' + result.error);
                }
            } catch (error) {
                alert('網絡錯誤：' + error.message);
            }
        }
        
        // 顯示手動活動記錄表單
        function showManualActivityForm() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">🏃</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;" data-lang="manual_activity_title">手動記錄活動</h3>
                            <div style="font-size: 14px; opacity: 0.9;">記錄您的手機無法偵測到的活動</div>
                        </div>
                        
                        <form id="manualActivityForm" style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="activity_type">活動類型</label>
                                <select id="activityType" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                    <option value="running" style="color: black;">跑步</option>
                                    <option value="gym" style="color: black;">健身房</option>
                                    <option value="swimming" style="color: black;">游泳</option>
                                    <option value="hiking" style="color: black;">登山健行</option>
                                    <option value="basketball" style="color: black;">籃球</option>
                                    <option value="football" style="color: black;">足球</option>
                                    <option value="tennis" style="color: black;">網球</option>
                                    <option value="yoga" style="color: black;">瑜伽</option>
                                    <option value="dancing" style="color: black;">舞蹈</option>
                                    <option value="other" style="color: black;">其他運動</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="activity_duration">活動時長 (分鐘)</label>
                                <input type="number" id="activityDuration" placeholder="例如: 60" required style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                <style>
                                    #activityDuration::placeholder { color: rgba(255,255,255,0.7); }
                                </style>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="activity_intensity">活動強度</label>
                                <select id="activityIntensity" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                    <option value="low" style="color: black;">低強度 - 輕鬆活動</option>
                                    <option value="medium" style="color: black;">中強度 - 適度運動</option>
                                    <option value="high" style="color: black;">高強度 - 劇烈運動</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button type="button" onclick="submitManualActivity()" data-lang="record_activity" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    記錄活動
                                </button>
                                <button type="button" onclick="closeModal(this)" data-lang="cancel" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 提交手動活動記錄
        function submitManualActivity() {
            const activityType = document.getElementById('activityType').value;
            const duration = parseFloat(document.getElementById('activityDuration').value);
            const intensity = document.getElementById('activityIntensity').value;
            
            if (!duration) {
                alert('請填寫活動時長');
                return;
            }
            
            // 計算活動碳足跡（基於活動類型和強度）
            let carbonFootprint = 0;
            const baseRate = {
                'running': 0.02,
                'gym': 0.015,
                'swimming': 0.012,
                'hiking': 0.018,
                'basketball': 0.025,
                'football': 0.028,
                'tennis': 0.022,
                'yoga': 0.008,
                'dancing': 0.015,
                'other': 0.015
            };
            
            const intensityMultiplier = {
                'low': 0.8,
                'medium': 1.0,
                'high': 1.3
            };
            
            carbonFootprint = (baseRate[activityType] || 0.015) * duration * intensityMultiplier[intensity];
            
            // 記錄到發票數據中
            const activityNames = {
                'running': '跑步',
                'gym': '健身房運動',
                'swimming': '游泳',
                'hiking': '登山健行',
                'basketball': '籃球',
                'football': '足球',
                'tennis': '網球',
                'yoga': '瑜伽',
                'dancing': '舞蹈',
                'other': '其他運動'
            };
            
            const invoice = {
                id: Date.now(),
                storeName: activityNames[activityType] || '運動活動',
                amount: duration,
                carbonFootprint: carbonFootprint,
                category: 'activity',
                date: new Date().toISOString(),
                type: 'manual_activity',
                activityType: activityType,
                intensity: intensity
            };
            
            // 保存到本地存儲
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // 更新顯示
            updateRealTimeDisplay();
            closeModal(document.querySelector('.modal'));
            
            alert(`活動記錄已保存！\n${activityNames[activityType]} ${duration}分鐘\n碳足跡：${carbonFootprint.toFixed(3)} kg CO₂`);
        }
        
        // 掃描發票
        async function scanInvoice() {
            try {
                // 檢查瀏覽器是否支持相機
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('您的瀏覽器不支持相機功能，請使用Chrome或Safari');
                    return;
                }

                // 創建相機模態框
                const cameraModal = document.createElement('div');
                cameraModal.className = 'modal';
                cameraModal.style.display = 'block';
                cameraModal.innerHTML = `
                    <div class="modal-content" style="max-width: 90%; height: 85vh;">
                        <div class="modal-header">
                            <h3>📷 連續掃描發票</h3>
                            <button class="close-btn" onclick="closeCamera()">&times;</button>
                        </div>
                        <div style="background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 8px; text-align: center;">
                            <div style="color: #4CAF50; font-weight: bold;">💡 連續掃描模式</div>
                            <div style="font-size: 14px; color: #666;">可以連續掃描多張發票，每張都會自動累計碳足跡</div>
                        </div>
                        <div style="text-align: center; margin: 20px 0;">
                            <video id="cameraVideo" autoplay style="width: 100%; max-width: 400px; border-radius: 8px; border: 2px solid #4CAF50;"></video>
                            <canvas id="cameraCanvas" style="display: none;"></canvas>
                        </div>
                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn" onclick="capturePhoto()" style="background: #4CAF50; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                                📷 掃描發票
                            </button>
                        </div>
                        <div style="text-align: center; margin: 10px 0;">
                            <button class="btn" onclick="closeCamera()" style="background: #6c757d; color: white; padding: 10px 20px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer;">
                                ✅ 完成掃描
                            </button>
                        </div>
                        <div id="scanResult" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>掃描結果：</h4>
                            <div id="scanText"></div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 8px; font-size: 14px;">
                            <div style="font-weight: bold; margin-bottom: 10px;">📋 掃描流程：</div>
                            <div>• 將發票對準相機畫面</div>
                            <div>• 點擊「📷 掃描發票」進行識別</div>
                            <div>• 系統自動偵測發票內容</div>
                            <div>• 自動計算碳足跡並顯示結果</div>
                            <div>• 自動累計到當日碳足跡記錄</div>
                            <div>• 可連續掃描多張發票</div>
                            <div>• 完成後點擊「✅ 完成掃描」關閉相機</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(cameraModal);

                // 開啟相機
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // 使用後置相機
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                
                // 儲存stream以便後續關閉
                window.cameraStream = stream;
                
            } catch (error) {
                alert('無法開啟相機：' + error.message + '\n\n請確保：\n1. 允許瀏覽器使用相機\n2. 使用HTTPS或localhost\n3. 使用Chrome或Safari瀏覽器');
            }
        }
        
        // 掃描發票（連續掃描模式）
        async function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            // 設置canvas尺寸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // 繪製視頻幀到canvas
            ctx.drawImage(video, 0, 0);
            
            // 獲取圖片數據
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // 顯示掃描中指示器
            showScanningIndicator();
            
            try {
                // 模擬OCR識別發票內容
                const invoiceData = await analyzeInvoice(imageData);
                
                // 移除掃描中指示器
                hideScanningIndicator();
                
                // 計算碳足跡
                const carbonFootprint = calculateInvoiceCarbonFootprint(invoiceData);
                
                // 自動填入表單
                fillInvoiceForm(invoiceData, carbonFootprint);
                
                // 自動記錄到當日碳足跡記錄
                await recordInvoiceToDaily(invoiceData, carbonFootprint);
                
                // 顯示累計成功通知
                showAccumulationNotification(invoiceData, carbonFootprint);
                
            } catch (error) {
                // 移除掃描中指示器
                hideScanningIndicator();
                
                // 如果自動識別失敗，顯示手動輸入選項
                showManualInputOption(imageData);
            }
        }
        
        // 顯示掃描中指示器
        function showScanningIndicator() {
            // 移除現有的指示器
            hideScanningIndicator();
            
            const indicator = document.createElement('div');
            indicator.id = 'scanningIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                z-index: 10000;
                font-size: 16px;
            `;
            indicator.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
                <div>🔍 正在分析發票...</div>
                <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">請保持相機穩定</div>
            `;
            document.body.appendChild(indicator);
        }
        
        // 隱藏掃描中指示器
        function hideScanningIndicator() {
            const indicator = document.getElementById('scanningIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // 顯示掃描結果和碳足跡
        function showScanResult(invoiceData, carbonFootprint) {
            const resultModal = document.createElement('div');
            resultModal.id = 'scanResultModal';
            resultModal.className = 'modal';
            resultModal.style.display = 'block';
            resultModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>📷 掃描結果</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #4CAF50; margin-bottom: 10px;">📋 發票信息</h4>
                            <div style="margin-bottom: 8px;">
                                <strong>商店：</strong>${invoiceData.storeName}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>金額：</strong>NT$ ${invoiceData.amount.toFixed(2)}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>商品：</strong>${invoiceData.items.join(', ')}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>識別信心度：</strong>${(invoiceData.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">🌱 碳足跡計算</h4>
                            <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                                ${carbonFootprint.toFixed(2)} kg CO₂
                            </div>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; text-align: center; font-size: 14px; color: #1976d2;">
                            💡 已自動累計到今日碳足跡記錄
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn" onclick="this.closest('.modal').remove()">繼續掃描</button>
                    </div>
                </div>
            `;
            document.body.appendChild(resultModal);
            
            // 5秒後自動關閉
            setTimeout(() => {
                if (resultModal.parentNode) {
                    resultModal.remove();
                }
            }, 5000);
        }
        
        // 顯示累計成功通知
        function showAccumulationNotification(invoiceData, carbonFootprint) {
            const notification = document.createElement('div');
            notification.id = 'accumulationNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 20px;">✅</div>
                    <div>
                        <div style="font-weight: bold;">掃描成功！</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                            ${invoiceData.storeName}
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            NT$ ${invoiceData.amount.toFixed(2)} → ${carbonFootprint.toFixed(2)} kg CO₂
                        </div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                            已累計到今日記錄
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // 4秒後自動移除
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }
        
        // 自動填入發票表單
        function fillInvoiceForm(invoiceData, carbonFootprint) {
            // 填入商店名稱
            const storeNameInput = document.getElementById('storeName');
            if (storeNameInput) {
                storeNameInput.value = invoiceData.storeName;
            }
            
            // 填入消費金額
            const amountInput = document.getElementById('amount');
            if (amountInput) {
                amountInput.value = invoiceData.amount.toFixed(2);
            }
            
            // 填入碳足跡
            const carbonInput = document.getElementById('carbonFootprint');
            if (carbonInput) {
                carbonInput.value = `${carbonFootprint.toFixed(2)} kg CO₂`;
            }
            
            console.log('✅ 表單已自動填入:', {
                store: invoiceData.storeName,
                amount: invoiceData.amount,
                carbon: carbonFootprint
            });
        }
        
        // 記錄發票到每日碳足跡記錄
        async function recordInvoiceToDaily(invoiceData, carbonFootprint) {
            try {
                // 創建發票記錄
                const invoice = {
                    id: 'inv_' + Date.now(),
                    storeName: invoiceData.storeName,
                    amount: invoiceData.amount,
                    date: new Date().toISOString(),
                    items: invoiceData.items,
                    carbonFootprint: carbonFootprint,
                    source: 'camera_scan',
                    confidence: invoiceData.confidence
                };
                
                // 保存到本地存儲
                const existingInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                existingInvoices.unshift(invoice);
                localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                
                // 更新每日碳足跡記錄
                updateDailyCarbonRecord(carbonFootprint);
                
                // 更新實時數據
                realTimeData.shopping += carbonFootprint;
                updateRealTimeDisplay();
                
                // 重新載入發票記錄
                loadRecentInvoices();
                
                console.log('✅ 發票已記錄到每日碳足跡:', {
                    store: invoiceData.storeName,
                    amount: invoiceData.amount,
                    carbon: carbonFootprint,
                    totalToday: realTimeData.shopping
                });
                
            } catch (error) {
                console.error('❌ 記錄發票到每日碳足跡失敗:', error);
                alert('❌ 發票記錄失敗，請重試');
            }
        }
        
        // 分析發票（真實OCR功能）
        async function analyzeInvoice(imageData) {
            // 實際處理時間
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 調用真實OCR API（需要後端服務）
            try {
                const response = await fetch('http://localhost:3001/api/ocr/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData: imageData })
                });
                
                if (!response.ok) {
                    throw new Error('OCR API調用失敗');
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('❌ OCR識別失敗:', error);
                throw new Error('無法識別發票內容，請手動輸入或重試');
            }
        }
        
        
        // 計算發票碳足跡
        function calculateInvoiceCarbonFootprint(invoiceData) {
            let baseCarbon = invoiceData.amount * 0.01; // 基礎碳足跡：金額的1%
            
            // 根據商店類型調整碳足跡係數
            const storeTypeMultiplier = {
                '全聯福利中心': 0.8,  // 超市，相對環保
                '家樂福': 0.8,
                '7-ELEVEN': 1.2,     // 便利商店，包裝較多
                '屈臣氏': 1.1,       // 藥妝店
                '星巴克': 1.5,       // 咖啡店，外帶包裝
                '麥當勞': 1.3,       // 速食店
                '肯德基': 1.3
            };
            
            // 根據商品類型調整
            const itemTypeMultiplier = {
                '牛奶': 1.2,         // 乳製品碳足跡較高
                '肉類': 1.5,         // 肉類碳足跡最高
                '蔬菜': 0.6,         // 蔬菜相對環保
                '水果': 0.7,
                '咖啡': 1.3,         // 咖啡種植和運輸
                '麵包': 0.9,
                '日用品': 1.0
            };
            
            // 應用商店類型係數
            for (const store in storeTypeMultiplier) {
                if (invoiceData.storeName.includes(store)) {
                    baseCarbon *= storeTypeMultiplier[store];
                    break;
                }
            }
            
            // 應用商品類型係數
            let itemMultiplier = 1.0;
            for (const item of invoiceData.items) {
                for (const type in itemTypeMultiplier) {
                    if (item.includes(type)) {
                        itemMultiplier = Math.max(itemMultiplier, itemTypeMultiplier[type]);
                    }
                }
            }
            baseCarbon *= itemMultiplier;
            
            return Math.max(baseCarbon, 0.01); // 最小0.01kg
        }
        
        // 顯示手動輸入選項（不關閉相機）
        function showManualInputOption(imageData) {
            const manualModal = document.createElement('div');
            manualModal.className = 'modal';
            manualModal.style.display = 'block';
            manualModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>📷 手動輸入發票</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <div style="color: #856404; font-size: 14px;">⚠️ 自動識別失敗，請手動輸入發票信息</div>
                        </div>
                        <div class="form-group">
                            <label>商店名稱</label>
                            <input type="text" id="manualStoreName" placeholder="例如: 全聯福利中心">
                        </div>
                        <div class="form-group">
                            <label>消費金額</label>
                            <input type="number" id="manualAmount" placeholder="例如: 150" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>商品項目（選填）</label>
                            <input type="text" id="manualItems" placeholder="例如: 牛奶, 麵包, 水果">
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn" onclick="submitManualInvoice()">確認記錄</button>
                        <button class="btn" style="background: #6c757d; margin-left: 10px;" onclick="this.closest('.modal').remove()">取消</button>
                    </div>
                </div>
            `;
            document.body.appendChild(manualModal);
        }
        
        // 提交手動輸入的發票
        async function submitManualInvoice() {
            const storeName = document.getElementById('manualStoreName').value;
            const amount = parseFloat(document.getElementById('manualAmount').value);
            const itemsText = document.getElementById('manualItems').value;
            
            if (!storeName || !amount) {
                alert('請填寫商店名稱和消費金額');
                return;
            }
            
            const items = itemsText ? itemsText.split(',').map(item => item.trim()) : [];
            
            const invoiceData = {
                storeName: storeName,
                amount: amount,
                items: items,
                confidence: 1.0 // 手動輸入，信心度100%
            };
            
            // 關閉模態框
            document.querySelector('.modal').remove();
            
            // 計算碳足跡
            const carbonFootprint = calculateInvoiceCarbonFootprint(invoiceData);
            
            // 自動填入表單
            fillInvoiceForm(invoiceData, carbonFootprint);
            
            // 記錄到每日碳足跡
            await recordInvoiceToDaily(invoiceData, carbonFootprint);
            
            // 顯示累計通知
            showAccumulationNotification(invoiceData, carbonFootprint);
        }
        
        // 更新每日碳足跡記錄
        function updateDailyCarbonRecord(carbonFootprint) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD格式
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            if (!dailyRecords[today]) {
                dailyRecords[today] = {
                    date: today,
                    totalCarbon: 0,
                    shopping: 0,
                    transport: 0,
                    activity: 0,
                    other: 0,
                    invoiceCount: 0
                };
            }
            
            // 更新今日記錄
            dailyRecords[today].totalCarbon += carbonFootprint;
            dailyRecords[today].shopping += carbonFootprint;
            dailyRecords[today].invoiceCount += 1;
            
            // 清理超過半年的數據
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const cutoffDate = sixMonthsAgo.toISOString().split('T')[0];
            
            Object.keys(dailyRecords).forEach(date => {
                if (date < cutoffDate) {
                    delete dailyRecords[date];
                }
            });
            
            // 保存更新後的記錄
            localStorage.setItem('dailyCarbonRecords', JSON.stringify(dailyRecords));
            
            // 更新每日統計顯示
            updateDailyStatsDisplay();
        }
        
        // 更新每日統計顯示
        function updateDailyStatsDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const todayRecord = dailyRecords[today];
            
            if (todayRecord) {
                // 更新實時顯示中的今日總計
                const totalTodayElement = document.getElementById('totalToday');
                if (totalTodayElement) {
                    totalTodayElement.textContent = todayRecord.totalCarbon.toFixed(2);
                }
                
                // 更新今日發票數量
                const invoiceCountElement = document.getElementById('invoiceCount');
                if (invoiceCountElement) {
                    invoiceCountElement.textContent = todayRecord.invoiceCount;
                }
            }
        }
        
        // 獲取每日碳足跡統計
        function getDailyCarbonStats(days = 7) {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const dates = Object.keys(dailyRecords).sort().slice(-days);
            
            return dates.map(date => ({
                date: date,
                totalCarbon: dailyRecords[date].totalCarbon,
                shopping: dailyRecords[date].shopping,
                transport: dailyRecords[date].transport,
                activity: dailyRecords[date].activity,
                invoiceCount: dailyRecords[date].invoiceCount
            }));
        }
        
        // 獲取月度碳足跡統計
        function getMonthlyCarbonStats() {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const monthlyStats = {};
            
            Object.values(dailyRecords).forEach(record => {
                const month = record.date.substring(0, 7); // YYYY-MM
                if (!monthlyStats[month]) {
                    monthlyStats[month] = {
                        month: month,
                        totalCarbon: 0,
                        shopping: 0,
                        transport: 0,
                        activity: 0,
                        invoiceCount: 0,
                        dayCount: 0
                    };
                }
                
                monthlyStats[month].totalCarbon += record.totalCarbon;
                monthlyStats[month].shopping += record.shopping;
                monthlyStats[month].transport += record.transport;
                monthlyStats[month].activity += record.activity;
                monthlyStats[month].invoiceCount += record.invoiceCount;
                monthlyStats[month].dayCount += 1;
            });
            
            return Object.values(monthlyStats).sort((a, b) => a.month.localeCompare(b.month));
        }
        
        // 設置每日24:00自動記錄
        function setupDailyAutoRecord() {
            // 計算到今晚24:00的毫秒數
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0); // 設置到今晚24:00
            
            const timeUntilMidnight = midnight.getTime() - now.getTime();
            
            console.log('⏰ 設置每日自動記錄，距離下次記錄還有:', Math.round(timeUntilMidnight / 1000 / 60), '分鐘');
            
            // 設置定時器到今晚24:00
            setTimeout(() => {
                performDailyAutoRecord();
                
                // 設置每日重複的定時器（每24小時執行一次）
                setInterval(performDailyAutoRecord, 24 * 60 * 60 * 1000);
                
            }, timeUntilMidnight);
        }
        
        // 執行每日自動記錄
        function performDailyAutoRecord() {
            console.log('🕛 執行每日24:00自動記錄...');
            
            const today = new Date().toISOString().split('T')[0];
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            // 確保今日記錄存在
            if (!dailyRecords[today]) {
                dailyRecords[today] = {
                    date: today,
                    totalCarbon: 0,
                    shopping: 0,
                    transport: 0,
                    activity: 0,
                    other: 0,
                    invoiceCount: 0
                };
            }
            
            // 從實時數據中獲取今日累計的碳足跡
            const todayRecord = dailyRecords[today];
            
            // 更新今日記錄（如果實時數據有更新）
            todayRecord.totalCarbon = realTimeData.shopping + realTimeData.transport + realTimeData.activity + realTimeData.sensor + realTimeData.location;
            todayRecord.shopping = realTimeData.shopping;
            todayRecord.transport = realTimeData.transport;
            todayRecord.activity = realTimeData.activity;
            todayRecord.other = realTimeData.sensor + realTimeData.location;
            
            // 計算今日發票數量
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const todayInvoices = invoices.filter(inv => 
                new Date(inv.date).toISOString().split('T')[0] === today
            );
            todayRecord.invoiceCount = todayInvoices.length;
            
            // 保存更新後的記錄
            dailyRecords[today] = todayRecord;
            localStorage.setItem('dailyCarbonRecords', JSON.stringify(dailyRecords));
            
            // 清理超過半年的數據
            cleanupOldRecords();
            
            // 顯示每日記錄完成通知
            showDailyRecordNotification(todayRecord);
            
            // 重置實時數據（為新的一天做準備）
            resetRealTimeDataForNewDay();
            
            console.log('✅ 每日自動記錄完成:', todayRecord);
        }
        
        // 清理超過半年的數據
        function cleanupOldRecords() {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const cutoffDate = sixMonthsAgo.toISOString().split('T')[0];
            
            let deletedCount = 0;
            Object.keys(dailyRecords).forEach(date => {
                if (date < cutoffDate) {
                    delete dailyRecords[date];
                    deletedCount++;
                }
            });
            
            if (deletedCount > 0) {
                localStorage.setItem('dailyCarbonRecords', JSON.stringify(dailyRecords));
                console.log(`🗑️ 清理了 ${deletedCount} 天的舊數據（超過6個月）`);
            }
        }
        
        // 顯示每日記錄完成通知
        function showDailyRecordNotification(todayRecord) {
            // 創建通知模態框
            const notificationModal = document.createElement('div');
            notificationModal.className = 'modal';
            notificationModal.style.display = 'block';
            notificationModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>🕛 每日記錄完成</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">📊</div>
                            <h4 style="color: #4CAF50; margin: 0;" data-lang="daily_stats_title">今日碳足跡統計</h4>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_shopping">🛒 購物消費:</span>
                                <strong>${todayRecord.shopping.toFixed(2)} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_transport">🚗 交通移動:</span>
                                <strong>${todayRecord.transport.toFixed(2)} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_activity">🏃 活動感應:</span>
                                <strong>${todayRecord.activity.toFixed(2)} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_other">📱 其他來源:</span>
                                <strong>${todayRecord.other.toFixed(2)} kg</strong>
                            </div>
                            <hr style="margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #4CAF50;">
                                <span data-lang="daily_invoice_count">📋 發票數量:</span>
                                <strong>${todayRecord.invoiceCount} 張</strong>
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">🌱 今日總碳足跡</h4>
                            <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                                ${todayRecord.totalCarbon.toFixed(2)} kg CO₂
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                            💡 數據已自動保存，新的一天開始了！
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn" onclick="this.closest('.modal').remove()">確定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notificationModal);
            
            // 5秒後自動關閉通知
            setTimeout(() => {
                if (notificationModal.parentNode) {
                    notificationModal.remove();
                }
            }, 5000);
        }
        
        // 重置實時數據為新的一天做準備
        function resetRealTimeDataForNewDay() {
            // 重置實時數據
            realTimeData = {
                shopping: 0,
                transport: 0,
                activity: 0,
                sensor: 0,
                location: 0
            };
            
            // 更新顯示
            updateRealTimeDisplay();
            
            console.log('🔄 實時數據已重置，準備新的一天');
        }
        
        // 模擬OCR識別（保留舊函數以防其他地方使用）
        function simulateOCR() {
            const stores = ['全聯福利中心', '7-ELEVEN', '家樂福', 'Costco', '大潤發'];
            const amounts = [85.5, 120.0, 250.0, 180.0, 95.0];
            
            const randomStore = stores[Math.floor(Math.random() * stores.length)];
            const randomAmount = amounts[Math.floor(Math.random() * amounts.length)];
            
            return `
                <p><strong>商店：</strong>${randomStore}</p>
                <p><strong>金額：</strong>NT$ ${randomAmount}</p>
                <p><strong>日期：</strong>${new Date().toLocaleDateString()}</p>
                <p><strong>狀態：</strong>✅ 識別成功</p>
                <button class="btn" onclick="useScanResult('${randomStore}', ${randomAmount})" style="margin-top: 10px;">
                    使用此結果
                </button>
            `;
        }
        
        // 使用掃描結果
        function useScanResult(storeName, amount) {
            document.getElementById('storeName').value = storeName;
            document.getElementById('amount').value = amount;
            closeCamera();
            alert('✅ 發票信息已自動填入！');
        }
        
        // 關閉相機
        function closeCamera() {
            if (window.cameraStream) {
                window.cameraStream.getTracks().forEach(track => track.stop());
                window.cameraStream = null;
            }
            // 使用統一的關閉邏輯
            const cameraModal = document.querySelector('.modal:last-child');
            if (cameraModal) {
                cameraModal.style.display = 'none';
            }
        }
        
        // 電子發票載具功能
        let carrierInfo = null;
        let autoSyncEnabled = true;
        
        // 綁定電子發票載具
        function bindCarrier() {
            const carrierModal = document.createElement('div');
            carrierModal.className = 'modal';
            carrierModal.style.display = 'block';
            carrierModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>🔗 綁定電子發票載具</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 8px; text-align: center;">
                        <div style="color: #4CAF50; font-weight: bold;">💡 綁定後自動偵測</div>
                        <div style="font-size: 14px; color: #666;">綁定後在便利店消費時會自動偵測發票內容並計算碳足跡</div>
                    </div>
                    <div class="form-group">
                        <label>載具類型</label>
                        <select id="carrierType">
                            <option value="mobile">手機條碼</option>
                            <option value="citizen">自然人憑證</option>
                            <option value="love">愛心碼</option>
                            <option value="company">公司統編</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>載具號碼/條碼</label>
                        <input type="text" id="carrierCode" placeholder="請輸入載具號碼或條碼">
                    </div>
                    <div class="form-group">
                        <label>載具名稱（可選）</label>
                        <input type="text" id="carrierName" placeholder="例如: 我的手機條碼">
                    </div>
                    <button class="btn" onclick="saveCarrier()" style="background: #4CAF50;">
                        💾 保存載具
                    </button>
                    <button class="btn" onclick="scanCarrierQR()" style="background: #FF9800; margin-top: 10px;">
                        📷 掃描載具條碼
                    </button>
                </div>
            `;
            document.body.appendChild(carrierModal);
        }
        
        // 掃描載具條碼
        function scanCarrierQR() {
            alert('📷 載具條碼掃描功能\n\n在完整版本中，這裡會開啟相機掃描電子發票載具條碼\n\n模擬掃描結果：\n載具類型：手機條碼\n載具號碼：/ABC1234');
            
            // 模擬掃描結果
            document.getElementById('carrierType').value = 'mobile';
            document.getElementById('carrierCode').value = '/ABC1234';
            document.getElementById('carrierName').value = '我的手機條碼';
        }
        
        // 保存載具
        function saveCarrier() {
            const type = document.getElementById('carrierType').value;
            const code = document.getElementById('carrierCode').value;
            const name = document.getElementById('carrierName').value;
            
            if (!code) {
                alert('請輸入載具號碼');
                return;
            }
            
            carrierInfo = {
                type: type,
                code: code,
                name: name || '我的載具',
                bindTime: new Date().toISOString(),
                autoDetectEnabled: true // 啟用自動偵測
            };
            
            // 保存到本地存儲
            localStorage.setItem('carrierInfo', JSON.stringify(carrierInfo));
            
            updateCarrierStatus();
            closeCarrierModal();
            
            // 啟動自動偵測功能
            startAutoInvoiceDetection();
            
            alert('✅ 載具綁定成功！\n\n載具名稱：' + carrierInfo.name + '\n載具號碼：' + carrierInfo.code + '\n\n💡 已啟用自動偵測功能，便利店消費時會自動偵測發票內容並計算碳足跡');
        }
        
        // 啟動自動發票偵測功能
        function startAutoInvoiceDetection() {
            console.log('🚀 啟動自動發票偵測功能...');
            
            // 模擬定期檢查新發票（實際應用中會調用電子發票API）
            setInterval(async () => {
                if (carrierInfo && carrierInfo.autoDetectEnabled) {
                    await checkForNewInvoices();
                }
            }, 30000); // 每30秒檢查一次
            
            console.log('✅ 自動發票偵測已啟動，每30秒檢查一次新發票');
        }
        
        // 檢查新發票
        async function checkForNewInvoices() {
            try {
                // 調用真實API檢查新發票
                const newInvoices = await checkNewInvoices();
                
                if (newInvoices && newInvoices.length > 0) {
                    console.log('📋 發現新發票:', newInvoices.length, '張');
                    
                    for (const invoiceData of newInvoices) {
                        // 計算碳足跡
                        const carbonFootprint = calculateInvoiceCarbonFootprint(invoiceData);
                        
                        // 自動填入表單
                        fillInvoiceForm(invoiceData, carbonFootprint);
                        
                        // 記錄到每日碳足跡
                        await recordInvoiceToDaily(invoiceData, carbonFootprint);
                        
                        // 顯示自動偵測通知
                        showAutoDetectionNotification(invoiceData, carbonFootprint);
                    }
                }
            } catch (error) {
                console.error('❌ 檢查新發票失敗:', error);
            }
        }
        
        // 檢查新發票（真實API調用）
        async function checkNewInvoices() {
            // 調用真實電子發票API
            try {
                const response = await fetch('http://localhost:3001/api/invoice/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        carrierCode: carrierInfo.code,
                        lastCheckTime: carrierInfo.lastCheckTime || new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error('發票API調用失敗');
                }
                
                const result = await response.json();
                
                // 更新最後檢查時間
                if (carrierInfo && result.invoices && result.invoices.length > 0) {
                    carrierInfo.lastCheckTime = new Date().toISOString();
                    localStorage.setItem('carrierInfo', JSON.stringify(carrierInfo));
                }
                
                return result.invoices || [];
            } catch (error) {
                console.error('❌ 檢查新發票失敗:', error);
                return [];
            }
        }
        
        // 顯示自動偵測通知
        function showAutoDetectionNotification(invoiceData, carbonFootprint) {
            const notification = document.createElement('div');
            notification.id = 'autoDetectionNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: #2196F3;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 20px;">🤖</div>
                    <div>
                        <div style="font-weight: bold;">自動偵測到發票！</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                            ${invoiceData.storeName}
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            NT$ ${invoiceData.amount.toFixed(2)} → ${carbonFootprint.toFixed(2)} kg CO₂
                        </div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                            已自動累計到今日記錄
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // 5秒後自動移除
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // 關閉載具模態框
        
        // 更新載具狀態
        function updateCarrierStatus() {
            const carrierInfoElement = document.getElementById('carrierInfo');
            const syncStatusElement = document.getElementById('syncStatus');
            
            if (carrierInfo) {
                const autoDetectStatus = carrierInfo.autoDetectEnabled ? ' | 🤖 自動偵測已啟用' : '';
                carrierInfoElement.innerHTML = `
                    ✅ 已綁定：${carrierInfo.name}<br>
                    <small>類型：${getCarrierTypeName(carrierInfo.type)} | 號碼：${carrierInfo.code}${autoDetectStatus}</small>
                `;
                syncStatusElement.textContent = autoSyncEnabled ? t('sync_enabled') : t('sync_disabled');
            } else {
                carrierInfoElement.textContent = t('carrier_not_bound');
                syncStatusElement.textContent = t('sync_disabled');
            }
        }
        
        // 獲取載具類型名稱
        function getCarrierTypeName(type) {
            const types = {
                'mobile': '手機條碼',
                'citizen': '自然人憑證',
                'love': '愛心碼',
                'company': '公司統編'
            };
            return types[type] || type;
        }
        
        // 同步載具發票
        async function checkCarrierInvoices() {
            if (!carrierInfo) {
                alert('請先綁定電子發票載具');
                return;
            }
            
            const syncButton = event.target;
            const originalText = syncButton.textContent;
            syncButton.textContent = '🔄 同步中...';
            syncButton.disabled = true;
            
            try {
                // 模擬API調用
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 模擬獲取到的發票數據
                const mockInvoices = [
                    {
                        id: 'inv_' + Date.now(),
                        storeName: '全聯福利中心',
                        amount: 285.0,
                        date: new Date().toISOString(),
                        items: ['牛奶', '麵包', '水果'],
                        carbonFootprint: 2.85
                    },
                    {
                        id: 'inv_' + (Date.now() + 1),
                        storeName: '7-ELEVEN',
                        amount: 120.0,
                        date: new Date(Date.now() - 86400000).toISOString(),
                        items: ['咖啡', '三明治'],
                        carbonFootprint: 1.20
                    }
                ];
                
                // 保存發票到本地
                const existingInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const newInvoices = mockInvoices.filter(inv => 
                    !existingInvoices.some(existing => existing.id === inv.id)
                );
                
                if (newInvoices.length > 0) {
                    existingInvoices.unshift(...newInvoices);
                    localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                    
                    // 更新實時數據
                    const totalCarbon = newInvoices.reduce((sum, inv) => sum + inv.carbonFootprint, 0);
                    realTimeData.shopping += totalCarbon;
                    updateRealTimeDisplay();
                    
                    alert(`✅ 同步完成！\n\n新增 ${newInvoices.length} 張發票\n總金額：NT$ ${newInvoices.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2)}\n新增碳足跡：${totalCarbon.toFixed(2)} kg`);
                    
                    loadRecentInvoices();
                } else {
                    alert('📋 沒有新的發票記錄');
                }
                
            } catch (error) {
                alert('❌ 同步失敗：' + error.message);
            } finally {
                syncButton.textContent = originalText;
                syncButton.disabled = false;
            }
        }
        
        // 載入最近發票記錄
        function loadRecentInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const recentInvoicesElement = document.getElementById('recentInvoices');
            
            if (invoices.length === 0) {
                recentInvoicesElement.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        📋 暫無發票記錄<br>
                        <small>綁定載具或手動掃描發票開始記錄</small>
                    </div>
                `;
                return;
            }
            
            const recentInvoices = invoices.slice(0, 5); // 顯示最近5筆
            recentInvoicesElement.innerHTML = recentInvoices.map(invoice => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${invoice.storeName}</strong><br>
                        <small>NT$ ${invoice.amount.toFixed(2)} | ${new Date(invoice.date).toLocaleDateString()}</small>
                    </div>
                    <div style="text-align: right; color: #4CAF50; font-weight: bold;">
                        ${invoice.carbonFootprint.toFixed(2)} kg
                    </div>
                </div>
            `).join('');
        }
        
        // 自動同步載具發票
        function startAutoSync() {
            if (autoSyncEnabled && carrierInfo) {
                // 每5分鐘檢查一次新發票
                setInterval(async () => {
                    try {
                        await checkCarrierInvoices();
                    } catch (error) {
                        console.log('自動同步失敗：', error);
                    }
                }, 300000); // 5分鐘
            }
        }
        
        // 提交發票
        async function submitInvoice() {
            const storeName = document.getElementById('storeName').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (!storeName || !amount) {
                alert('請填寫完整信息');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/invoice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ storeName, totalAmount: amount, items: [] })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 計算碳足跡
                    const carbonFootprint = amount * 0.01;
                    
                    // 保存到本地存儲
                    const invoice = {
                        id: 'inv_' + Date.now(),
                        storeName: storeName,
                        amount: amount,
                        date: new Date().toISOString(),
                        items: [],
                        carbonFootprint: carbonFootprint,
                        source: 'manual' // 手動輸入
                    };
                    
                    const existingInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                    existingInvoices.unshift(invoice);
                    localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                    
                    // 更新每日碳足跡記錄
                    updateDailyCarbonRecord(carbonFootprint);
                    
                    // 更新實時數據
                    realTimeData.shopping += carbonFootprint;
                    updateRealTimeDisplay();
                    
                    alert('✅ 發票記錄已保存！\n\n商店：' + storeName + '\n金額：NT$ ' + amount.toFixed(2) + '\n碳足跡：' + carbonFootprint.toFixed(2) + ' kg');
                    
                    // 清空表單
                    document.getElementById('storeName').value = '';
                    document.getElementById('amount').value = '';
                    
                    closeModal('invoiceModal');
                    loadRecentInvoices();
                } else {
                    alert('保存失敗：' + result.error);
                }
            } catch (error) {
                alert('網絡錯誤：' + error.message);
            }
        }
        
        // 更新個人化目標
        function updatePersonalizedGoal() {
            const ageGroup = document.getElementById('ageGroup').value;
            const residenceType = document.getElementById('residenceType').value;
            
            userProfile.ageGroup = ageGroup;
            userProfile.residenceType = residenceType;
            
            const personalizedGoal = calculatePersonalizedGoal();
            
            // 更新顯示
            document.getElementById('personalizedGoalDisplay').textContent = `${personalizedGoal.toFixed(1)} 公斤 CO₂/天`;
            
            // 更新每日目標輸入框
            document.getElementById('dailyGoal').value = personalizedGoal.toFixed(1);
            
            // 保存到localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // 更新實時顯示
            updateRealTimeDisplay();
        }
        
        // 從輸入框更新目標
        function updateGoalFromInput() {
            const manualGoal = parseFloat(document.getElementById('dailyGoal').value);
            userProfile.personalizedGoal = manualGoal;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateRealTimeDisplay();
        }
        
        // 簡化的個人化目標設置（主界面直接調用）
        function showPersonalizedGoalSetup() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 25px;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">🎯</div>
                            <h3 style="margin: 0 0 10px 0; color: #333; font-size: 20px;">設定個人化目標</h3>
                            <div style="font-size: 14px; color: #666;">根據您的年齡和居住地，為您計算最適合的碳足跡目標</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">年齡層</label>
                            <select id="quickAgeGroup" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="">請選擇年齡層</option>
                                <option value="18-25">18-25歲</option>
                                <option value="26-35">26-35歲</option>
                                <option value="36-50">36-50歲</option>
                                <option value="51-65">51-65歲</option>
                                <option value="65+">65歲以上</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">居住區域</label>
                            <select id="quickResidenceType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="">請選擇居住區域</option>
                                <option value="urban">都市</option>
                                <option value="suburban">郊區</option>
                                <option value="rural">鄉村</option>
                            </select>
                        </div>
                        
                        <div id="goalPreview" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #2e7d32; margin-bottom: 5px;">您的個人化目標</div>
                            <div id="previewGoal" style="font-size: 24px; font-weight: bold; color: #1b5e20;"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">基於您的年齡層和居住區域計算</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-direction: column;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="closeModal(this)" style="
                                    flex: 1;
                                    background: #f5f5f5;
                                    color: #666;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                ">取消</button>
                                <button onclick="applyPersonalizedGoal()" style="
                                    flex: 1;
                                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">確認設定</button>
                            </div>
                            <button onclick="closeModal(this); showAdvancedSettings()" style="
                                width: 100%;
                                background: transparent;
                                color: #666;
                                border: 1px solid #ddd;
                                padding: 8px;
                                border-radius: 6px;
                                font-size: 14px;
                                cursor: pointer;
                                margin-top: 5px;
                            ">⚙️ 更多設定選項</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 添加即時預覽功能
            document.getElementById('quickAgeGroup').addEventListener('change', updateGoalPreview);
            document.getElementById('quickResidenceType').addEventListener('change', updateGoalPreview);
            
            // 如果有已保存的設置，自動填入
            if (userProfile.ageGroup) {
                document.getElementById('quickAgeGroup').value = userProfile.ageGroup;
            }
            if (userProfile.residenceType) {
                document.getElementById('quickResidenceType').value = userProfile.residenceType;
            }
            
            updateGoalPreview();
        }
        
        // 更新目標預覽
        function updateGoalPreview() {
            const ageGroup = document.getElementById('quickAgeGroup').value;
            const residenceType = document.getElementById('quickResidenceType').value;
            
            if (ageGroup && residenceType) {
                const ageFactor = carbonFactors.ageGroups[ageGroup] || 1.0;
                const residenceFactor = carbonFactors.residenceTypes[residenceType] || 1.0;
                const personalizedGoal = 20.0 * ageFactor * residenceFactor;
                
                document.getElementById('previewGoal').textContent = `${personalizedGoal.toFixed(1)} 公斤 CO₂/天`;
                document.getElementById('goalPreview').style.display = 'block';
            } else {
                document.getElementById('goalPreview').style.display = 'none';
            }
        }
        
        // 應用個人化目標
        function applyPersonalizedGoal() {
            const ageGroup = document.getElementById('quickAgeGroup').value;
            const residenceType = document.getElementById('quickResidenceType').value;
            
            if (!ageGroup || !residenceType) {
                alert('請選擇年齡層和居住區域');
                return;
            }
            
            userProfile.ageGroup = ageGroup;
            userProfile.residenceType = residenceType;
            
            const personalizedGoal = calculatePersonalizedGoal();
            
            // 保存到localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // 更新主界面顯示
            updateRealTimeDisplay();
            
            // 關閉模態框
            closeModal(document.querySelector('.modal'));
            
            // 顯示成功提示
            alert(`✅ 個人化目標設置成功！\n\n年齡層: ${ageGroup.replace('-', '-')}歲\n居住區域: ${getResidenceTypeText()}\n個人化目標: ${personalizedGoal.toFixed(1)} kg/天\n\n主界面目標已更新！`);
        }
        
        // 首次使用引導
        function showFirstTimeGuide() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 25px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">👋</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;">歡迎使用減碳日記！</h3>
                            <div style="font-size: 14px; opacity: 0.9;">讓我們為您設定個人化的碳足跡目標</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; margin-bottom: 8px;">💡 為什麼需要個人化目標？</div>
                            <div style="font-size: 12px; opacity: 0.9; line-height: 1.4;">
                                不同年齡和居住地的人，碳足跡差異很大。<br>
                                年輕人通勤多，都市人消費頻繁，<br>
                                個人化目標更貼近您的實際情況！
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeModal(this); skipPersonalizedSetup()" style="
                                flex: 1;
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: 2px solid white;
                                padding: 12px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                            ">稍後設定</button>
                            <button onclick="closeModal(this); showPersonalizedGoalSetup()" style="
                                flex: 1;
                                background: white;
                                color: #4CAF50;
                                border: none;
                                padding: 12px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                                font-weight: bold;
                            ">立即設定</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 跳過個人化設置
        function skipPersonalizedSetup() {
            // 記錄用戶選擇跳過，避免重複彈出
            localStorage.setItem('skipPersonalizedSetup', 'true');
        }
        
        // 顯示高級設定
        function showAdvancedSettings() {
            // 顯示原本的設定模態框
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        // 測試個人化目標
        function testPersonalizedGoal() {
            // 設置測試數據
            userProfile.ageGroup = '26-35';
            userProfile.residenceType = 'urban';
            
            // 計算個人化目標
            const personalizedGoal = calculatePersonalizedGoal();
            
            // 更新界面
            document.getElementById('ageGroup').value = userProfile.ageGroup;
            document.getElementById('residenceType').value = userProfile.residenceType;
            document.getElementById('dailyGoal').value = personalizedGoal.toFixed(1);
            document.getElementById('personalizedGoalDisplay').textContent = `${personalizedGoal.toFixed(1)} 公斤 CO₂/天`;
            
            // 更新實時顯示
            updateRealTimeDisplay();
            
            alert(`測試個人化目標設置成功！\n\n年齡層: 26-35歲\n居住區域: 都市\n個人化目標: ${personalizedGoal.toFixed(1)} kg/天\n\n主界面目標已更新！`);
        }
        
        // 儲存設定
        function saveSettings() {
            const dailyGoal = document.getElementById('dailyGoal').value;
            const gpsEnabled = document.getElementById('gpsEnabled').value;
            const autoTracking = document.getElementById('autoTrackingSetting').value;
            
            // 保存用戶檔案
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            alert(t('settings_saved') + '\n\n' + t('daily_goal_kg').replace(' (公斤)', '') + '：' + dailyGoal + ' kg\nGPS：' + (gpsEnabled === 'true' ? t('enabled') : t('disabled')) + '\n' + t('auto_tracking') + '：' + (autoTracking === 'true' ? t('enabled') : t('disabled')));
            closeModal('settingsModal');
        }
        
        // 顯示分析
        function showAnalytics() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // 獲取真實數據
            const analyticsData = getAnalyticsData();
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 32px; margin-bottom: 10px;">📊</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;" data-lang="analytics_feature">數據分析功能</h3>
                            <div style="font-size: 14px; opacity: 0.9;" data-lang="real_time_analytics">基於您的自動偵測數據</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="today_summary">今日摘要</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${analyticsData.todayTotal}</div>
                                    <div style="font-size: 12px; opacity: 0.8;" data-lang="today_carbon">今日碳足跡 (kg)</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${analyticsData.goalProgress}%</div>
                                    <div style="font-size: 12px; opacity: 0.8;" data-lang="goal_progress">目標進度</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="category_breakdown">分類統計</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>🛒 <span data-lang="shopping_label">購物</span>: ${analyticsData.categories.shopping} kg</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>🚗 <span data-lang="transport_label">交通</span>: ${analyticsData.categories.transport} kg</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>📱 <span data-lang="activity_label">手機使用</span>: ${analyticsData.categories.activity} kg</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>📍 <span data-lang="location_label">移動軌跡</span>: ${analyticsData.categories.location} kg</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="weekly_trends">近7天趨勢</h4>
                            <div style="display: flex; justify-content: space-between; align-items: end; height: 80px; margin: 10px 0;">
                                ${analyticsData.weeklyData.map((day, index) => 
                                    `<div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                        <div style="background: rgba(255,255,255,0.3); width: 20px; height: ${Math.max(day.value * 2, 4)}px; border-radius: 2px; margin-bottom: 5px;"></div>
                                        <div style="font-size: 10px; opacity: 0.8;">${day.day}</div>
                                        <div style="font-size: 10px; opacity: 0.6;">${day.value}</div>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">📊 個人化比較</h4>
                            <div style="font-size: 14px; line-height: 1.4;">
                                ${(() => {
                                    const feedback = generatePersonalizedFeedback();
                                    return `
                                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="font-weight: bold; margin-bottom: 8px;">📈 與同齡同區比較</div>
                                            <div style="margin-bottom: 5px;">當前: ${feedback.current} kg</div>
                                            <div style="margin-bottom: 5px;">同齡平均: ${feedback.average} kg</div>
                                            <div style="margin-bottom: 5px;">個人目標: ${feedback.goal} kg</div>
                                            <div style="color: #FFEB3B; font-weight: bold;">${feedback.comparison}</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                                            <div style="font-weight: bold; margin-bottom: 8px;">🎯 個人表現評估</div>
                                            <div style="color: #4CAF50;">${feedback.feedback}</div>
                                        </div>
                                    `;
                                })()}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="eco_suggestions">環保建議</h4>
                            <div style="font-size: 14px; line-height: 1.4;">
                                ${analyticsData.suggestions.map(suggestion => 
                                    `<div style="margin-bottom: 8px;">💡 ${suggestion}</div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeModal(this)" data-lang="confirm" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                確定
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 獲取分析數據
        function getAnalyticsData() {
            // 獲取今日數據
            const today = new Date().toDateString();
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const todayInvoices = invoices.filter(inv => new Date(inv.date).toDateString() === today);
            
            // 計算今日總碳足跡
            const todayTotal = todayInvoices.reduce((sum, inv) => sum + (parseFloat(inv.carbonFootprint) || 0), 0);
            
            // 獲取每日目標
            const dailyGoal = parseFloat(localStorage.getItem('dailyGoal') || '20');
            const goalProgress = Math.round((todayTotal / dailyGoal) * 100);
            
            // 分類統計
            const categories = {
                shopping: 0,
                transport: 0,
                activity: 0,
                location: 0
            };
            
            todayInvoices.forEach(inv => {
                const carbon = parseFloat(inv.carbonFootprint) || 0;
                if (inv.category === 'shopping') categories.shopping += carbon;
                else if (inv.category === 'transport') categories.transport += carbon;
                else if (inv.category === 'activity') categories.activity += carbon;
                else categories.location += carbon;
            });
            
            // 近7天數據
            const weeklyData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayDate = date.toDateString();
                const dayInvoices = invoices.filter(inv => new Date(inv.date).toDateString() === dayDate);
                const dayTotal = dayInvoices.reduce((sum, inv) => sum + (parseFloat(inv.carbonFootprint) || 0), 0);
                
                weeklyData.push({
                    day: `${date.getMonth() + 1}/${date.getDate()}`,
                    value: dayTotal.toFixed(1)
                });
            }
            
            // 環保建議 - 基於真實數據的智能分析
            const suggestions = [];
            
            // 分析今日數據
            const totalCategories = categories.shopping + categories.transport + categories.activity + categories.location;
            const shoppingPercentage = totalCategories > 0 ? (categories.shopping / totalCategories) * 100 : 0;
            const transportPercentage = totalCategories > 0 ? (categories.transport / totalCategories) * 100 : 0;
            const activityPercentage = totalCategories > 0 ? (categories.activity / totalCategories) * 100 : 0;
            
            // 分析近7天趨勢
            const weeklyTotals = weeklyData.map(day => parseFloat(day.value));
            const avgWeekly = weeklyTotals.reduce((sum, val) => sum + val, 0) / 7;
            const maxDay = Math.max(...weeklyTotals);
            const minDay = Math.min(...weeklyTotals);
            
            // 基於目標達成情況的建議
            if (todayTotal > dailyGoal * 1.2) {
                suggestions.push(`今日碳足跡 ${todayTotal}kg 超出目標 ${dailyGoal}kg 達 ${goalProgress}%，建議減少非必要消費`);
            } else if (todayTotal > dailyGoal) {
                suggestions.push(`今日碳足跡 ${todayTotal}kg 略超目標，建議控制消費頻率`);
            } else if (todayTotal === 0) {
                suggestions.push('今日尚未記錄碳足跡，建議開始記錄您的消費行為');
            } else if (goalProgress < 50) {
                suggestions.push(`今日碳足跡 ${todayTotal}kg，進度良好！建議保持當前消費模式`);
            }
            
            // 基於分類統計的建議
            if (shoppingPercentage > 60) {
                suggestions.push(`購物碳足跡佔 ${shoppingPercentage.toFixed(1)}%，建議減少衝動消費，優先購買必需品`);
            } else if (shoppingPercentage > 40) {
                suggestions.push(`購物碳足跡佔 ${shoppingPercentage.toFixed(1)}%，建議選擇環保包裝商品`);
            }
            
            if (transportPercentage > 50) {
                suggestions.push(`交通碳足跡佔 ${transportPercentage.toFixed(1)}%，建議多使用大眾運輸或步行`);
            } else if (transportPercentage > 30) {
                suggestions.push(`交通碳足跡佔 ${transportPercentage.toFixed(1)}%，建議規劃更環保的出行路線`);
            }
            
            // 基於週趨勢的建議
            if (maxDay > avgWeekly * 1.5) {
                const maxDayIndex = weeklyTotals.indexOf(maxDay);
                const maxDayDate = weeklyData[maxDayIndex].day;
                suggestions.push(`${maxDayDate} 碳足跡異常高達 ${maxDay}kg，建議回顧當日消費行為`);
            }
            
            if (minDay === 0 && avgWeekly > 0) {
                suggestions.push('近7天中有零碳足跡日，建議將環保習慣推廣到更多天');
            }
            
            // 基於手機使用數據的建議
            if (categories.activity > 0) {
                suggestions.push(`手機使用碳足跡 ${categories.activity}kg，建議減少不必要的螢幕使用時間`);
            }
            
            // 基於移動軌跡數據的建議
            if (categories.location > 0) {
                suggestions.push(`移動軌跡碳足跡 ${categories.location}kg，建議減少不必要的移動`);
            }
            
            // 如果沒有任何具體建議，提供基於整體表現的建議
            if (suggestions.length === 0) {
                if (avgWeekly < dailyGoal * 0.5) {
                    suggestions.push(`近7天平均碳足跡 ${avgWeekly.toFixed(1)}kg，表現優秀！繼續保持環保生活習慣`);
                } else if (avgWeekly < dailyGoal) {
                    suggestions.push(`近7天平均碳足跡 ${avgWeekly.toFixed(1)}kg，表現良好，可進一步優化消費選擇`);
                } else {
                    suggestions.push(`近7天平均碳足跡 ${avgWeekly.toFixed(1)}kg，建議制定更嚴格的環保目標`);
                }
            }
            
            // 限制建議數量，優先顯示最重要的
            if (suggestions.length > 3) {
                suggestions.splice(3);
            }
            
            return {
                todayTotal: todayTotal.toFixed(1),
                goalProgress: Math.min(goalProgress, 100),
                categories: {
                    shopping: categories.shopping.toFixed(1),
                    transport: categories.transport.toFixed(1),
                    activity: categories.activity.toFixed(1),
                    location: categories.location.toFixed(1)
                },
                weeklyData: weeklyData,
                suggestions: suggestions
            };
        }
        
        // 初始化實時數據（載入歷史數據）
        function initializeRealTimeData() {
            // 載入今日發票數據
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const today = new Date().toDateString();
            
            const todayInvoices = invoices.filter(inv => 
                new Date(inv.date).toDateString() === today
            );
            
            realTimeData.shopping = todayInvoices.reduce((sum, inv) => sum + inv.carbonFootprint, 0);
            
            // 載入移動歷史數據
            const movements = JSON.parse(localStorage.getItem('movements') || '[]');
            const todayMovements = movements.filter(mov => 
                new Date(mov.timestamp).toDateString() === today
            );
            
            realTimeData.transport = todayMovements.reduce((sum, mov) => sum + mov.carbonFootprint, 0);
            
            // 更新顯示
            updateRealTimeDisplay();
            
        // 初始化每日統計顯示
        updateDailyStatsDisplay();
        
        // 設置每日24:00自動記錄
        setupDailyAutoRecord();
        }
        
        // GPS定位和移動追蹤
        let watchId = null;
        let lastPosition = null;
        let totalDistance = 0;
        let isTracking = false;
        
        // 實時碳足跡數據
        let realTimeData = {
            transport: 0,      // 交通運輸碳足跡
            shopping: 0,       // 購物消費碳足跡
            activity: 0,       // 活動偵測碳足跡
            location: 0,       // 位置變化碳足跡
            sensor: 0,         // 感應器數據碳足跡
            total: 0           // 總碳足跡
        };
        
        // 用戶檔案數據
        let userProfile = {
            ageGroup: '', // '18-25', '26-35', '36-50', '51-65', '65+'
            residenceType: '', // 'urban', 'suburban', 'rural'
            personalizedGoal: 20.0, // 個人化目標
            baselineGoal: 20.0 // 基準目標
        };
        
        // 年齡層和居住區域的碳足跡係數
        const carbonFactors = {
            ageGroups: {
                '18-25': 1.15, // 年輕人碳足跡較高
                '26-35': 1.10,
                '36-50': 1.05,
                '51-65': 0.95,
                '65+': 0.85
            },
            residenceTypes: {
                'urban': 1.10, // 都市碳足跡較高
                'suburban': 1.00,
                'rural': 0.85 // 鄉村碳足跡較低
            }
        };
        
        // 同齡同區平均數據（模擬數據，實際應用中可從服務器獲取）
        const averageData = {
            '18-25_urban': 22.0,
            '18-25_suburban': 20.0,
            '18-25_rural': 17.0,
            '26-35_urban': 21.0,
            '26-35_suburban': 19.0,
            '26-35_rural': 16.0,
            '36-50_urban': 20.0,
            '36-50_suburban': 18.0,
            '36-50_rural': 15.5,
            '51-65_urban': 18.5,
            '51-65_suburban': 16.5,
            '51-65_rural': 14.0,
            '65+_urban': 16.5,
            '65+_suburban': 15.0,
            '65+_rural': 12.5
        };
        
        // 移動歷史記錄
        let movementHistory = [];
        let activityHistory = [];
        
        // 計算個人化目標
        function calculatePersonalizedGoal() {
            if (!userProfile.ageGroup || !userProfile.residenceType) {
                return userProfile.baselineGoal;
            }
            
            const ageFactor = carbonFactors.ageGroups[userProfile.ageGroup] || 1.0;
            const residenceFactor = carbonFactors.residenceTypes[userProfile.residenceType] || 1.0;
            
            userProfile.personalizedGoal = userProfile.baselineGoal * ageFactor * residenceFactor;
            return userProfile.personalizedGoal;
        }
        
        // 獲取同齡同區平均數據
        function getAverageCarbonFootprint() {
            if (!userProfile.ageGroup || !userProfile.residenceType) {
                return 20.0; // 默認平均值
            }
            
            const key = `${userProfile.ageGroup}_${userProfile.residenceType}`;
            return averageData[key] || 20.0;
        }
        
        // 生成個人化反饋
        function generatePersonalizedFeedback() {
            const currentTotal = realTimeData.total;
            const average = getAverageCarbonFootprint();
            const personalizedGoal = userProfile.personalizedGoal;
            
            let feedback = '';
            let comparison = '';
            
            // 與同齡同區平均比較
            if (currentTotal < average) {
                const percentage = Math.round(((average - currentTotal) / average) * 100);
                comparison = `你比${getResidenceTypeText()}同齡人低${percentage}%，很棒！`;
            } else if (currentTotal > average) {
                const percentage = Math.round(((currentTotal - average) / average) * 100);
                const suggestion = getImprovementSuggestion();
                comparison = `你高於${getResidenceTypeText()}平均${percentage}%，${suggestion}`;
            } else {
                comparison = `你的表現與${getResidenceTypeText()}同齡人相當！`;
            }
            
            // 與個人目標比較
            if (currentTotal < personalizedGoal * 0.8) {
                feedback = '表現優秀！你遠低於個人目標。';
            } else if (currentTotal < personalizedGoal) {
                feedback = '表現良好！你正在接近個人目標。';
            } else if (currentTotal < personalizedGoal * 1.2) {
                feedback = '接近目標，繼續努力！';
            } else {
                feedback = '需要調整生活方式來降低碳足跡。';
            }
            
            return {
                comparison: comparison,
                feedback: feedback,
                current: currentTotal.toFixed(2),
                average: average.toFixed(2),
                goal: personalizedGoal.toFixed(2)
            };
        }
        
        // 獲取居住區域中文描述
        function getResidenceTypeText() {
            const residenceTexts = {
                'urban': '都市',
                'suburban': '郊區',
                'rural': '鄉村'
            };
            return residenceTexts[userProfile.residenceType] || '';
        }
        
        // 獲取改善建議
        function getImprovementSuggestion() {
            const suggestions = [
                '建議減少開車里程，每天可省下2-3kg CO₂',
                '嘗試使用大眾運輸工具，可降低30%交通碳足跡',
                '選擇步行或騎自行車短途出行',
                '減少不必要的購物，選擇環保產品',
                '優化家居能源使用，節省用電'
            ];
            return suggestions[Math.floor(Math.random() * suggestions.length)];
        }
        
        // 開始GPS追蹤
        function startGPSTracking() {
            if (!navigator.geolocation) {
                console.log('瀏覽器不支援GPS定位');
                document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                document.getElementById('gpsStatus').textContent = '❌ 瀏覽器不支援GPS定位';
                return;
            }
            
            // 如果已經有GPS監聽在運行，先清除
            if (window.gpsWatchId) {
                navigator.geolocation.clearWatch(window.gpsWatchId);
                console.log('清除之前的GPS監聽');
            }
            
            console.log('開始GPS追蹤...');
            
            // 先請求一次位置來觸發權限對話框
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('✅ GPS權限已獲得，開始持續追蹤');
                    document.getElementById('locationStatusText').textContent = t('gps_success_status');
                    document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                    
                    // 開始持續追蹤
                    window.gpsWatchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            console.log('📍 GPS 更新:', pos.coords.latitude, pos.coords.longitude);
                            
                            if (lastPosition && isTracking) {
                                const distance = calculateDistance(lastPosition, pos);
                                totalDistance += distance;
                                updateMovementData(distance, pos);
                            }
                            lastPosition = pos;
                            isTracking = true;
                            
                            // 更新實時顯示
                            updateRealTimeDisplay();
                        },
                        function(error) {
                            console.log('❌ GPS 監聽失敗:', error.message);
                            document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                            document.getElementById('gpsStatus').textContent = '❌ GPS監聽失敗: ' + error.message;
                        },
                        { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                    );
                    
                    isTracking = true;
                },
                function(error) {
                    console.log('❌ GPS 權限被拒絕:', error.message);
                    document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                    document.getElementById('gpsStatus').textContent = '❌ GPS定位失敗: ' + error.message;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // 停止GPS追蹤
        function stopGPSTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            updateLocationStatus(null, 'GPS追蹤已停止');
        }
        
        // 更新位置狀態
        function updateLocationStatus(position, message) {
            const statusElement = document.getElementById('locationStatusText');
            const gpsStatusElement = document.getElementById('gpsStatus');
            
            if (position) {
                // GPS定位成功 - 真實數據
                const statusText = `📍 GPS定位成功 | 正在追蹤您的移動`;
                const gpsText = `✅ GPS定位成功 (精度: ${position.coords.accuracy.toFixed(0)}米)`;
                
                if (statusElement) statusElement.textContent = statusText;
                if (gpsStatusElement) gpsStatusElement.textContent = gpsText;
            } else if (message && message.trim() !== '') {
                // 有錯誤訊息 - 真實狀態
                let statusText = '';
                let gpsText = message;
                
                if (message.includes('✅') || message.includes('成功')) {
                    statusText = t('gps_status');
                } else if (message.includes('❌') || message.includes('失敗') || message.includes('錯誤') || message.includes('拒絕')) {
                    statusText = t('gps_failed');
                    gpsText = `❌ ${message.replace('❌ ', '')}`;
                } else if (message.includes('❓') || message.includes('檢測中')) {
                    statusText = t('gps_status_checking');
                    gpsText = `❓ ${message.replace('❓ ', '')}`;
                } else if (message.includes('🔄') || message.includes('定位中') || message.includes('啟動')) {
                    statusText = t('gps_positioning');
                    gpsText = `🔄 ${message.replace('🔄 ', '')}`;
                } else {
                    statusText = '📍 ' + message;
                    gpsText = message;
                }
                
                if (statusElement) statusElement.textContent = statusText;
                if (gpsStatusElement) gpsStatusElement.textContent = gpsText;
            } else {
                // 空白狀態 - 等待真實檢測結果
                if (statusElement) statusElement.textContent = '';
                if (gpsStatusElement) gpsStatusElement.textContent = '';
            }
        }
        
        // 計算兩點間距離（米）
        function calculateDistance(pos1, pos2) {
            const R = 6371e3; // 地球半徑（米）
            const φ1 = pos1.coords.latitude * Math.PI/180;
            const φ2 = pos2.coords.latitude * Math.PI/180;
            const Δφ = (pos2.coords.latitude - pos1.coords.latitude) * Math.PI/180;
            const Δλ = (pos2.coords.longitude - pos1.coords.longitude) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // 距離（米）
        }
        
        // 更新移動數據
        function updateMovementData(distance, position) {
            // 根據移動速度判斷交通方式
            const speed = position.coords.speed || 0; // m/s
            let transportType = 'walking';
            let carbonFactor = 0.05; // kg CO2/km
            
            if (speed > 15) {
                transportType = 'driving';
                carbonFactor = 0.192; // 汽車
            } else if (speed > 5) {
                transportType = 'cycling';
                carbonFactor = 0.021; // 自行車
            } else if (speed > 1) {
                transportType = 'walking';
                carbonFactor = 0.05; // 步行
            }
            
            // 計算碳足跡
            const distanceKm = distance / 1000;
            const carbonFootprint = distanceKm * carbonFactor;
            
            // 記錄移動歷史
            const movement = {
                timestamp: new Date().toISOString(),
                type: transportType,
                distance: distanceKm,
                speed: speed,
                carbonFootprint: carbonFootprint,
                position: {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                }
            };
            
            movementHistory.push(movement);
            
            // 更新實時數據
            realTimeData.transport += carbonFootprint;
            realTimeData.location += carbonFootprint * 0.1; // 位置變化額外碳足跡
            
            // 自動記錄移動
            if (distance > 10) { // 移動超過10米才記錄
                autoRecordMovement(transportType, distanceKm, carbonFootprint);
            }
            
            // 更新顯示
            updateRealTimeDisplay();
        }
        
        // 自動記錄移動
        async function autoRecordMovement(type, distance, carbonFootprint) {
            try {
                const response = await fetch(`${API_BASE}/api/movement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        type: type, 
                        distance: distance.toFixed(2),
                        duration: 1,
                        carbonFootprint: carbonFootprint
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('自動記錄移動：', result.data);
                    // 不調用updateStats，使用實時數據
                }
            } catch (error) {
                console.error('自動記錄失敗：', error);
            }
        }
        
        // 感應器數據收集
        function startSensorTracking() {
            console.log('開始啟用感應器...');
            
            // 检查浏览器是否支持感应器
            if (!window.DeviceMotionEvent) {
                console.log('瀏覽器不支援感應器');
                document.getElementById('sensorStatus').textContent = '❌ 瀏覽器不支援感應器';
                return;
            }
            
            // 请求感应器权限
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ 需要权限请求
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        console.log('✅ iOS 感應器權限已允許');
                        document.getElementById('sensorStatus').textContent = '✅ 感應器已啟用，持續監聽中...';
                        startMotionListening();
                    } else {
                        console.log('❌ iOS 感應器權限被拒絕');
                        document.getElementById('sensorStatus').textContent = '❌ 感應器權限被拒絕';
                    }
                }).catch(error => {
                    console.log('❌ 感應器權限請求失敗:', error);
                    document.getElementById('sensorStatus').textContent = '❌ 感應器權限請求失敗';
                });
            } else {
                // Android/桌面浏览器直接启动
                console.log('✅ Android/桌面 已啟用感應器監聽');
                document.getElementById('sensorStatus').textContent = '✅ 感應器已啟用，持續監聽中...';
                startMotionListening();
            }
        }
        
        function startMotionListening() {
            window.addEventListener('devicemotion', function(e) {
                if (e.acceleration) {
                    console.log("📱 devicemotion: 加速度X=" + e.acceleration.x);
                    handleMotion(e);
                }
            });
        }
        
        // 處理加速度計數據
        function handleMotion(event) {
            const acceleration = event.acceleration;
            const rotation = event.rotationRate;
            const sensorStatusElement = document.getElementById('sensorStatus');
            
            // 檢測移動模式
            const totalAcceleration = Math.sqrt(
                acceleration.x * acceleration.x + 
                acceleration.y * acceleration.y + 
                acceleration.z * acceleration.z
            );
            
            // 更新感應器狀態
            sensorStatusElement.innerHTML = t('sensor_normal').replace('{acceleration}', totalAcceleration.toFixed(2));
            
            // 根據加速度判斷活動類型並計算碳足跡
            let activityType = '靜止';
            let carbonFootprint = 0;
            
            if (totalAcceleration > 3) {
                activityType = '劇烈活動';
                carbonFootprint = 0.01; // 劇烈活動增加碳足跡
                sensorStatusElement.innerHTML = `🏃 劇烈活動 (加速度: ${totalAcceleration.toFixed(2)}m/s²)`;
            } else if (totalAcceleration > 2) {
                activityType = '中度活動';
                carbonFootprint = 0.005;
                sensorStatusElement.innerHTML = `🚶 中度活動 (加速度: ${totalAcceleration.toFixed(2)}m/s²)`;
            } else if (totalAcceleration > 1) {
                activityType = '輕度活動';
                carbonFootprint = 0.002;
                sensorStatusElement.innerHTML = `👤 輕度活動 (加速度: ${totalAcceleration.toFixed(2)}m/s²)`;
            }
            
            // 記錄活動歷史
            const activity = {
                timestamp: new Date().toISOString(),
                type: activityType,
                acceleration: totalAcceleration,
                carbonFootprint: carbonFootprint
            };
            
            activityHistory.push(activity);
            
            // 更新實時數據
            realTimeData.activity += carbonFootprint;
            realTimeData.sensor += carbonFootprint;
            
            // 更新顯示
            updateRealTimeDisplay();
        }
        
        // 處理陀螺儀數據
        function handleOrientation(event) {
            const alpha = event.alpha; // 繞Z軸旋轉
            const beta = event.beta;   // 繞X軸旋轉
            const gamma = event.gamma; // 繞Y軸旋轉
            
            // 可以根據旋轉數據判斷用戶行為
        }
        
        // 更新實時顯示
        function updateRealTimeDisplay() {
            // 計算總碳足跡
            realTimeData.total = realTimeData.transport + realTimeData.shopping + 
                                realTimeData.activity + realTimeData.location + realTimeData.sensor;
            
            // 更新主顯示
            document.getElementById('realTimeCarbon').textContent = realTimeData.total.toFixed(2);
            
            // 使用個人化目標
            const dailyGoal = userProfile.personalizedGoal || 20.0;
            const progress = (realTimeData.total / dailyGoal) * 100;
            document.getElementById('realTimeProgress').style.width = Math.min(progress, 100) + '%';
            const goalText = t('daily_target').replace('20.0', dailyGoal.toFixed(1)).replace('0.0%', `${progress.toFixed(1)}%`);
            document.getElementById('realTimeGoal').textContent = goalText;
            
            // 更新分解數據
            document.getElementById('transportCarbon').textContent = realTimeData.transport.toFixed(2) + ' kg';
            document.getElementById('shoppingCarbon').textContent = realTimeData.shopping.toFixed(2) + ' kg';
            document.getElementById('activityCarbon').textContent = realTimeData.activity.toFixed(2) + ' kg';
            document.getElementById('locationCarbon').textContent = realTimeData.location.toFixed(2) + ' kg';
            document.getElementById('sensorCarbon').textContent = realTimeData.sensor.toFixed(2) + ' kg';
        }
        
        // 實時數據更新
        function startRealTimeUpdates() {
            // 每5秒更新一次位置信息
            setInterval(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            updateLocationStatus(position);
                        },
                        function(error) {
                            console.log('位置更新失敗：', error);
                        },
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 10000 }
                    );
                }
            }, 5000);
            
            // 每10秒更新一次實時顯示
            setInterval(updateRealTimeDisplay, 10000);
        }
        
        // 頁面載入時更新數據
        window.onload = function() {
            console.log('頁面載入完成，初始化多語言系統');
            console.log('當前語言設定:', currentLanguage);
            // 初始化多語言系統
            updateLanguage();
            
            // 初始化載具信息
            const savedCarrierInfo = localStorage.getItem('carrierInfo');
            if (savedCarrierInfo) {
                carrierInfo = JSON.parse(savedCarrierInfo);
            }
            
            // 初始化用戶檔案（必須在initializeRealTimeData之前）
            const savedUserProfile = localStorage.getItem('userProfile');
            if (savedUserProfile) {
                userProfile = JSON.parse(savedUserProfile);
                // 更新設置界面
                if (userProfile.ageGroup) {
                    document.getElementById('ageGroup').value = userProfile.ageGroup;
                }
                if (userProfile.residenceType) {
                    document.getElementById('residenceType').value = userProfile.residenceType;
                }
                if (userProfile.personalizedGoal) {
                    document.getElementById('dailyGoal').value = userProfile.personalizedGoal.toFixed(1);
                    document.getElementById('personalizedGoalDisplay').textContent = `${userProfile.personalizedGoal.toFixed(1)} 公斤 CO₂/天`;
                }
            } else {
                // 首次使用，檢查是否已跳過引導
                const skipGuide = localStorage.getItem('skipPersonalizedSetup');
                if (!skipGuide) {
                    setTimeout(() => {
                        showFirstTimeGuide();
                    }, 2000);
                }
            }
            
            // 初始化實時數據
            initializeRealTimeData();
            
            // 初始化狀態顯示（重置為未知狀態）
            initializeStatusDisplay();
            
            updateCarrierStatus();
            loadRecentInvoices();
            
            // 如果已綁定載具，啟動自動偵測
            if (carrierInfo && carrierInfo.autoDetectEnabled) {
                startAutoInvoiceDetection();
            }
            
            // 自動啟動GPS和感應器（無需用戶交互）
            autoStartGPSAndSensor();
            
            startRealTimeUpdates();
            startAutoSync();
            
            // 改善手機體驗
            improveMobileTouch();
            optimizeScrolling();
            
            // GPS權限請求已移至 autoStartGPSAndSensor() 中處理，避免重複請求
            
            // 顯示歡迎信息
            setTimeout(() => {
                const features = [
                    '實時GPS定位追蹤',
                    '相機掃描發票',
                    '電子發票載具綁定',
                    '感應器活動監測',
                    '自動移動記錄',
                    '實時碳足跡計算'
                ];
                
                alert(`🌱 歡迎使用碳足跡追蹤器！\n\n✅ 實時偵測功能已啟用：\n${features.map(f => '• ' + f).join('\n')}\n\n📊 所有數據都是實時偵測的真實數據！\n\n請允許瀏覽器使用位置和相機權限以獲得最佳體驗！`);
            }, 2000);
        };
        
        // 點擊模態框外部關閉
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
        
        // 改善手機觸控體驗
        function improveMobileTouch() {
            // 檢測是否為iPhone Chrome
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            if (isIOS && isChrome) {
                // iPhone Chrome特殊處理
                console.log('檢測到iPhone Chrome，啟用特殊優化');
                
                // 強制啟用滾動
                document.body.style.overflow = 'auto';
                document.body.style.webkitOverflowScrolling = 'touch';
                
                // 移除可能阻礙滾動的樣式
                document.body.style.position = 'relative';
                document.body.style.height = 'auto';
                
                // 添加iPhone Chrome專用滾動修復
                document.addEventListener('touchstart', function(e) {
                    // 確保滾動容器
                    if (e.target.closest('.container')) {
                        e.target.closest('.container').style.webkitOverflowScrolling = 'touch';
                    }
                }, {passive: true});
                
            } else if (isIOS && isSafari) {
                // Safari正常處理
                console.log('檢測到Safari，使用標準優化');
            }
            
            // 通用滾動優化
            document.addEventListener('touchstart', function() {}, {passive: true});
            document.addEventListener('touchmove', function() {}, {passive: true});
            document.addEventListener('touchend', function() {}, {passive: true});
            
            // 允許模態框內部捲動
            document.addEventListener('touchmove', function(e) {
                // 只在模態框外部時防止橡皮筋效果
                if (e.target.closest('.modal-content')) {
                    // 允許模態框內容捲動
                    return;
                }
                if (e.target.closest('.modal')) {
                    e.preventDefault();
                }
            }, {passive: false});
            
            // 改善按鈕觸控反饋
            const buttons = document.querySelectorAll('.btn, .menu-item');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
                
                button.addEventListener('touchcancel', function() {
                    this.style.transform = '';
                });
            });
        }
        
        // 優化滾動性能
        function optimizeScrolling() {
            // 使用 requestAnimationFrame 優化滾動
            let ticking = false;
            
            function updateScroll() {
                // 滾動時的優化處理
                ticking = false;
            }
            
            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateScroll);
                    ticking = true;
                }
            }
            
            window.addEventListener('scroll', requestTick, {passive: true});
        }
        
        
        
        
        
        function getIOSLocationTroubleshooting(isIOS) {
            if (isIOS) {
                return `
                <div style="text-align: left; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">📱 iPhone GPS故障排除：</h4>
                    <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>檢查系統設定</strong>：設定 → 隱私權與安全性 → 定位服務</li>
                        <li><strong>確保定位服務已開啟</strong></li>
                        <li><strong>檢查瀏覽器權限</strong>：找到Safari或Chrome → 選擇「使用App期間」</li>
                        <li><strong>嘗試重新啟動瀏覽器</strong></li>
                        <li><strong>檢查網路連線</strong>：GPS需要網路輔助定位</li>
                        <li><strong>嘗試到戶外開闊地帶</strong>：室內可能影響GPS信號</li>
                    </ol>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #1976d2; margin: 0; font-weight: bold;">💡 如果問題持續：</p>
                        <ul style="color: #1976d2; margin: 5px 0 0 0; padding-left: 20px;">
                            <li>嘗試使用Safari瀏覽器</li>
                            <li>重新啟動iPhone</li>
                            <li>更新iOS系統</li>
                        </ul>
                    </div>
                </div>
                `;
            }
            return '';
        }
        
        function getTimeoutInstructions(isIOS) {
            if (isIOS) {
                return `
                <div style="text-align: left; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">⏱️ GPS定位超時解決方案：</h4>
                    <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>檢查網路連線</strong>：確保WiFi或行動數據正常</li>
                        <li><strong>到戶外開闊地帶</strong>：遠離建築物和遮蔽物</li>
                        <li><strong>等待更長時間</strong>：首次定位可能需要30秒-2分鐘</li>
                        <li><strong>重新整理頁面</strong>後重試</li>
                        <li><strong>嘗試使用Safari</strong>：Safari的GPS支援更穩定</li>
                    </ol>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #2e7d32; margin: 0; font-weight: bold;">🔄 重新嘗試：</p>
                        <button onclick="checkPermissions()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 5px;">
                            再次檢查權限
                        </button>
                    </div>
                </div>
                `;
            }
            return '';
        }
        
        function showPermissionResult(message, type, isIOS, isChrome, isSafari, instructions = '') {
            const resultDiv = document.getElementById('permission-result');
            if (resultDiv) {
                resultDiv.innerHTML = `
                    <div style="padding: 15px; margin: 10px 0; border-radius: 8px; 
                                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'}; 
                                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'}; 
                                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#ffeaa7'};">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                            ${message}
                        </div>
                        ${instructions}
                    </div>
                `;
            }
        }
        
        
        
        // 初始化狀態顯示（重置為未知狀態）
        function initializeStatusDisplay() {
            console.log('初始化狀態顯示 - Web App需要用戶主動啟用');
            
            // 設置初始狀態 - Web App需要用戶主動啟用
            document.getElementById('locationStatusText').textContent = '📍 點擊下方按鈕啟用GPS定位';
            document.getElementById('gpsStatus').textContent = '⚠️ GPS需要手動啟用，請點擊按鈕允許位置權限';
            document.getElementById('sensorStatus').textContent = '⚠️ 感應器需要手動啟用，請點擊按鈕允許動作權限';
            document.getElementById('autoTracking').textContent = '⚠️ 請先啟用GPS和感應器功能';
        }
        
        // 強制請求權限（最簡化版本）
        function forceRequestPermissions() {
            console.log('👉 開始請求 GPS + 感應器權限...');
            
            // 更新按鈕狀態
            const enableBtn = document.getElementById('enableBtn');
            if (enableBtn) {
                enableBtn.innerHTML = '🔄 正在請求權限...';
                enableBtn.disabled = true;
                enableBtn.style.background = '#6c757d';
            }
            
            // 重置狀態
            updateLocationStatus(null, '🔄 正在請求GPS權限...');
            updateSensorStatus('🔄 正在請求感應器權限...');
            
            // === GPS 權限 ===
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('✅ GPS 啟用成功:', position.coords.latitude, position.coords.longitude);
                        updateLocationStatus(position, null);
                        startGPSTracking();
                    },
                    function(error) {
                        console.log('❌ GPS 啟用失敗:', error.message);
                        if (error.code === 1) {
                            updateLocationStatus(null, '❌ GPS權限被拒絕，請手動允許位置權限');
                        } else if (error.code === 2) {
                            updateLocationStatus(null, '❌ GPS位置不可用');
                        } else if (error.code === 3) {
                            updateLocationStatus(null, '❌ GPS定位超時');
                        } else {
                            updateLocationStatus(null, '❌ GPS定位失敗');
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('❌ 瀏覽器不支援 GPS API');
                updateLocationStatus(null, '❌ 瀏覽器不支援GPS定位');
            }
            
            // === 感應器權限 ===
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === "granted") {
                        console.log("✅ iOS 感應器權限已允許");
                        updateSensorStatus('✅ 感應器已啟用，持續監聽中...');
                        startSensorTracking();
                    } else {
                        console.log("❌ iOS 感應器權限被拒絕");
                        updateSensorStatus('❌ 感應器權限被拒絕，請點擊「測試感應器」按鈕');
                    }
                }).catch(error => {
                    console.log("❌ 感應器權限請求失敗:", error);
                    updateSensorStatus('❌ 感應器權限請求失敗，請點擊「測試感應器」按鈕');
                });
            } else {
                // Android / 桌面 Chrome 直接監聽
                console.log("✅ Android/桌面 已啟用感應器監聽");
                updateSensorStatus('✅ 感應器已啟用，持續監聽中...');
                startSensorTracking();
            }
            
            // 自動追蹤功能
            updateAutoTrackingStatus(t('auto_tracking_enabled'));
            
            // 3秒後恢復按鈕
            setTimeout(() => {
                if (enableBtn) {
                    enableBtn.innerHTML = '🚀 強制請求權限';
                    enableBtn.disabled = false;
                    enableBtn.style.background = '#28a745';
                }
            }, 3000);
        }
        
        // 最簡單的GPS測試
        function testGPSOnly() {
            console.log('👉 開始測試GPS權限...');
            
            const enableBtn = document.getElementById('enableBtn');
            if (enableBtn) {
                enableBtn.innerHTML = '🔄 正在測試GPS...';
                enableBtn.disabled = true;
                enableBtn.style.background = '#6c757d';
            }
            
            updateLocationStatus(null, '🔄 正在測試GPS權限...');
            
            if (!navigator.geolocation) {
                console.log('❌ 瀏覽器不支援GPS');
                updateLocationStatus(null, '❌ 瀏覽器不支援GPS');
                if (enableBtn) {
                    enableBtn.innerHTML = '❌ 不支援GPS';
                    setTimeout(() => {
                        enableBtn.innerHTML = '🚀 測試GPS權限';
                        enableBtn.disabled = false;
                        enableBtn.style.background = '#28a745';
                    }, 3000);
                }
                return;
            }
            
            // 直接在用戶點擊事件中請求GPS權限
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('✅ GPS權限成功！');
                    console.log('座標:', position.coords.latitude, position.coords.longitude);
                    updateLocationStatus(position, null);
                    
                    if (enableBtn) {
                        enableBtn.innerHTML = '✅ GPS成功！';
                        enableBtn.style.background = '#28a745';
                        setTimeout(() => {
                            enableBtn.innerHTML = '🚀 測試GPS權限';
                            enableBtn.disabled = false;
                        }, 3000);
                    }
                },
                function(error) {
                    console.log('❌ GPS權限失敗:', error.message);
                    console.log('錯誤代碼:', error.code);
                    
                    if (error.code === 1) {
                        updateLocationStatus(null, '❌ GPS權限被拒絕，請允許位置權限');
                        console.log('💡 請檢查瀏覽器位置權限設定');
                    } else if (error.code === 2) {
                        updateLocationStatus(null, '❌ GPS位置不可用');
                    } else if (error.code === 3) {
                        updateLocationStatus(null, '❌ GPS定位超時');
                    } else {
                        updateLocationStatus(null, '❌ GPS定位失敗');
                    }
                    
                    if (enableBtn) {
                        enableBtn.innerHTML = '❌ GPS失敗';
                        enableBtn.style.background = '#dc3545';
                        setTimeout(() => {
                            enableBtn.innerHTML = '🚀 測試GPS權限';
                            enableBtn.disabled = false;
                            enableBtn.style.background = '#28a745';
                        }, 3000);
                    }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // 初始化GPS和感應器狀態（Web App需要用戶主動啟用）
        function autoStartGPSAndSensor() {
            console.log('🚀 初始化GPS和感應器狀態...');
            
            // 設置初始狀態 - 引導用戶主動啟用
            document.getElementById('locationStatusText').textContent = '📍 點擊下方按鈕啟用GPS定位';
            document.getElementById('gpsStatus').textContent = '⚠️ GPS需要手動啟用，請點擊按鈕允許位置權限';
            document.getElementById('sensorStatus').textContent = '⚠️ 感應器需要手動啟用，請點擊按鈕允許動作權限';
            document.getElementById('autoTracking').textContent = '⚠️ 請先啟用GPS和感應器功能';
            
            // 顯示啟用按鈕
            document.getElementById('enableBtn').style.display = 'block';
            document.getElementById('statusMessage').textContent = '📍 請點擊下方按鈕啟用GPS和感應器功能';
        }

        // 啟用GPS和感應器功能
        function enableGPSAndSensor() {
            console.log('🚀 用戶點擊啟用GPS和感應器功能');
            
            const button = document.querySelector('#enableBtn button');
            const statusMessage = document.getElementById('statusMessage');
            
            // 更新按鈕狀態
            button.innerHTML = '🔄 正在啟用功能...';
            button.disabled = true;
            
            // 更新狀態消息
            statusMessage.textContent = '🔄 正在請求GPS和感應器權限...';
            
            // 先啟動感應器
            startSensorTracking();
            
            // 再啟動GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('📍 GPS權限獲得，開始追蹤');
                        document.getElementById('locationStatusText').textContent = t('gps_success_status');
                        document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                        
                        // 設置初始位置
                        lastPosition = position;
                        isTracking = true;
                        
                        // 開始持續追蹤
                        window.gpsWatchId = navigator.geolocation.watchPosition(
                            function(pos) {
                                if (lastPosition && isTracking) {
                                    const distance = calculateDistance(lastPosition, pos);
                                    totalDistance += distance;
                                    updateMovementData(distance, pos);
                                }
                                lastPosition = pos;
                                updateRealTimeDisplay();
                            },
                            function(error) {
                                console.log('❌ GPS 監聽失敗:', error.message);
                            },
                            { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
                        );
                        
                        // 檢查感應器狀態並更新按鈕
                        setTimeout(() => {
                            const sensorStatus = document.getElementById('sensorStatus').textContent;
                            // 检查感应器是否正常（包含"正常"、"📊"或"✅"都表示成功）
                            if (sensorStatus.includes('✅') || sensorStatus.includes('正常') || sensorStatus.includes('已啟用') || sensorStatus.includes('📊')) {
                                document.getElementById('autoTracking').textContent = t('auto_tracking_enabled');
                                statusMessage.textContent = t('gps_sensor_monitoring');
                                button.style.display = 'none'; // 隱藏按鈕
                            } else {
                                document.getElementById('autoTracking').textContent = t('gps_waiting_sensor');
                                statusMessage.textContent = t('gps_waiting_permission');
                                
                                // 恢復按鈕為可用狀態，但保持隱藏（因為GPS已成功）
                                button.innerHTML = '🚀 重新啟用GPS和感應器功能';
                                button.disabled = false;
                                button.style.display = 'none';
                            }
                        }, 3000); // 增加等待时间到3秒
                    },
                    function(error) {
                        console.log('❌ GPS權限被拒絕:', error.message);
                        let errorMsg = '❌ GPS定位失敗: ' + error.message;
                        if (error.code === error.TIMEOUT) {
                            errorMsg = '❌ GPS定位超時，請重試';
                        } else if (error.code === error.PERMISSION_DENIED) {
                            errorMsg = '❌ GPS權限被拒絕，請允許位置權限';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = '❌ GPS位置不可用，請檢查GPS設定';
                        }
                        document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                        document.getElementById('gpsStatus').textContent = errorMsg;
                        statusMessage.textContent = '❌ GPS權限被拒絕，請重新點擊按鈕並允許權限';
                        
                        // 恢復按鈕
                        button.innerHTML = '🚀 重新啟用GPS和感應器功能';
                        button.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
                );
            } else {
                document.getElementById('gpsStatus').textContent = '❌ 瀏覽器不支援GPS';
                statusMessage.textContent = '❌ 瀏覽器不支援GPS功能';
                button.innerHTML = '🚀 重新啟用GPS和感應器功能';
                button.disabled = false;
            }
        }

        // Chrome專用GPS權限請求
        function requestChromeGPSPermission() {
            console.log('📍 Chrome GPS權限請求...');
            
            const button = document.querySelector('#chromeGPSButton button');
            const statusMessage = document.getElementById('statusMessage');
            
            // 更新按鈕狀態
            button.innerHTML = '🔄 正在請求GPS權限...';
            button.disabled = true;
            button.style.background = '#6c757d';
            
            if (!navigator.geolocation) {
                statusMessage.textContent = '❌ 瀏覽器不支援GPS定位';
                button.innerHTML = '❌ 不支援GPS';
                return;
            }
            
            // 請求GPS權限
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('✅ Chrome GPS權限獲得成功！');
                    
                    // 更新狀態
                    document.getElementById('locationStatusText').textContent = t('gps_success_status');
                    document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                    statusMessage.textContent = '✅ Chrome GPS定位已啟用，正在監測您的碳足跡';
                    
                    // 隱藏按鈕
                    document.getElementById('chromeGPSButton').style.display = 'none';
                    
                    // 開始持續追蹤
                    window.gpsWatchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            if (lastPosition && isTracking) {
                                const distance = calculateDistance(lastPosition, pos);
                                totalDistance += distance;
                                updateMovementData(distance, pos);
                            }
                            lastPosition = pos;
                            isTracking = true;
                            updateRealTimeDisplay();
                        },
                        function(error) {
                            console.log('❌ GPS 監聽失敗:', error.message);
                        },
                        { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
                    );
                    
                    isTracking = true;
                },
                function(error) {
                    console.log('❌ Chrome GPS權限被拒絕:', error.message);
                    
                    let errorMsg = '❌ GPS權限被拒絕';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = '❌ GPS權限被拒絕，請在瀏覽器設定中允許位置權限';
                    } else if (error.code === error.TIMEOUT) {
                        errorMsg = '❌ GPS定位超時，請重試';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMsg = '❌ GPS位置不可用，請檢查GPS設定';
                    }
                    
                    document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                    document.getElementById('gpsStatus').textContent = errorMsg;
                    statusMessage.textContent = '❌ GPS定位失敗，請重試或使用Safari瀏覽器';
                    
                    // 恢復按鈕
                    button.innerHTML = '📍 重新嘗試啟用GPS';
                    button.disabled = false;
                    button.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%)';
                },
                { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
            );
        }

        // 測試GPS定位
        function testGPS() {
            console.log('📍 測試GPS定位...');
            
            const gpsBtn = document.getElementById('gpsBtn');
            if (gpsBtn) {
                gpsBtn.innerHTML = '🔄 正在請求GPS權限...';
                gpsBtn.disabled = true;
                gpsBtn.style.background = '#6c757d';
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('✅ GPS定位成功！');
                        document.getElementById('locationStatusText').textContent = t('gps_success_status');
                        document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                        
                        // 開始GPS追蹤
                        startGPSTracking();
                        
                        if (gpsBtn) {
                            gpsBtn.innerHTML = '✅ GPS已啟用';
                            gpsBtn.style.background = '#28a745';
                            setTimeout(() => {
                                gpsBtn.innerHTML = '📍 啟用GPS定位';
                                gpsBtn.disabled = false;
                            }, 2000);
                        }
                    },
                    function(error) {
                        console.log('❌ GPS定位失敗:', error.message);
                        document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                        document.getElementById('gpsStatus').textContent = '❌ GPS定位失敗: ' + error.message;
                        
                        if (gpsBtn) {
                            gpsBtn.innerHTML = '❌ GPS失敗';
                            gpsBtn.style.background = '#dc3545';
                            setTimeout(() => {
                                gpsBtn.innerHTML = '📍 啟用GPS定位';
                                gpsBtn.disabled = false;
                                gpsBtn.style.background = '#28a745';
                            }, 2000);
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('❌ 瀏覽器不支援GPS');
                document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                document.getElementById('gpsStatus').textContent = '❌ 瀏覽器不支援GPS定位';
                
                if (gpsBtn) {
                    gpsBtn.innerHTML = '❌ 不支援GPS';
                    setTimeout(() => {
                        gpsBtn.innerHTML = '📍 啟用GPS定位';
                        gpsBtn.disabled = false;
                        gpsBtn.style.background = '#28a745';
                    }, 2000);
                }
            }
        }

        // 同時測試GPS和感應器權限
        function testBothPermissions() {
            console.log('👉 開始測試GPS和感應器權限...');
            
            const enableBtn = document.getElementById('enableBtn');
            if (enableBtn) {
                enableBtn.innerHTML = '🔄 正在測試權限...';
                enableBtn.disabled = true;
                enableBtn.style.background = '#6c757d';
            }
            
            // 清除之前的GPS監聽，避免衝突
            if (window.gpsWatchId) {
                navigator.geolocation.clearWatch(window.gpsWatchId);
                window.gpsWatchId = null;
            }
            
            // 直接更新狀態顯示
            document.getElementById('locationStatusText').textContent = '🔄 正在請求GPS權限...';
            document.getElementById('gpsStatus').textContent = '🔄 正在請求GPS權限...';
            document.getElementById('sensorStatus').textContent = '🔄 正在請求感應器權限...';
            
            // === GPS 權限 ===
            if (navigator.geolocation) {
                console.log('開始請求GPS權限...');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('✅ GPS權限成功！');
                        console.log('座標:', position.coords.latitude, position.coords.longitude);
                        
                        // 直接更新狀態
                        document.getElementById('locationStatusText').textContent = t('gps_success_status');
                        document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                        
                        // 開始GPS追蹤（不重複啟動）
                        if (!window.gpsWatchId) {
                            startGPSTracking();
                        }
                        
                        if (enableBtn) {
                            enableBtn.innerHTML = '✅ GPS成功！';
                            enableBtn.style.background = '#28a745';
                            setTimeout(() => {
                                enableBtn.innerHTML = '🚀 測試GPS和感應器權限';
                                enableBtn.disabled = false;
                            }, 2000);
                        }
                    },
                    function(error) {
                        console.log('❌ GPS權限失敗:', error.message);
                        console.log('錯誤代碼:', error.code);
                        
                        let errorMsg = '';
                        if (error.code === 1) {
                            errorMsg = '❌ GPS權限被拒絕，請允許位置權限';
                        } else if (error.code === 2) {
                            errorMsg = '❌ GPS位置不可用';
                        } else if (error.code === 3) {
                            errorMsg = '❌ GPS定位超時';
                        } else {
                            errorMsg = '❌ GPS定位失敗';
                        }
                        
                        // 直接更新狀態
                        document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                        document.getElementById('gpsStatus').textContent = errorMsg;
                        
                        if (enableBtn) {
                            enableBtn.innerHTML = '❌ GPS失敗';
                            enableBtn.style.background = '#dc3545';
                            setTimeout(() => {
                                enableBtn.innerHTML = '🚀 測試GPS和感應器權限';
                                enableBtn.disabled = false;
                                enableBtn.style.background = '#28a745';
                            }, 2000);
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('❌ 瀏覽器不支援GPS');
                document.getElementById('locationStatusText').textContent = '📍 GPS定位失敗 | 請檢查權限設定';
                document.getElementById('gpsStatus').textContent = '❌ 瀏覽器不支援GPS';
                
                if (enableBtn) {
                    enableBtn.innerHTML = '❌ 不支援GPS';
                    setTimeout(() => {
                        enableBtn.innerHTML = '🚀 測試GPS和感應器權限';
                        enableBtn.disabled = false;
                        enableBtn.style.background = '#28a745';
                    }, 2000);
                }
            }
            
            // === 感應器權限 ===
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                console.log('正在請求感應器權限...');
                DeviceMotionEvent.requestPermission().then(response => {
                    console.log('感應器權限請求結果:', response);
                    if (response === "granted") {
                        console.log("✅ 感應器權限已允許");
                        document.getElementById('sensorStatus').textContent = t('sensor_enabled');
                        startSensorTracking();
                    } else {
                        console.log("❌ 感應器權限被拒絕");
                        document.getElementById('sensorStatus').textContent = t('sensor_permission_denied');
                    }
                }).catch(error => {
                    console.log("❌ 感應器權限請求失敗:", error);
                    document.getElementById('sensorStatus').textContent = t('sensor_permission_failed');
                });
            } else {
                // Android / 桌面 Chrome 直接監聽
                console.log("✅ Android/桌面 已啟用感應器監聽");
                document.getElementById('sensorStatus').textContent = t('sensor_enabled');
                startSensorTracking();
            }
            
            // 自動追蹤功能
            document.getElementById('autoTracking').textContent = t('auto_tracking_enabled');
        }
        
        
        // 顯示每日記錄
        function triggerDailyRecord() {
            const today = new Date().toISOString().split('T')[0];
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            // 獲取今日記錄
            const todayRecord = dailyRecords[today];
            
            // 創建美觀的模態框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">📅</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">${t('daily_stats')}</h3>
                            <div style="font-size: 14px; opacity: 0.9;">${t('today_total')} + ${t('select_range')}</div>
                        </div>
                        
                        <!-- 今日記錄 -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center;">📅 今日記錄 (${today})</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>🏪 購物:</span>
                                <span>${(todayRecord && todayRecord.shopping) ? todayRecord.shopping.toFixed(2) : '0.00'} kg CO₂</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>🚗 交通:</span>
                                <span>${(todayRecord && todayRecord.transport) ? todayRecord.transport.toFixed(2) : '0.00'} kg CO₂</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>🏃 活動:</span>
                                <span>${(todayRecord && todayRecord.activity) ? todayRecord.activity.toFixed(2) : '0.00'} kg CO₂</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                <span>📋 其他:</span>
                                <span>${(todayRecord && todayRecord.other) ? todayRecord.other.toFixed(2) : '0.00'} kg CO₂</span>
                            </div>
                            <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 15px; font-weight: bold;">
                                <span>📊 今日總計:</span>
                                <span>${(todayRecord && todayRecord.totalCarbon) ? todayRecord.totalCarbon.toFixed(2) : '0.00'} kg CO₂</span>
                            </div>
                            ${!todayRecord || todayRecord.totalCarbon === 0 ? `
                                <div style="text-align: center; font-size: 12px; opacity: 0.7; margin-top: 8px;">💡 請先掃描發票或記錄移動軌跡來開始追蹤</div>
                            ` : ''}
                        </div>
                        
                        <!-- 時間範圍選擇 -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center;" data-lang="select_range">⏰ 選擇統計時間範圍</div>
                            
                            <!-- 快速選項 -->
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 14px; margin-bottom: 8px; text-align: center;" data-lang="common_ranges">常用時間範圍</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                                    <button onclick="quickSelectDays(3)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_3')}</button>
                                    <button onclick="quickSelectDays(7)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_7')}</button>
                                    <button onclick="quickSelectDays(30)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_30')}</button>
                                    <button onclick="quickSelectDays(60)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_60_alt">近2個月</button>
                                    <button onclick="quickSelectDays(90)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_90">近3個月</button>
                                    <button onclick="quickSelectDays(120)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_120">近4個月</button>
                                    <button onclick="quickSelectDays(150)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_150">近5個月</button>
                                    <button onclick="quickSelectDays(180)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_180')}</button>
                                </div>
                            </div>
                            
                            <!-- 自定義輸入 -->
                            <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                <span style="font-size: 13px;">${t('custom_days')}：</span>
                                <input type="number" id="daysInput" value="7" min="1" max="180" style="width: 50px; padding: 4px; border: 1px solid white; border-radius: 4px; background: rgba(255,255,255,0.2); color: white; text-align: center; font-size: 12px;">
                                <span style="font-size: 13px;">天</span>
                                <button onclick="showCustomPeriodStats()" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">查看</button>
                            </div>
                            <div style="font-size: 11px; opacity: 0.8; text-align: center; margin-top: 5px;">可設定1-180天</div>
                        </div>
                        
                        <!-- 統計結果區域 -->
                        <div id="periodStats" style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px; display: none;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center;" id="periodTitle">📈 統計結果</div>
                            <div id="periodContent"></div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeModal(this)" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 30px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">${t('close')}</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 快速選擇天數
        function quickSelectDays(days) {
            const daysInput = document.getElementById('daysInput');
            daysInput.value = days;
            showPeriodStats(days);
        }
        
        // 顯示用戶自定義時間範圍的統計
        function showCustomPeriodStats() {
            const daysInput = document.getElementById('daysInput');
            const days = parseInt(daysInput.value);
            
            if (isNaN(days) || days < 1) {
                alert('請輸入有效的天數（1-180天）');
                return;
            }
            
            if (days > 180) {
                alert('最多只能查看180天（6個月）的統計');
                daysInput.value = 180;
                return;
            }
            
            showPeriodStats(days);
        }
        
        // 顯示指定時間範圍的統計
        function showPeriodStats(days) {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            // 計算指定天數前的日期
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days + 1);
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            let totalShopping = 0;
            let totalTransport = 0;
            let totalActivity = 0;
            let totalOther = 0;
            let totalCarbon = 0;
            let totalInvoices = 0;
            let recordDays = 0;
            
            // 計算指定時間範圍內的累積數據
            Object.keys(dailyRecords).forEach(date => {
                if (date >= startDateStr && date <= endDateStr) {
                    const record = dailyRecords[date];
                    totalShopping += record.shopping || 0;
                    totalTransport += record.transport || 0;
                    totalActivity += record.activity || 0;
                    totalOther += record.other || 0;
                    totalCarbon += record.totalCarbon || 0;
                    totalInvoices += record.invoiceCount || 0;
                    recordDays++;
                }
            });
            
            // 更新統計結果區域
            const periodStats = document.getElementById('periodStats');
            const periodTitle = document.getElementById('periodTitle');
            const periodContent = document.getElementById('periodContent');
            
            periodTitle.textContent = `📈 近${days}天統計 (${startDateStr} ~ ${endDateStr})`;
            
            periodContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>🏪 購物總計:</span>
                    <span style="font-weight: bold;">${totalShopping.toFixed(2)} kg CO₂</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>🚗 交通總計:</span>
                    <span style="font-weight: bold;">${totalTransport.toFixed(2)} kg CO₂</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>🏃 活動總計:</span>
                    <span style="font-weight: bold;">${totalActivity.toFixed(2)} kg CO₂</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span>📋 其他總計:</span>
                    <span style="font-weight: bold;">${totalOther.toFixed(2)} kg CO₂</span>
                </div>
                <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 12px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 16px; font-weight: bold;">📊 總碳足跡:</span>
                    <span style="font-size: 16px; font-weight: bold;">${totalCarbon.toFixed(2)} kg CO₂</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>📄 總發票數:</span>
                    <span style="font-weight: bold;">${totalInvoices} 張</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>📅 記錄天數:</span>
                    <span style="font-weight: bold;">${recordDays} 天</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>📊 平均每日:</span>
                    <span style="font-weight: bold;">${recordDays > 0 ? (totalCarbon / recordDays).toFixed(2) : '0.00'} kg CO₂</span>
                </div>
            `;
            
            periodStats.style.display = 'block';
        }
        
        // 關閉模態框
        
        // 測試感應器功能（基於正確的用戶互動事件）
        function testSensor() {
            console.log('👉 測試感應器功能');
            const testBtn = document.getElementById('testSensorBtn');
            if (testBtn) {
                testBtn.innerHTML = '🔄 正在測試...';
                testBtn.disabled = true;
                testBtn.style.background = '#6c757d';
            }
            
            if (!window.DeviceMotionEvent) {
                console.log('❌ 瀏覽器不支援感應器');
                updateSensorStatus('❌ 瀏覽器不支援感應器');
                if (testBtn) {
                    testBtn.innerHTML = '❌ 不支援感應器';
                    setTimeout(() => {
                        testBtn.innerHTML = '📱 測試感應器';
                        testBtn.disabled = false;
                        testBtn.style.background = '#007bff';
                    }, 3000);
                }
                return;
            }
            
            // 直接在用戶互動事件中請求感應器權限
            try {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    console.log('感應器需要權限請求，正在請求...');
                    DeviceMotionEvent.requestPermission().then(response => {
                        console.log('感應器權限請求結果:', response);
                        if (response === 'granted') {
                            console.log('✅ 感應器權限已授予，開始測試');
                            updateSensorStatus('✅ 感應器已啟用，持續監聽中...');
                            
                            // 開始感應器監聽
                            window.addEventListener("devicemotion", function(e) {
                                if (e.acceleration) {
                                    console.log("📱 devicemotion: 加速度X=" + e.acceleration.x);
                                    handleMotion(e);
                                }
                            });
                            
                            if (testBtn) {
                                testBtn.innerHTML = '✅ 測試成功！';
                                testBtn.style.background = '#28a745';
                                setTimeout(() => {
                                    testBtn.innerHTML = '📱 測試感應器';
                                    testBtn.disabled = false;
                                    testBtn.style.background = '#007bff';
                                }, 3000);
                            }
                        } else {
                            console.log('❌ 感應器權限被拒絕');
                            updateSensorStatus('❌ 感應器權限被拒絕');
                            if (testBtn) {
                                testBtn.innerHTML = '❌ 權限被拒絕';
                                setTimeout(() => {
                                    testBtn.innerHTML = '📱 測試感應器';
                                    testBtn.disabled = false;
                                    testBtn.style.background = '#007bff';
                                }, 3000);
                            }
                        }
                    }).catch(error => {
                        console.log('❌ 感應器權限請求失敗:', error);
                        updateSensorStatus('❌ 感應器測試失敗');
                        if (testBtn) {
                            testBtn.innerHTML = '❌ 測試失敗';
                            setTimeout(() => {
                                testBtn.innerHTML = '📱 測試感應器';
                                testBtn.disabled = false;
                                testBtn.style.background = '#007bff';
                            }, 3000);
                        }
                    });
                } else {
                    // Android / 桌面 Chrome 直接監聽
                    console.log('✅ Android/桌面 已啟用感應器監聽');
                    updateSensorStatus('✅ 感應器已啟用，持續監聽中...');
                    
                    window.addEventListener("devicemotion", function(e) {
                        if (e.acceleration) {
                            console.log("📱 devicemotion: 加速度X=" + e.acceleration.x);
                            handleMotion(e);
                        }
                    });
                    
                    if (testBtn) {
                        testBtn.innerHTML = '✅ 測試成功！';
                        testBtn.style.background = '#28a745';
                        setTimeout(() => {
                            testBtn.innerHTML = '📱 測試感應器';
                            testBtn.disabled = false;
                            testBtn.style.background = '#007bff';
                        }, 3000);
                    }
                }
            } catch (e) {
                console.log("❌ 感應器啟用錯誤:", e);
                updateSensorStatus('❌ 感應器啟用錯誤: ' + e.message);
                if (testBtn) {
                    testBtn.innerHTML = '❌ 啟用錯誤';
                    setTimeout(() => {
                        testBtn.innerHTML = '📱 測試感應器';
                        testBtn.disabled = false;
                        testBtn.style.background = '#007bff';
                    }, 3000);
                }
            }
        }
        
        // 開始感應器測試
        function startSensorTest() {
            let motionCount = 0;
            let lastMotionTime = 0;
            
            const motionHandler = function(event) {
                const now = Date.now();
                if (now - lastMotionTime < 100) return; // 防止過於頻繁
                lastMotionTime = now;
                
                const acceleration = event.accelerationIncludingGravity;
                if (acceleration) {
                    const totalAcceleration = Math.sqrt(
                        acceleration.x * acceleration.x +
                        acceleration.y * acceleration.y +
                        acceleration.z * acceleration.z
                    );
                    
                    if (totalAcceleration > 15) { // 檢測到明顯的搖動
                        motionCount++;
                        console.log('檢測到搖動:', totalAcceleration, '次數:', motionCount);
                        
                        if (motionCount >= 3) {
                            updateSensorStatus('✅ 感應器運作正常！檢測到 ' + motionCount + ' 次搖動');
                            window.removeEventListener('devicemotion', motionHandler);
                            
                            const testBtn = document.getElementById('testSensorBtn');
                            if (testBtn) {
                                testBtn.innerHTML = '✅ 測試成功！';
                                testBtn.style.background = '#28a745';
                                setTimeout(() => {
                                    testBtn.innerHTML = '📱 測試感應器（搖動手機）';
                                    testBtn.disabled = false;
                                    testBtn.style.background = '#007bff';
                                }, 3000);
                            }
                            
                            // 開始正常的感應器追蹤
                            startSensorTracking();
                        }
                    }
                }
            };
            
            window.addEventListener('devicemotion', motionHandler);
            
            // 10秒後停止測試
            setTimeout(() => {
                window.removeEventListener('devicemotion', motionHandler);
                if (motionCount < 3) {
                    updateSensorStatus('❌ 感應器測試失敗：請搖動手機');
                    const testBtn = document.getElementById('testSensorBtn');
                    if (testBtn) {
                        testBtn.innerHTML = '❌ 請搖動手機';
                        setTimeout(() => {
                            testBtn.innerHTML = '📱 測試感應器（搖動手機）';
                            testBtn.disabled = false;
                            testBtn.style.background = '#007bff';
                        }, 3000);
                    }
                }
            }, 10000);
        }
        
        // 測試GPS功能（基於正確的用戶互動事件）
        function testGPS() {
            console.log('👉 測試GPS功能');
            const testBtn = document.getElementById('testGPSBtn');
            if (testBtn) {
                testBtn.innerHTML = '🔄 正在測試...';
                testBtn.disabled = true;
                testBtn.style.background = '#6c757d';
            }
            
            if (!navigator.geolocation) {
                console.log('❌ 瀏覽器不支援 GPS API');
                updateLocationStatus(null, '❌ 瀏覽器不支援GPS定位');
                if (testBtn) {
                    testBtn.innerHTML = '❌ 不支援GPS';
                    setTimeout(() => {
                        testBtn.innerHTML = '📍 測試GPS';
                        testBtn.disabled = false;
                        testBtn.style.background = '#dc3545';
                    }, 3000);
                }
                return;
            }
            
            console.log('開始GPS測試...');
            updateLocationStatus(null, '🔄 正在測試GPS...');
            
            // 直接在用戶互動事件中請求GPS權限
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('✅ GPS 測試成功:', position.coords.latitude, position.coords.longitude);
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const accuracy = position.coords.accuracy.toFixed(2);
                    
                    updateLocationStatus(position, null);
                    
                    if (testBtn) {
                        testBtn.innerHTML = '✅ 測試成功！';
                        testBtn.style.background = '#28a745';
                        setTimeout(() => {
                            testBtn.innerHTML = '📍 測試GPS';
                            testBtn.disabled = false;
                            testBtn.style.background = '#dc3545';
                        }, 3000);
                    }
                    
                    // 開始持續GPS監聽
                    navigator.geolocation.watchPosition(
                        function(p) {
                            console.log('📍 GPS 更新:', p.coords.latitude, p.coords.longitude);
                            updateLocationStatus(p, null);
                            updateMovementData(p);
                            updateRealTimeDisplay();
                        },
                        function(err) {
                            console.log('❌ GPS 監聽失敗:', err.message);
                            updateLocationStatus(null, '❌ GPS監聽失敗: ' + err.message);
                        },
                        { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                    );
                },
                function(error) {
                    console.log('❌ GPS 測試失敗:', error.message);
                    if (error.code === error.PERMISSION_DENIED) {
                        updateLocationStatus(null, '❌ GPS權限被拒絕，請允許位置權限');
                        if (testBtn) {
                            testBtn.innerHTML = '❌ 權限被拒絕';
                            setTimeout(() => {
                                testBtn.innerHTML = '📍 測試GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        updateLocationStatus(null, '❌ GPS位置不可用');
                        if (testBtn) {
                            testBtn.innerHTML = '❌ 位置不可用';
                            setTimeout(() => {
                                testBtn.innerHTML = '📍 測試GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    } else if (error.code === error.TIMEOUT) {
                        updateLocationStatus(null, '❌ GPS定位超時');
                        if (testBtn) {
                            testBtn.innerHTML = '❌ 定位超時';
                            setTimeout(() => {
                                testBtn.innerHTML = '📍 測試GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    } else {
                        updateLocationStatus(null, '❌ GPS定位失敗');
                        if (testBtn) {
                            testBtn.innerHTML = '❌ 定位失敗';
                            setTimeout(() => {
                                testBtn.innerHTML = '📍 測試GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    }
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );
        }
        
        // 啟用GPS
        function autoEnableGPS() {
            if (!navigator.geolocation) {
                updateLocationStatus(null, '❌ 瀏覽器不支援GPS定位');
                return;
            }
            
            console.log('啟用GPS...');
            updateLocationStatus(null, '🔄 GPS正在啟動...');
            
            // 使用更積極的GPS設定來觸發權限請求
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('GPS啟用成功:', position);
                    updateLocationStatus(position, null);
                    
                    // 開始GPS追蹤
                    startGPSTracking();
                },
                function(error) {
                    console.log('GPS啟用失敗:', error);
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            updateLocationStatus(null, '❌ GPS權限被拒絕，請允許位置權限');
                            // 嘗試多次請求權限
                            retryGPSPermission(3);
                            break;
                        case error.POSITION_UNAVAILABLE:
                            updateLocationStatus(null, '❌ GPS位置不可用');
                            break;
                        case error.TIMEOUT:
                            updateLocationStatus(null, '❌ GPS定位超時');
                            break;
                        default:
                            updateLocationStatus(null, '❌ GPS定位失敗');
                            break;
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                }
            );
        }
        
        // 重試GPS權限請求
        function retryGPSPermission(retryCount) {
            if (retryCount <= 0) {
                updateLocationStatus(null, '❌ GPS權限請求失敗，請手動允許位置權限');
                return;
            }
            
            console.log('重試GPS權限請求，剩餘次數:', retryCount);
            
            setTimeout(() => {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('GPS重試成功:', position);
                        updateLocationStatus(position, null);
                        startGPSTracking();
                    },
                    function(error) {
                        console.log('GPS重試失敗:', error);
                        if (error.code === error.PERMISSION_DENIED) {
                            updateLocationStatus(null, '❌ GPS權限被拒絕，請手動允許位置權限');
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            updateLocationStatus(null, '❌ GPS位置不可用');
                        } else if (error.code === error.TIMEOUT) {
                            updateLocationStatus(null, '❌ GPS定位超時');
                        } else {
                            updateLocationStatus(null, '❌ GPS定位失敗: ' + error.message);
                        }
                    },
                    { 
                        enableHighAccuracy: false, 
                        timeout: 15000, 
                        maximumAge: 300000 
                    }
                );
            }, 2000);
        }
        
        // 啟用感應器
        function autoEnableSensor() {
            if (!window.DeviceMotionEvent) {
                updateSensorStatus('❌ 瀏覽器不支援感應器');
                return;
            }
            
            console.log('啟用感應器...');
            updateSensorStatus('🔄 感應器正在啟動...');
            
            // 檢查是否需要請求權限
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                console.log('請求感應器權限...');
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            console.log('感應器權限已授予');
                            updateSensorStatus('✅ 感應器已啟用');
                            startSensorTracking();
                        } else {
                            console.log('感應器權限被拒絕');
                            updateSensorStatus('❌ 感應器權限被拒絕，請點擊「測試感應器」按鈕');
                        }
                    })
                    .catch(error => {
                        console.log('感應器權限請求失敗:', error);
                        updateSensorStatus('❌ 感應器啟用失敗，請點擊「測試感應器」按鈕');
                    });
            } else {
                console.log('感應器不需要權限請求，但需要測試');
                updateSensorStatus('🔄 感應器需要測試，請點擊「測試感應器」按鈕');
            }
        }
        
        // 更新感應器狀態顯示
        function updateSensorStatus(status) {
            const sensorStatusElement = document.getElementById('sensorStatus');
            if (sensorStatusElement) {
                if (status) {
                    sensorStatusElement.textContent = status;
                } else {
                    sensorStatusElement.textContent = ''; // 空白狀態
                }
            }
        }
        
        // 更新自動追蹤狀態顯示
        function updateAutoTrackingStatus(status) {
            const autoTrackingElement = document.getElementById('autoTracking');
            if (autoTrackingElement) {
                if (status) {
                    autoTrackingElement.textContent = status;
                } else {
                    autoTrackingElement.textContent = ''; // 空白狀態
                }
            }
        }
        
        function getEmergencySolution(isIOS, isChrome, isSafari) {
            if (isIOS) {
                return `
                <div style="text-align: left; padding: 15px; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #c62828; margin: 0 0 10px 0;">🚨 iPhone GPS權限緊急解決方案：</h4>
                    <ol style="color: #c62828; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>從螢幕底部向上滑動並停留</strong></li>
                        <li><strong>找到Safari並向上滑動關閉</strong></li>
                        <li><strong>重新點擊Safari圖標開啟</strong></li>
                        <li><strong>重新打開應用</strong>：http://172.20.10.6:3003/</li>
                        <li><strong>立即點擊「🚀 強制請求GPS權限」</strong></li>
                        <li><strong>選擇「允許」</strong></li>
                    </ol>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #2e7d32; margin: 0; font-weight: bold;">💡 如果還是失敗，嘗試：</p>
                        <ul style="color: #2e7d32; margin: 5px 0 0 0; padding-left: 20px;">
                            <li>到戶外開闊地帶重試</li>
                            <li>確保WiFi或行動數據正常</li>
                            <li>重新啟動iPhone</li>
                            <li>更新iOS系統</li>
                        </ul>
                    </div>
                </div>
                `;
            }
            return '';
        }
        
        // 友善的成功提示模態框
        function showSuccessModal(message) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;">
                    <div style="padding: 30px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; line-height: 1.5;">${message}</h3>
                        <button onclick="closeModal(this)" data-lang="confirm" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px;">
                            確定
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 意見反饋系統
        function showFeedbackForm() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #81C784 0%, #4CAF50 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">📝</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;" data-lang="feedback">意見反饋</h3>
                            <div style="font-size: 14px; opacity: 0.9;" data-lang="feedback_title">您的意見讓我們變得更好</div>
                        </div>
                        
                        <form id="feedbackForm" style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="your_email">您的Email：</label>
                                <input type="email" id="userEmail" data-lang="email_placeholder" placeholder="請輸入您的email" required 
                                       style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                <style>
                                    #userEmail::placeholder { color: black; }
                                </style>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="feedback_content">意見內容：</label>
                                <textarea id="feedbackContent" data-lang="feedback_placeholder" placeholder="請告訴我們您的想法、建議或體驗的趣事...(150字內)" required rows="4"
                                          style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px; resize: vertical;"></textarea>
                                <style>
                                    #feedbackContent::placeholder { color: black; }
                                </style>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button type="button" onclick="submitFeedback()" data-lang="send_feedback" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    發送反饋
                                </button>
                                <button type="button" onclick="closeModal(this)" data-lang="cancel" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function submitFeedback() {
            const userEmail = document.getElementById('userEmail').value;
            const feedbackContent = document.getElementById('feedbackContent').value;
            
            if (!userEmail || !feedbackContent) {
                alert('請填寫完整信息');
                return;
            }
            
            // 直接使用後端API發送郵件
            fetch('https://carbon-footprint-tracker-alpha.vercel.app/api/send-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userEmail: userEmail,
                    feedbackContent: feedbackContent
                })
            }).then(response => {
                console.log('API回應狀態:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API回應數據:', data);
                if (data.success) {
                    showSuccessModal(t('feedback_success'));
                    closeModal(document.querySelector('.modal'));
                } else {
                    throw new Error(data.error || '發送失敗');
                }
            }).catch(error => {
                console.error('發送反饋失敗:', error);
                console.error('錯誤詳情:', {
                    message: error.message,
                    stack: error.stack
                });
                
                // 備用方案：直接複製到剪貼板並顯示詳細信息
                const feedbackText = `發送給: rbben521@gmail.com\n主題: 減碳日記 - 用戶意見反饋\n\n用戶Email: ${userEmail}\n\n意見內容:\n${feedbackContent}`;
                
                // 複製到剪貼板
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(feedbackText).then(function() {
                        alert('✅ 反饋內容已複製到剪貼板！\n\n請打開您的郵件應用程式，貼上內容並發送給：\nrbben521@gmail.com\n\n主題：減碳日記 - 用戶意見反饋');
                    }).catch(function() {
                        // 如果複製失敗，顯示完整信息
                        showFallbackInstructions(userEmail, feedbackContent);
                    });
                } else {
                    // 如果瀏覽器不支援剪貼板API，顯示完整信息
                    showFallbackInstructions(userEmail, feedbackContent);
                }
                
                closeModal(document.querySelector('.modal'));
            });
        }
        
        // 顯示備用方案的詳細說明
        function showFallbackInstructions(userEmail, feedbackContent) {
            const instructions = `📧 請手動發送郵件至：rbben521@gmail.com

📝 郵件內容：
────────────────────────
收件人：rbben521@gmail.com
主題：減碳日記 - 用戶意見反饋

用戶Email：${userEmail}

意見內容：
${feedbackContent}
────────────────────────

請複製以上內容到您的郵件應用程式並發送。`;
            
            alert(instructions);
        }
        
    </script>
</body>
</html>
