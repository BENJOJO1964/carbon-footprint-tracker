<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>ç¢³è¶³è·¡è¿½è¹¤å™¨</title>
    
    <!-- å¤šèªè¨€ç³»çµ± -->
    <script>
        // å¤šèªè¨€é…ç½®
        const languages = {
            'zh-TW': {
                // ä¸»è¦ç•Œé¢
                'app_title': 'æ¸›ç¢³æ—¥è¨˜',
                'app_subtitle': 'è‡ªå‹•åµæ¸¬ç¢³æ’ï¼Œç”Ÿæ´»å°±æ˜¯æ—¥è¨˜',
                'daily_record': 'æ¯æ—¥è¨˜éŒ„',
                'feedback': 'æ„è¦‹åé¥‹',
                'scan_invoice': 'ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ',
                'bind_carrier': 'ğŸ”— ç¶å®šé›»å­ç™¼ç¥¨è¼‰å…·',
                'today_carbon': 'ä»Šæ—¥ç¢³è¶³è·¡',
                'total_carbon': 'ç¸½ç¢³è¶³è·¡',
                'store_name': 'å•†åº—åç¨±',
                'amount': 'æ¶ˆè²»é‡‘é¡',
                'carbon_footprint': 'ç¢³è¶³è·¡',
                'submit': 'æäº¤è¨˜éŒ„',
                'reset': 'é‡ç½®',
                
                // æ¯æ—¥è¨˜éŒ„æ¨¡æ…‹æ¡†
                'daily_stats': 'æ¯æ—¥ç¢³è¶³è·¡çµ±è¨ˆ',
                'today_total': 'ä»Šæ—¥ç¸½è¨ˆ',
                'select_range': 'é¸æ“‡çµ±è¨ˆæ™‚é–“ç¯„åœï¼š',
                'days_3': 'è¿‘3å¤©',
                'days_7': 'è¿‘7å¤©',
                'days_15': 'è¿‘15å¤©',
                'days_30': 'è¿‘30å¤©',
                'days_60': 'è¿‘60å¤©',
                'days_180': 'è¿‘6å€‹æœˆ',
                'custom_days': 'è‡ªå®šç¾©å¤©æ•¸',
                'enter_days': 'è«‹è¼¸å…¥å¤©æ•¸',
                'cumulative_stats': 'ç´¯è¨ˆçµ±è¨ˆ',
                'average_daily': 'å¹³å‡æ¯æ—¥',
                'close': 'é—œé–‰',
                
                // åé¥‹æ¨¡æ…‹æ¡†
                'feedback_title': 'æ‚¨çš„æ„è¦‹è®“æˆ‘å€‘è®Šå¾—æ›´å¥½',
                'your_email': 'æ‚¨çš„Email',
                'feedback_content': 'è«‹å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•ï¼Œå»ºè­°æˆ–é«”é©—çš„è¶£äº‹...(150å­—å…§)',
                'send_feedback': 'ç™¼é€åé¥‹',
                'cancel': 'å–æ¶ˆ',
                'feedback_success': 'æ„Ÿè¬ä½ çš„è²éŸ³ï¼Œæ¸›ç¢³æ—¥è¨˜å› ä½ è€Œæ›´å¥½ã€‚',
                
                // æƒæç›¸é—œ
                'scanning': 'æƒæä¸­...',
                'scan_success': 'æƒææˆåŠŸï¼',
                'scan_failed': 'æƒæå¤±æ•—',
                'auto_detected': 'ğŸ¤– è‡ªå‹•åµæ¸¬åˆ°ç™¼ç¥¨ï¼',
                'continue_scanning': 'ç¹¼çºŒæƒæ',
                
                // è¼‰å…·ç¶å®š
                'carrier_binding': 'é›»å­ç™¼ç¥¨è¼‰å…·ç¶å®š',
                'carrier_code': 'è¼‰å…·ç·¨è™Ÿ',
                'bind_success': 'è¼‰å…·ç¶å®šæˆåŠŸ',
                'bind_failed': 'è¼‰å…·ç¶å®šå¤±æ•—',
                
                // é€šç”¨
                'loading': 'è¼‰å…¥ä¸­...',
                'error': 'éŒ¯èª¤',
                'success': 'æˆåŠŸ',
                'confirm': 'ç¢ºå®š',
                'kg_co2': 'kg COâ‚‚',
                'ntd': 'NT$',
                'daily_target': 'ä»Šæ—¥ç›®æ¨™: 20.0 å…¬æ–¤ | å®Œæˆåº¦: 0.0%',
                'gps_status': 'GPSå®šä½æˆåŠŸ | æ­£åœ¨è¿½è¹¤æ‚¨çš„ç§»å‹•',
                'realtime_status_title': 'ğŸ“± å¯¦æ™‚åŠŸèƒ½ç‹€æ…‹ï¼š',
                'status_explanation': 'ğŸ“‹ ç‹€æ…‹èªªæ˜ï¼š',
                'gps_desc': 'å®šä½æ‚¨çš„ä½ç½®ï¼Œç”¨æ–¼è¨˜éŒ„ç§»å‹•è»Œè·¡',
                'sensor_desc': 'æª¢æ¸¬æ‰‹æ©Ÿå‹•ä½œï¼Œåˆ¤æ–·äº¤é€šå·¥å…·é¡å‹',
                'auto_tracking_desc': 'è‡ªå‹•è¨˜éŒ„ç§»å‹•å’Œç™¼ç¥¨ï¼Œè¨ˆç®—ç¢³è¶³è·¡',
                'auto_enabled_status': 'âœ… GPSå’Œæ„Ÿæ‡‰å™¨å·²è‡ªå‹•å•Ÿç”¨ï¼Œæ­£åœ¨ç›£æ¸¬æ‚¨çš„ç¢³è¶³è·¡',
                'breakdown_title': 'ä»Šæ—¥ç¢³è¶³è·¡åˆ†è§£ï¼ˆå¯¦æ™‚åµæ¸¬ï¼‰',
                'transport_label': 'ğŸš— äº¤é€šé‹è¼¸',
                'shopping_label': 'ğŸ›’ è³¼ç‰©æ¶ˆè²»',
                'activity_label': 'ğŸ“± æ‰‹æ©Ÿä½¿ç”¨',
                'location_label': 'ğŸ“ ç§»å‹•è»Œè·¡',
                'sensor_label': 'ğŸ“± æ„Ÿæ‡‰å™¨æ•¸æ“š',
                'daily_stats_title': 'ä»Šæ—¥ç¢³è¶³è·¡çµ±è¨ˆ',
                'daily_shopping': 'ğŸ›’ è³¼ç‰©æ¶ˆè²»:',
                'daily_transport': 'ğŸš— äº¤é€šç§»å‹•:',
                'daily_activity': 'ğŸƒ æ´»å‹•æ„Ÿæ‡‰:',
                'daily_other': 'ğŸ“± å…¶ä»–ä¾†æº:',
                'daily_invoice_count': 'ğŸ“‹ ç™¼ç¥¨æ•¸é‡:',
                'common_ranges': 'å¸¸ç”¨æ™‚é–“ç¯„åœ',
                'days_60_alt': 'è¿‘2å€‹æœˆ',
                'days_90': 'è¿‘3å€‹æœˆ',
                'days_120': 'è¿‘4å€‹æœˆ',
                'days_150': 'è¿‘5å€‹æœˆ',
                'movement_record': 'ç§»å‹•è¨˜éŒ„',
                'record_transport': 'è¨˜éŒ„äº¤é€šæ–¹å¼',
                'invoice_management': 'ç™¼ç¥¨ç®¡ç†',
                'bind_scan_detect': 'ç¶å®šè¼‰å…· & æƒæç™¼ç¥¨',
                'auto_detect_carbon': 'è‡ªå‹•åµæ¸¬ç¢³è¶³è·¡',
                'data_analysis': 'æ•¸æ“šåˆ†æ',
                'view_detailed_stats': 'æŸ¥çœ‹è©³ç´°çµ±è¨ˆ',
                'settings': 'è¨­å®š',
                'personalized_settings': 'å€‹äººåŒ–è¨­å®š',
                'invoice_management_title': 'ğŸ§¾ ç™¼ç¥¨ç®¡ç†',
                'e_invoice_carrier': 'ğŸ“± é›»å­ç™¼ç¥¨è¼‰å…·',
                'carrier_not_bound': 'æœªç¶å®šè¼‰å…·',
                'sync_carrier_invoices': 'ğŸ”„ åŒæ­¥è¼‰å…·ç™¼ç¥¨',
                'auto_sync_status': 'è‡ªå‹•åŒæ­¥:',
                'sync_enabled': 'å·²å•Ÿç”¨',
                'traditional_invoice_scan': 'ğŸ“· å‚³çµ±ç™¼ç¥¨æƒæ',
                'store_placeholder': 'ä¾‹å¦‚: å…¨è¯ç¦åˆ©ä¸­å¿ƒ',
                'amount_placeholder': 'ä¾‹å¦‚: 150',
                'carbon_placeholder': 'æƒæå¾Œè‡ªå‹•è¨ˆç®—',
                'recent_invoice_records': 'ğŸ“‹ æœ€è¿‘ç™¼ç¥¨è¨˜éŒ„',
                'record_movement_title': 'ğŸš— è¨˜éŒ„ç§»å‹•',
                'movement_method': 'ç§»å‹•æ–¹å¼',
                'driving': 'é–‹è»Š',
                'walking': 'æ­¥è¡Œ',
                'cycling': 'é¨è‡ªè¡Œè»Š',
                'public_transport': 'å¤§çœ¾é‹è¼¸',
                'distance_km': 'è·é›¢ (å…¬é‡Œ)',
                'time_minutes': 'æ™‚é–“ (åˆ†é˜)',
                'record_movement': 'è¨˜éŒ„ç§»å‹•',
                'manual_activity_title': 'ğŸƒ æ‰‹å‹•è¨˜éŒ„æ´»å‹•',
                'activity_type': 'æ´»å‹•é¡å‹',
                'activity_duration': 'æ´»å‹•æ™‚é•· (åˆ†é˜)',
                'activity_intensity': 'æ´»å‹•å¼·åº¦',
                'low_intensity': 'ä½å¼·åº¦',
                'medium_intensity': 'ä¸­å¼·åº¦',
                'high_intensity': 'é«˜å¼·åº¦',
                'record_activity': 'è¨˜éŒ„æ´»å‹•',
                'settings_title': 'âš™ï¸ è¨­å®š',
                'daily_goal_kg': 'æ¯æ—¥ç¢³è¶³è·¡ç›®æ¨™ (å…¬æ–¤)',
                'gps_positioning': 'ğŸ“ GPSå®šä½ä¸­...',
                'enabled': 'å•Ÿç”¨',
                'disabled': 'åœç”¨',
                'save_settings': 'å„²å­˜è¨­å®š',
                'gps_status_loading': 'ğŸ”„ GPSå®šä½ä¸­...',
                'sensor_loading': 'ğŸ”„ æ„Ÿæ‡‰å™¨å•Ÿå‹•ä¸­...',
                'auto_tracking_enabled': 'âœ… è‡ªå‹•è¿½è¹¤åŠŸèƒ½å·²å•Ÿç”¨',
                'gps_status_checking': 'ğŸ“ GPSç‹€æ…‹æª¢æ¸¬ä¸­...',
                'gps_failed': 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š',
                'distance_placeholder': 'ä¾‹å¦‚: 5.2',
                'time_placeholder': 'ä¾‹å¦‚: 30',
                'sync_disabled': 'å·²åœç”¨',
                'analytics_feature': 'ğŸ“Š æ•¸æ“šåˆ†æåŠŸèƒ½',
                'full_version_features': 'åœ¨å®Œæ•´ç‰ˆæœ¬ä¸­ï¼Œé€™è£¡æœƒé¡¯ç¤º',
                'historical_trends': 'æ­·å²è¶¨å‹¢åœ–è¡¨',
                'categorized_stats': 'åˆ†é¡çµ±è¨ˆ',
                'eco_suggestions': 'ç’°ä¿å»ºè­°',
                'goal_achievement': 'ç›®æ¨™é”æˆæƒ…æ³',
                'sensor_enabled': 'âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...',
                'sensor_not_supported': 'âŒ ç€è¦½å™¨ä¸æ”¯æ´æ„Ÿæ‡‰å™¨',
                'sensor_normal': 'ğŸ“Š æ„Ÿæ‡‰å™¨æ­£å¸¸ (åŠ é€Ÿåº¦: {acceleration}m/sÂ²)',
                'sensor_permission_denied': 'âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•',
                'sensor_permission_failed': 'âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•',
                'gps_success_status': 'ğŸ“ GPSå®šä½æˆåŠŸ | æ­£åœ¨è¿½è¹¤æ‚¨çš„ç§»å‹•',
                'gps_success_accuracy': 'âœ… GPSå®šä½æˆåŠŸ (ç²¾åº¦: {accuracy}ç±³)',
                'auto_tracking_enabled': 'âœ… è‡ªå‹•è¿½è¹¤åŠŸèƒ½å·²å•Ÿç”¨',
                'gps_sensor_monitoring': 'âœ… GPSå’Œæ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼Œæ­£åœ¨ç›£æ¸¬æ‚¨çš„ç¢³è¶³è·¡',
                'gps_waiting_sensor': 'âš ï¸ GPSå·²å•Ÿç”¨ï¼Œç­‰å¾…æ„Ÿæ‡‰å™¨å°±ç·’',
                'gps_waiting_permission': 'âœ… GPSå·²å•Ÿç”¨ï¼Œç­‰å¾…æ„Ÿæ‡‰å™¨æ¬Šé™',
                'sensor_label_short': 'æ„Ÿæ‡‰å™¨',
                'auto_tracking_label_short': 'è‡ªå‹•è¿½è¹¤',
                'settings_saved': 'è¨­å®šå·²å„²å­˜ï¼',
                'email_placeholder': 'è«‹è¼¸å…¥æ‚¨çš„email',
                'feedback_placeholder': 'è«‹å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•ã€å»ºè­°æˆ–é«”é©—çš„è¶£äº‹...(150å­—å…§)',
                'confirm': 'ç¢ºå®š',
                'auto_tracking': 'è‡ªå‹•è¿½è¹¤',
                'real_time_analytics': 'åŸºæ–¼æ‚¨çš„è‡ªå‹•åµæ¸¬æ•¸æ“š',
                'today_summary': 'ä»Šæ—¥æ‘˜è¦',
                'today_carbon': 'ä»Šæ—¥ç¢³è¶³è·¡ (kg)',
                'goal_progress': 'ç›®æ¨™é€²åº¦',
                'category_breakdown': 'åˆ†é¡çµ±è¨ˆ',
                'weekly_trends': 'è¿‘7å¤©è¶¨å‹¢'
            },
            'zh-CN': {
                // ä¸»è¦ç•Œé¢
                'app_title': 'å‡ç¢³æ—¥è®°',
                'app_subtitle': 'è‡ªåŠ¨ä¾¦æµ‹ç¢³æ’ï¼Œç”Ÿæ´»å°±æ˜¯æ—¥è®°',
                'daily_record': 'æ¯æ—¥è®°å½•',
                'feedback': 'æ„è§åé¦ˆ',
                'scan_invoice': 'ğŸ“· å¼€å¯ç›¸æœºæ‰«æ',
                'bind_carrier': 'ğŸ”— ç»‘å®šç”µå­å‘ç¥¨è½½å…·',
                'today_carbon': 'ä»Šæ—¥ç¢³è¶³è¿¹',
                'total_carbon': 'æ€»ç¢³è¶³è¿¹',
                'store_name': 'å•†åº—åç§°',
                'amount': 'æ¶ˆè´¹é‡‘é¢',
                'carbon_footprint': 'ç¢³è¶³è¿¹',
                'submit': 'æäº¤è®°å½•',
                'reset': 'é‡ç½®',
                
                // æ¯æ—¥è®°å½•æ¨¡æ€æ¡†
                'daily_stats': 'æ¯æ—¥ç¢³è¶³è¿¹ç»Ÿè®¡',
                'today_total': 'ä»Šæ—¥æ€»è®¡',
                'select_range': 'é€‰æ‹©ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼š',
                'days_3': 'è¿‘3å¤©',
                'days_7': 'è¿‘7å¤©',
                'days_15': 'è¿‘15å¤©',
                'days_30': 'è¿‘30å¤©',
                'days_60': 'è¿‘60å¤©',
                'days_180': 'è¿‘6ä¸ªæœˆ',
                'custom_days': 'è‡ªå®šä¹‰å¤©æ•°',
                'enter_days': 'è¯·è¾“å…¥å¤©æ•°',
                'cumulative_stats': 'ç´¯è®¡ç»Ÿè®¡',
                'average_daily': 'å¹³å‡æ¯æ—¥',
                'close': 'å…³é—­',
                
                // åé¦ˆæ¨¡æ€æ¡†
                'feedback_title': 'æ‚¨çš„æ„è§è®©æˆ‘ä»¬å˜å¾—æ›´å¥½',
                'your_email': 'æ‚¨çš„Email',
                'feedback_content': 'è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨çš„æƒ³æ³•ï¼Œå»ºè®®æˆ–ä½“éªŒçš„è¶£äº‹...(150å­—å†…)',
                'send_feedback': 'å‘é€åé¦ˆ',
                'cancel': 'å–æ¶ˆ',
                'feedback_success': 'æ„Ÿè°¢ä½ çš„å£°éŸ³ï¼Œå‡ç¢³æ—¥è®°å› ä½ è€Œæ›´å¥½ã€‚',
                
                // æ‰«æç›¸å…³
                'scanning': 'æ‰«æä¸­...',
                'scan_success': 'æ‰«ææˆåŠŸï¼',
                'scan_failed': 'æ‰«æå¤±è´¥',
                'auto_detected': 'ğŸ¤– è‡ªåŠ¨ä¾¦æµ‹åˆ°å‘ç¥¨ï¼',
                'continue_scanning': 'ç»§ç»­æ‰«æ',
                
                // è½½å…·ç»‘å®š
                'carrier_binding': 'ç”µå­å‘ç¥¨è½½å…·ç»‘å®š',
                'carrier_code': 'è½½å…·ç¼–å·',
                'bind_success': 'è½½å…·ç»‘å®šæˆåŠŸ',
                'bind_failed': 'è½½å…·ç»‘å®šå¤±è´¥',
                
                // é€šç”¨
                'loading': 'åŠ è½½ä¸­...',
                'error': 'é”™è¯¯',
                'success': 'æˆåŠŸ',
                'confirm': 'ç¡®å®š',
                'kg_co2': 'kg COâ‚‚',
                'ntd': 'Â¥',
                'daily_target': 'ä»Šæ—¥ç›®æ ‡: 20.0 å…¬æ–¤ | å®Œæˆåº¦: 0.0%',
                'gps_status': 'GPSå®šä½æˆåŠŸ | æ­£åœ¨è¿½è¸ªæ‚¨çš„ç§»åŠ¨',
                'realtime_status_title': 'ğŸ“± å®æ—¶åŠŸèƒ½çŠ¶æ€ï¼š',
                'status_explanation': 'ğŸ“‹ çŠ¶æ€è¯´æ˜ï¼š',
                'gps_desc': 'å®šä½æ‚¨çš„ä½ç½®ï¼Œç”¨äºè®°å½•ç§»åŠ¨è½¨è¿¹',
                'sensor_desc': 'æ£€æµ‹æ‰‹æœºåŠ¨ä½œï¼Œåˆ¤æ–­äº¤é€šå·¥å…·ç±»å‹',
                'auto_tracking_desc': 'è‡ªåŠ¨è®°å½•ç§»åŠ¨å’Œå‘ç¥¨ï¼Œè®¡ç®—ç¢³è¶³è¿¹',
                'auto_enabled_status': 'âœ… GPSå’Œæ„Ÿåº”å™¨å·²è‡ªåŠ¨å¯ç”¨ï¼Œæ­£åœ¨ç›‘æµ‹æ‚¨çš„ç¢³è¶³è¿¹',
                'breakdown_title': 'ä»Šæ—¥ç¢³è¶³è¿¹åˆ†è§£ï¼ˆå®æ—¶ä¾¦æµ‹ï¼‰',
                'transport_label': 'ğŸš— äº¤é€šè¿è¾“',
                'shopping_label': 'ğŸ›’ è´­ç‰©æ¶ˆè´¹',
                'activity_label': 'ğŸ“± æ‰‹æœºä½¿ç”¨',
                'location_label': 'ğŸ“ ç§»åŠ¨è½¨è¿¹',
                'sensor_label': 'ğŸ“± æ„Ÿåº”å™¨æ•°æ®',
                'daily_stats_title': 'ä»Šæ—¥ç¢³è¶³è¿¹ç»Ÿè®¡',
                'daily_shopping': 'ğŸ›’ è´­ç‰©æ¶ˆè´¹:',
                'daily_transport': 'ğŸš— äº¤é€šç§»åŠ¨:',
                'daily_activity': 'ğŸƒ æ´»åŠ¨æ„Ÿåº”:',
                'daily_other': 'ğŸ“± å…¶ä»–æ¥æº:',
                'daily_invoice_count': 'ğŸ“‹ å‘ç¥¨æ•°é‡:',
                'common_ranges': 'å¸¸ç”¨æ—¶é—´èŒƒå›´',
                'days_60_alt': 'è¿‘2ä¸ªæœˆ',
                'days_90': 'è¿‘3ä¸ªæœˆ',
                'days_120': 'è¿‘4ä¸ªæœˆ',
                'days_150': 'è¿‘5ä¸ªæœˆ',
                'movement_record': 'ç§»åŠ¨è®°å½•',
                'record_transport': 'è®°å½•äº¤é€šæ–¹å¼',
                'invoice_management': 'å‘ç¥¨ç®¡ç†',
                'bind_scan_detect': 'ç»‘å®šè½½å…· & æ‰«æå‘ç¥¨',
                'auto_detect_carbon': 'è‡ªåŠ¨ä¾¦æµ‹ç¢³è¶³è¿¹',
                'data_analysis': 'æ•°æ®åˆ†æ',
                'view_detailed_stats': 'æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡',
                'settings': 'è®¾å®š',
                'personalized_settings': 'ä¸ªæ€§åŒ–è®¾å®š',
                'invoice_management_title': 'ğŸ§¾ å‘ç¥¨ç®¡ç†',
                'e_invoice_carrier': 'ğŸ“± ç”µå­å‘ç¥¨è½½å…·',
                'carrier_not_bound': 'æœªç»‘å®šè½½å…·',
                'sync_carrier_invoices': 'ğŸ”„ åŒæ­¥è½½å…·å‘ç¥¨',
                'auto_sync_status': 'è‡ªåŠ¨åŒæ­¥:',
                'sync_enabled': 'å·²å¯ç”¨',
                'traditional_invoice_scan': 'ğŸ“· ä¼ ç»Ÿå‘ç¥¨æ‰«æ',
                'store_placeholder': 'ä¾‹å¦‚: å…¨è”ç¦åˆ©ä¸­å¿ƒ',
                'amount_placeholder': 'ä¾‹å¦‚: 150',
                'carbon_placeholder': 'æ‰«æåè‡ªåŠ¨è®¡ç®—',
                'recent_invoice_records': 'ğŸ“‹ æœ€è¿‘å‘ç¥¨è®°å½•',
                'record_movement_title': 'ğŸš— è®°å½•ç§»åŠ¨',
                'movement_method': 'ç§»åŠ¨æ–¹å¼',
                'driving': 'å¼€è½¦',
                'walking': 'æ­¥è¡Œ',
                'cycling': 'éª‘è‡ªè¡Œè½¦',
                'public_transport': 'å¤§ä¼—è¿è¾“',
                'distance_km': 'è·ç¦» (å…¬é‡Œ)',
                'time_minutes': 'æ—¶é—´ (åˆ†é’Ÿ)',
                'record_movement': 'è®°å½•ç§»åŠ¨',
                'manual_activity_title': 'ğŸƒ æ‰‹åŠ¨è®°å½•æ´»åŠ¨',
                'activity_type': 'æ´»åŠ¨ç±»å‹',
                'activity_duration': 'æ´»åŠ¨æ—¶é•¿ (åˆ†é’Ÿ)',
                'activity_intensity': 'æ´»åŠ¨å¼ºåº¦',
                'low_intensity': 'ä½å¼ºåº¦',
                'medium_intensity': 'ä¸­å¼ºåº¦',
                'high_intensity': 'é«˜å¼ºåº¦',
                'record_activity': 'è®°å½•æ´»åŠ¨',
                'settings_title': 'âš™ï¸ è®¾å®š',
                'daily_goal_kg': 'æ¯æ—¥ç¢³è¶³è¿¹ç›®æ ‡ (å…¬æ–¤)',
                'gps_positioning': 'ğŸ“ GPSå®šä½ä¸­...',
                'enabled': 'å¯ç”¨',
                'disabled': 'åœç”¨',
                'save_settings': 'å‚¨å­˜è®¾å®š',
                'gps_status_loading': 'ğŸ”„ GPSå®šä½ä¸­...',
                'sensor_loading': 'ğŸ”„ æ„Ÿåº”å™¨å¯åŠ¨ä¸­...',
                'auto_tracking_enabled': 'âœ… è‡ªåŠ¨è¿½è¸ªåŠŸèƒ½å·²å¯ç”¨',
                'gps_status_checking': 'ğŸ“ GPSçŠ¶æ€æ£€æµ‹ä¸­...',
                'gps_failed': 'ğŸ“ GPSå®šä½å¤±è´¥ | è¯·æ£€æŸ¥æƒé™è®¾å®š',
                'distance_placeholder': 'ä¾‹å¦‚: 5.2',
                'time_placeholder': 'ä¾‹å¦‚: 30',
                'sync_disabled': 'å·²åœç”¨',
                'analytics_feature': 'ğŸ“Š æ•°æ®åˆ†æåŠŸèƒ½',
                'full_version_features': 'åœ¨å®Œæ•´ç‰ˆæœ¬ä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤º',
                'historical_trends': 'å†å²è¶‹åŠ¿å›¾è¡¨',
                'categorized_stats': 'åˆ†ç±»ç»Ÿè®¡',
                'eco_suggestions': 'ç¯ä¿å»ºè®®',
                'goal_achievement': 'ç›®æ ‡è¾¾æˆæƒ…å†µ',
                'sensor_enabled': 'âœ… æ„Ÿåº”å™¨å·²å¯ç”¨ï¼ŒæŒç»­ç›‘å¬ä¸­...',
                'sensor_not_supported': 'âŒ æµè§ˆå™¨ä¸æ”¯æŒæ„Ÿåº”å™¨',
                'sensor_normal': 'ğŸ“Š æ„Ÿåº”å™¨æ­£å¸¸ (åŠ é€Ÿåº¦: {acceleration}m/sÂ²)',
                'sensor_permission_denied': 'âŒ æ„Ÿåº”å™¨æƒé™è¢«æ‹’ç»ï¼Œè¯·ç‚¹å‡»ã€Œæµ‹è¯•æ„Ÿåº”å™¨ã€æŒ‰é’®',
                'sensor_permission_failed': 'âŒ æ„Ÿåº”å™¨æƒé™è¯·æ±‚å¤±è´¥ï¼Œè¯·ç‚¹å‡»ã€Œæµ‹è¯•æ„Ÿåº”å™¨ã€æŒ‰é’®',
                'gps_success_status': 'ğŸ“ GPSå®šä½æˆåŠŸ | æ­£åœ¨è¿½è¸ªæ‚¨çš„ç§»åŠ¨',
                'gps_success_accuracy': 'âœ… GPSå®šä½æˆåŠŸ (ç²¾åº¦: {accuracy}ç±³)',
                'auto_tracking_enabled': 'âœ… è‡ªåŠ¨è¿½è¸ªåŠŸèƒ½å·²å¯ç”¨',
                'gps_sensor_monitoring': 'âœ… GPSå’Œæ„Ÿåº”å™¨å·²å¯ç”¨ï¼Œæ­£åœ¨ç›‘æµ‹æ‚¨çš„ç¢³è¶³è¿¹',
                'gps_waiting_sensor': 'âš ï¸ GPSå·²å¯ç”¨ï¼Œç­‰å¾…æ„Ÿåº”å™¨å°±ç»ª',
                'gps_waiting_permission': 'âœ… GPSå·²å¯ç”¨ï¼Œç­‰å¾…æ„Ÿåº”å™¨æƒé™',
                'sensor_label_short': 'æ„Ÿåº”å™¨',
                'auto_tracking_label_short': 'è‡ªåŠ¨è¿½è¸ª',
                'settings_saved': 'è®¾å®šå·²å‚¨å­˜ï¼',
                'auto_tracking': 'è‡ªåŠ¨è¿½è¸ª',
                'real_time_analytics': 'åŸºäºæ‚¨çš„è‡ªåŠ¨ä¾¦æµ‹æ•°æ®',
                'today_summary': 'ä»Šæ—¥æ‘˜è¦',
                'today_carbon': 'ä»Šæ—¥ç¢³è¶³è¿¹ (kg)',
                'goal_progress': 'ç›®æ ‡è¿›åº¦',
                'category_breakdown': 'åˆ†ç±»ç»Ÿè®¡',
                'weekly_trends': 'è¿‘7å¤©è¶‹åŠ¿'
            },
            'en': {
                // ä¸»è¦ç•Œé¢
                'app_title': 'Carbon Diary',
                'app_subtitle': 'Auto-detect carbon emissions, life is a diary',
                'daily_record': 'Daily Record',
                'feedback': 'Feedback',
                'scan_invoice': 'ğŸ“· Open Camera Scan',
                'bind_carrier': 'ğŸ”— Bind E-Invoice Carrier',
                'today_carbon': 'Today\'s Carbon',
                'total_carbon': 'Total Carbon',
                'store_name': 'Store Name',
                'amount': 'Amount',
                'carbon_footprint': 'Carbon Footprint',
                'submit': 'Submit',
                'reset': 'Reset',
                
                // æ¯æ—¥è®°å½•æ¨¡æ€æ¡†
                'daily_stats': 'Daily Carbon Statistics',
                'today_total': 'Today\'s Total',
                'select_range': 'Select time range:',
                'days_3': 'Last 3 days',
                'days_7': 'Last 7 days',
                'days_15': 'Last 15 days',
                'days_30': 'Last 30 days',
                'days_60': 'Last 60 days',
                'days_180': 'Last 6 months',
                'custom_days': 'Custom days',
                'enter_days': 'Enter days',
                'cumulative_stats': 'Cumulative Stats',
                'average_daily': 'Daily Average',
                'close': 'Close',
                
                // åé¦ˆæ¨¡æ€æ¡†
                'feedback_title': 'Your feedback makes us better',
                'your_email': 'Your Email',
                'feedback_content': 'Tell us your thoughts, suggestions or interesting experiences... (within 150 characters)',
                'send_feedback': 'Send Feedback',
                'cancel': 'Cancel',
                'feedback_success': 'Thank you for your voice, Carbon Diary is better because of you.',
                
                // æ‰«æç›¸å…³
                'scanning': 'Scanning...',
                'scan_success': 'Scan successful!',
                'scan_failed': 'Scan failed',
                'auto_detected': 'ğŸ¤– Invoice auto-detected!',
                'continue_scanning': 'Continue Scanning',
                
                // è½½å…·ç»‘å®š
                'carrier_binding': 'E-Invoice Carrier Binding',
                'carrier_code': 'Carrier Code',
                'bind_success': 'Carrier bound successfully',
                'bind_failed': 'Carrier binding failed',
                
                // é€šç”¨
                'loading': 'Loading...',
                'error': 'Error',
                'success': 'Success',
                'confirm': 'Confirm',
                'kg_co2': 'kg COâ‚‚',
                'ntd': '$',
                'daily_target': 'Daily Goal: 20.0 kg | Progress: 0.0%',
                'gps_status': 'GPS positioning successful | Tracking your movement',
                'realtime_status_title': 'ğŸ“± Real-time Function Status:',
                'status_explanation': 'ğŸ“‹ Status Explanation:',
                'gps_desc': 'Locate your position, used to record movement trajectories',
                'sensor_desc': 'Detect phone movements, determine transportation type',
                'auto_tracking_desc': 'Automatically record movements and invoices, calculate carbon footprint',
                'auto_enabled_status': 'âœ… GPS and sensors are automatically enabled, monitoring your carbon footprint',
                'breakdown_title': 'Today\'s Carbon Footprint Breakdown (Real-time Detection)',
                'transport_label': 'ğŸš— Transportation',
                'shopping_label': 'ğŸ›’ Shopping',
                'activity_label': 'ğŸ“± Phone Usage',
                'location_label': 'ğŸ“ Movement Tracking',
                'sensor_label': 'ğŸ“± Sensor Data',
                'daily_stats_title': 'Today\'s Carbon Footprint Statistics',
                'daily_shopping': 'ğŸ›’ Shopping:',
                'daily_transport': 'ğŸš— Transportation:',
                'daily_activity': 'ğŸƒ Activity Detection:',
                'daily_other': 'ğŸ“± Other Sources:',
                'daily_invoice_count': 'ğŸ“‹ Invoice Count:',
                'common_ranges': 'Common Time Ranges',
                'days_60_alt': 'Last 2 Months',
                'days_90': 'Last 3 Months',
                'days_120': 'Last 4 Months',
                'days_150': 'Last 5 Months',
                'movement_record': 'Movement Record',
                'record_transport': 'Record Transportation',
                'invoice_management': 'Invoice Management',
                'bind_scan_detect': 'Bind Carrier & Scan Invoice',
                'auto_detect_carbon': 'Auto-detect Carbon Footprint',
                'data_analysis': 'Data Analysis',
                'view_detailed_stats': 'View Detailed Statistics',
                'settings': 'Settings',
                'personalized_settings': 'Personalized Settings',
                'invoice_management_title': 'ğŸ§¾ Invoice Management',
                'e_invoice_carrier': 'ğŸ“± E-Invoice Carrier',
                'carrier_not_bound': 'Carrier Not Bound',
                'sync_carrier_invoices': 'ğŸ”„ Sync Carrier Invoices',
                'auto_sync_status': 'Auto Sync:',
                'sync_enabled': 'Enabled',
                'traditional_invoice_scan': 'ğŸ“· Traditional Invoice Scan',
                'store_placeholder': 'e.g., PX Mart',
                'amount_placeholder': 'e.g., 150',
                'carbon_placeholder': 'Auto-calculated after scan',
                'recent_invoice_records': 'ğŸ“‹ Recent Invoice Records',
                'record_movement_title': 'ğŸš— Record Movement',
                'movement_method': 'Movement Method',
                'driving': 'Driving',
                'walking': 'Walking',
                'cycling': 'Cycling',
                'public_transport': 'Public Transport',
                'distance_km': 'Distance (km)',
                'time_minutes': 'Time (minutes)',
                'record_movement': 'Record Movement',
                'manual_activity_title': 'ğŸƒ Manual Activity Record',
                'activity_type': 'Activity Type',
                'activity_duration': 'Duration (minutes)',
                'activity_intensity': 'Activity Intensity',
                'low_intensity': 'Low Intensity',
                'medium_intensity': 'Medium Intensity',
                'high_intensity': 'High Intensity',
                'record_activity': 'Record Activity',
                'settings_title': 'âš™ï¸ Settings',
                'daily_goal_kg': 'Daily Carbon Goal (kg)',
                'gps_positioning': 'ğŸ“ GPS positioning...',
                'enabled': 'Enabled',
                'disabled': 'Disabled',
                'save_settings': 'Save Settings',
                'gps_status_loading': 'ğŸ”„ GPS positioning...',
                'sensor_loading': 'ğŸ”„ Sensors activating...',
                'auto_tracking_enabled': 'âœ… Automatic tracking enabled',
                'gps_status_checking': 'ğŸ“ GPS status checking...',
                'gps_failed': 'ğŸ“ GPS positioning failed | Please check permissions',
                'distance_placeholder': 'e.g., 5.2',
                'time_placeholder': 'e.g., 30',
                'sync_disabled': 'Disabled',
                'analytics_feature': 'ğŸ“Š Data Analysis Feature',
                'full_version_features': 'In the full version, this will display',
                'historical_trends': 'Historical trend charts',
                'categorized_stats': 'Categorized statistics',
                'eco_suggestions': 'Environmental protection suggestions',
                'goal_achievement': 'Goal achievement status',
                'sensor_enabled': 'âœ… Sensors enabled, continuously monitoring...',
                'sensor_not_supported': 'âŒ Browser does not support sensors',
                'sensor_normal': 'ğŸ“Š Sensors normal (acceleration: {acceleration}m/sÂ²)',
                'sensor_permission_denied': 'âŒ Sensor permission denied, please click "Test Sensor" button',
                'sensor_permission_failed': 'âŒ Sensor permission request failed, please click "Test Sensor" button',
                'gps_success_status': 'ğŸ“ GPS positioning successful | Tracking your movement',
                'gps_success_accuracy': 'âœ… GPS positioning successful (accuracy: {accuracy}m)',
                'auto_tracking_enabled': 'âœ… Automatic tracking function enabled',
                'gps_sensor_monitoring': 'âœ… GPS and sensors enabled, monitoring your carbon footprint',
                'gps_waiting_sensor': 'âš ï¸ GPS enabled, waiting for sensors to be ready',
                'gps_waiting_permission': 'âœ… GPS enabled, waiting for sensor permissions',
                'sensor_label_short': 'Sensors',
                'auto_tracking_label_short': 'Auto Tracking',
                'settings_saved': 'Settings saved!',
                'email_placeholder': 'Please enter your email',
                'feedback_placeholder': 'Tell us your thoughts, suggestions or interesting experiences... (within 150 characters)',
                'confirm': 'OK',
                'auto_tracking': 'Auto Tracking',
                'real_time_analytics': 'Based on your auto-detected data',
                'today_summary': 'Today Summary',
                'today_carbon': 'Today Carbon Footprint (kg)',
                'goal_progress': 'Goal Progress',
                'category_breakdown': 'Category Breakdown',
                'weekly_trends': '7-Day Trends'
            }
        };
        
        // ç•¶å‰èªè¨€
        let currentLanguage = localStorage.getItem('selectedLanguage') || 'zh-TW';
        
        // èªè¨€åˆ‡æ›å‡½æ•¸
        function switchLanguage(lang) {
            console.log('åˆ‡æ›èªè¨€åˆ°:', lang);
            currentLanguage = lang;
            localStorage.setItem('selectedLanguage', lang);
            updateLanguage();
            console.log('èªè¨€åˆ‡æ›å®Œæˆï¼Œç•¶å‰èªè¨€:', currentLanguage);
        }
        
        // æ›´æ–°ç•Œé¢èªè¨€
        function updateLanguage() {
            console.log('æ›´æ–°ç•Œé¢èªè¨€ï¼Œç•¶å‰èªè¨€:', currentLanguage);
            const lang = languages[currentLanguage];
            
            if (!lang) {
                console.error('æ‰¾ä¸åˆ°èªè¨€é…ç½®:', currentLanguage);
                return;
            }
            
            // æ›´æ–°æ‰€æœ‰å¸¶æœ‰ data-lang å±¬æ€§çš„å…ƒç´ 
            const elements = document.querySelectorAll('[data-lang]');
            console.log('æ‰¾åˆ°éœ€è¦æ›´æ–°çš„å…ƒç´ æ•¸é‡:', elements.length);
            
            elements.forEach(element => {
                const key = element.getAttribute('data-lang');
                if (lang[key]) {
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'number')) {
                        element.placeholder = lang[key];
                    } else if (element.tagName === 'TEXTAREA') {
                        element.placeholder = lang[key];
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = lang[key];
                    } else {
                        element.textContent = lang[key];
                    }
                    console.log('æ›´æ–°å…ƒç´ :', key, '->', lang[key]);
                }
            });
            
            // æ›´æ–°æ¨™é¡Œ
            document.title = lang['app_title'];
            console.log('æ›´æ–°æ¨™é¡Œ:', lang['app_title']);
            
            // æ›´æ–°èªè¨€é¸æ“‡å™¨ç‹€æ…‹
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                languageSelect.value = currentLanguage;
                console.log('æ›´æ–°èªè¨€é¸æ“‡å™¨å€¼:', currentLanguage);
            } else {
                console.error('æ‰¾ä¸åˆ°èªè¨€é¸æ“‡å™¨å…ƒç´ ');
            }
        }
        
        // ç²å–ç¿»è­¯æ–‡æœ¬
        function t(key) {
            return languages[currentLanguage][key] || key;
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            /* iPhone Chromeæ»¾å‹•ä¿®å¾© */
            overflow-x: hidden;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            position: relative;
            /* å¼·åˆ¶å•Ÿç”¨ç¡¬é«”åŠ é€Ÿ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            /* iPhone Chromeæ»¾å‹•å„ªåŒ– */
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            position: relative;
            /* å¼·åˆ¶å•Ÿç”¨ç¡¬é«”åŠ é€Ÿ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        /* .header é¡åˆ¥å·²åˆªé™¤ï¼Œä¸å†ä½¿ç”¨ */
        
        .stats-card {
            margin: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .carbon-number {
            font-size: 48px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .carbon-unit {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 62.5%;
            transition: width 0.3s ease;
        }
        
        .goal-text {
            font-size: 14px;
            color: #666;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px;
            min-height: auto;
            position: relative;
            z-index: 10;
        }
        
        .menu-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
            /* æ”¹å–„æ‰‹æ©Ÿè§¸æ§ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .menu-item:hover {
            transform: translateY(-2px);
        }
        
        .menu-item:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .menu-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .menu-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .menu-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* .location-status é¡åˆ¥å·²åˆªé™¤ï¼Œä¸å†ä½¿ç”¨ */
        
        .status-text {
            font-size: 14px;
            color: #1976D2;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            /* æ”¹å–„æ‰‹æ©Ÿè¼¸å…¥é«”é©— */
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* èªè¨€åˆ‡æ›å™¨æ¨£å¼ */
        .language-switcher {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .lang-select {
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: normal;
            color: #4CAF50;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234CAF50' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 10px;
            padding-right: 20px;
            min-width: 45px;
        }
        
        .lang-select:focus {
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .lang-select option {
            background: white;
            color: #333;
            padding: 8px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            /* æ”¹å–„æ‰‹æ©Ÿè§¸æ§ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            min-height: 44px; /* ç¢ºä¿è§¸æ§ç›®æ¨™è¶³å¤ å¤§ */
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .camera-btn {
            background: #FF9800;
        }
        
        .camera-btn:hover {
            background: #F57C00;
        }
        
        .breakdown {
            margin: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
            /* æ”¹å–„æ‰‹æ©Ÿæ»¾å‹• */
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }
        
        .breakdown-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-label {
            font-size: 14px;
        }
        
        .breakdown-value {
            font-weight: 600;
            color: #4CAF50;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- èªè¨€åˆ‡æ›å™¨ -->
    <div class="language-switcher">
        <select class="lang-select" id="languageSelect" onchange="switchLanguage(this.value)">
            <option value="zh-TW">ç¹é«”</option>
            <option value="zh-CN">ç°¡é«”</option>
            <option value="en">EN</option>
        </select>
    </div>
    
    <div class="container">
        <!-- ç¶ è‰²æ¨™é¡Œå¡ç‰‡ï¼Œè²¼è‘—é é¢ä¸Šç·£ -->
        <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 20px; margin: 0; border-radius: 0 0 15px 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative;">
            <!-- LOGOæ”¾åœ¨å·¦ä¸Šè§’ï¼Œé»è‘—é‚Šç•Œ -->
            <img src="ctx-logo.png?v=202509251400" alt="ctx-logo" style="position: absolute; top: 0; left: 0; width: 80px; height: 80px; border-radius: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="position: absolute; top: 0; left: 0; width: 80px; height: 80px; border-radius: 8px; background: #4CAF50; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                ğŸŒ±
            </div>
            <!-- æ¨™é¡Œæ–‡å­—å€åŸŸ -->
            <div style="display: flex; align-items: center; justify-content: center; margin-left: 90px; margin-right: 90px;">
                <div style="text-align: center;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: bold;">
                            <span style="display: inline-block; width: 0; overflow: hidden;">ğŸŒ±</span><span data-lang="app_title">æ¸›ç¢³æ—¥è¨˜</span>
                        </h1>
                        <p style="margin: 5px 0 0 0; font-size: 16px; opacity: 0.9; white-space: nowrap;" data-lang="app_subtitle">è‡ªå‹•åµæ¸¬ç¢³æ’ï¼Œç”Ÿæ´»å°±æ˜¯æ—¥è¨˜</p>
                </div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="carbon-number" id="realTimeCarbon">0.0</div>
            <div class="carbon-unit">å…¬æ–¤ COâ‚‚</div>
            <div class="progress-bar">
                <div class="progress-fill" id="realTimeProgress"></div>
            </div>
            <div class="goal-text" id="realTimeGoal" data-lang="daily_target">ä»Šæ—¥ç›®æ¨™: 20.0 å…¬æ–¤ | å®Œæˆåº¦: 0.0%</div>
            <button onclick="openModal('settings')" style="
                background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                margin-top: 8px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(255,152,0,0.3);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ğŸ¯ è¨­å®šå€‹äººåŒ–ç›®æ¨™
            </button>
        </div>
        
        <div style="margin: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div class="status-text" id="locationStatusText" data-lang="gps_status">GPSå®šä½æˆåŠŸ | æ­£åœ¨è¿½è¹¤æ‚¨çš„ç§»å‹•</div>
        </div>
        
        <div style="margin: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <div style="font-size: 14px; color: #856404;">
                <strong data-lang="realtime_status_title">ğŸ“± å¯¦æ™‚åŠŸèƒ½ç‹€æ…‹ï¼š</strong><br>
                <span id="gpsStatus"></span><br>
                <span id="sensorStatus"></span><br>
                <span id="autoTracking"></span>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong data-lang="status_explanation">ğŸ“‹ ç‹€æ…‹èªªæ˜ï¼š</strong><br>
                â€¢ <strong>GPS</strong>ï¼š<span data-lang="gps_desc">å®šä½æ‚¨çš„ä½ç½®ï¼Œç”¨æ–¼è¨˜éŒ„ç§»å‹•è»Œè·¡</span><br>
                â€¢ <strong data-lang="sensor_label_short">æ„Ÿæ‡‰å™¨</strong>ï¼š<span data-lang="sensor_desc">æª¢æ¸¬æ‰‹æ©Ÿå‹•ä½œï¼Œåˆ¤æ–·äº¤é€šå·¥å…·é¡å‹</span><br>
                â€¢ <strong data-lang="auto_tracking_label_short">è‡ªå‹•è¿½è¹¤</strong>ï¼š<span data-lang="auto_tracking_desc">è‡ªå‹•è¨˜éŒ„ç§»å‹•å’Œç™¼ç¥¨ï¼Œè¨ˆç®—ç¢³è¶³è·¡</span>
            </div>
            <div style="margin-top: 10px; text-align: center; color: #666; font-size: 14px;" id="statusMessage">
                <span>ğŸ“ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½</span>
            </div>
            
            <!-- GPSå’Œæ„Ÿæ‡‰å™¨å•Ÿç”¨æŒ‰éˆ• -->
            <div id="enableBtn" style="display: block; margin: 10px 0;">
                <button onclick="enableGPSAndSensor()" style="
                    background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
                    width: 100%;
                    margin-bottom: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ğŸš€ å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½
                </button>
            </div>
            
            <!-- Chromeå°ˆç”¨GPSæ¬Šé™æŒ‰éˆ• -->
            <div id="chromeGPSButton" style="display: none; margin: 10px 0;">
                <button onclick="requestChromeGPSPermission()" style="
                    background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
                    transition: all 0.3s ease;
                    width: 100%;
                ">
                    ğŸ“ é»æ“Šå•Ÿç”¨Chrome GPSå®šä½
                </button>
            </div>
            
            <div style="margin-top: 10px;">
                <button class="btn" onclick="triggerDailyRecord()" id="dailyRecordBtn" data-lang="daily_record" style="background: #FF9800; color: white; font-size: 12px; padding: 8px; min-height: 36px; width: 100%; border: none; border-radius: 6px; cursor: pointer;">
                    ğŸ•› æ¯æ—¥è¨˜éŒ„
                </button>
            </div>
            
            <div style="margin-top: 10px;">
                <button class="btn" onclick="showFeedbackForm()" data-lang="feedback" style="background: #9C27B0; color: white; font-size: 12px; padding: 8px; min-height: 36px; width: 100%; border: none; border-radius: 6px; cursor: pointer;">
                    ğŸ“ æ„è¦‹åé¥‹
                </button>
            </div>
        </div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="openModal('settings')" style="background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%); color: #4A148C;">
                <div class="menu-icon">âš™ï¸</div>
                <div class="menu-title" data-lang="settings" style="color: white;">è¨­å®š</div>
                <div class="menu-desc" style="color: black;" data-lang="personalized_settings">å€‹äººåŒ–è¨­å®š</div>
            </div>
            
            <div class="menu-item" onclick="openModal('invoice')" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;">
                <div class="menu-icon">ğŸ§¾</div>
                <div class="menu-title" data-lang="invoice_management">ç™¼ç¥¨ç®¡ç†</div>
                <div class="menu-desc" style="color: black;" data-lang="bind_scan_detect">ç¶å®šè¼‰å…· & æƒæç™¼ç¥¨</div>
                <div class="menu-desc" style="color: black; font-size: 12px; margin-top: 2px;" data-lang="auto_detect_carbon">è‡ªå‹•åµæ¸¬ç¢³è¶³è·¡</div>
            </div>
            
            <div class="menu-item" onclick="openModal('movement')" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                <div class="menu-icon">ğŸš—</div>
                <div class="menu-title" data-lang="movement_record">ç§»å‹•è¨˜éŒ„</div>
                <div class="menu-desc" style="color: black;" data-lang="record_transport">è¨˜éŒ„äº¤é€šæ–¹å¼</div>
            </div>
            
            <div class="menu-item" onclick="showAnalytics()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">
                <div class="menu-icon">ğŸ“Š</div>
                <div class="menu-title" data-lang="data_analysis">æ•¸æ“šåˆ†æ</div>
                <div class="menu-desc" style="color: black;" data-lang="view_detailed_stats">æŸ¥çœ‹è©³ç´°çµ±è¨ˆ</div>
            </div>
        </div>
        
        <div class="breakdown">
            <div class="breakdown-title" data-lang="breakdown_title">ä»Šæ—¥ç¢³è¶³è·¡åˆ†è§£ï¼ˆå¯¦æ™‚åµæ¸¬ï¼‰</div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="transport_label">ğŸš— äº¤é€šé‹è¼¸</span>
                <span class="breakdown-value" id="transportCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="shopping_label">ğŸ›’ è³¼ç‰©æ¶ˆè²»</span>
                <span class="breakdown-value" id="shoppingCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="activity_label">ğŸƒ æ´»å‹•åµæ¸¬</span>
                <span class="breakdown-value" id="activityCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="location_label">ğŸ“ ä½ç½®è®ŠåŒ–</span>
                <span class="breakdown-value" id="locationCarbon">0.0 kg</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-label" data-lang="sensor_label">ğŸ“± æ„Ÿæ‡‰å™¨æ•¸æ“š</span>
                <span class="breakdown-value" id="sensorCarbon">0.0 kg</span>
            </div>
        </div>
    </div>
    
    <!-- ç§»å‹•è¨˜éŒ„æ¨¡æ…‹æ¡† -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang="record_movement_title">ğŸš— è¨˜éŒ„ç§»å‹•</h3>
                <button class="close-btn" onclick="closeModal('movementModal')">&times;</button>
            </div>
            <div class="form-group">
                <label data-lang="movement_method">ç§»å‹•æ–¹å¼</label>
                <select id="movementType">
                    <option value="driving" data-lang="driving">é–‹è»Š</option>
                    <option value="walking" data-lang="walking">æ­¥è¡Œ</option>
                    <option value="cycling" data-lang="cycling">é¨è‡ªè¡Œè»Š</option>
                    <option value="public_transport" data-lang="public_transport">å¤§çœ¾é‹è¼¸</option>
                    <option value="flying">é£›æ©Ÿ</option>
                </select>
            </div>
            <div class="form-group">
                <label data-lang="distance_km">è·é›¢ (å…¬é‡Œ)</label>
                <input type="number" id="distance" placeholder="ä¾‹å¦‚: 5.2" step="0.1" data-lang="distance_placeholder">
            </div>
            <div class="form-group">
                <label data-lang="time_minutes">æ™‚é–“ (åˆ†é˜)</label>
                <input type="number" id="duration" placeholder="ä¾‹å¦‚: 30" data-lang="time_placeholder">
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn" onclick="submitMovement()" data-lang="record_movement" style="background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    è¨˜éŒ„ç§»å‹•
                </button>
                <button class="btn" onclick="showManualActivityForm()" data-lang="manual_activity_title" style="background: #FF9800; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    æ‰‹å‹•è¨˜éŒ„æ´»å‹•
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç™¼ç¥¨ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang="invoice_management_title">ğŸ§¾ ç™¼ç¥¨ç®¡ç†</h3>
                <button class="close-btn" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            
            <!-- é›»å­ç™¼ç¥¨è¼‰å…·ç¶å®š -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #4CAF50;">
                <h4 style="margin-bottom: 10px; color: #2e7d32;" data-lang="e_invoice_carrier">ğŸ“± é›»å­ç™¼ç¥¨è¼‰å…·</h4>
                <div id="carrierStatus" style="margin-bottom: 10px;">
                    <span id="carrierInfo" data-lang="carrier_not_bound">æœªç¶å®šè¼‰å…·</span>
                </div>
                <button class="btn" onclick="bindCarrier()" data-lang="bind_carrier" style="background: #4CAF50; margin-bottom: 10px;">
                    ğŸ”— ç¶å®šé›»å­ç™¼ç¥¨è¼‰å…·
                </button>
                <button class="btn" onclick="checkCarrierInvoices()" style="background: #2196F3; margin-bottom: 10px;" data-lang="sync_carrier_invoices">
                    ğŸ”„ åŒæ­¥è¼‰å…·ç™¼ç¥¨
                </button>
                <div id="autoSyncStatus" style="font-size: 12px; color: #666; margin-top: 5px;" data-lang="auto_sync_status">
                    è‡ªå‹•åŒæ­¥: <span id="syncStatus" data-lang="sync_enabled">å·²å•Ÿç”¨</span>
                </div>
            </div>
            
            <!-- å‚³çµ±ç™¼ç¥¨æƒæ -->
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #FF9800;">
                <h4 style="margin-bottom: 10px; color: #e65100;" data-lang="traditional_invoice_scan">ğŸ“· å‚³çµ±ç™¼ç¥¨æƒæ</h4>
                <div class="form-group">
                    <label data-lang="store_name">å•†åº—åç¨±</label>
                    <input type="text" id="storeName" placeholder="ä¾‹å¦‚: å…¨è¯ç¦åˆ©ä¸­å¿ƒ" data-lang="store_placeholder">
                </div>
                <div class="form-group">
                    <label data-lang="amount">æ¶ˆè²»é‡‘é¡</label>
                    <input type="number" id="amount" placeholder="ä¾‹å¦‚: 150" step="0.01" data-lang="amount_placeholder">
                </div>
                <div class="form-group">
                    <label data-lang="carbon_footprint">ç¢³è¶³è·¡</label>
                    <input type="text" id="carbonFootprint" placeholder="æƒæå¾Œè‡ªå‹•è¨ˆç®—" readonly style="background-color: #f8f9fa; color: #4CAF50; font-weight: bold;" data-lang="carbon_placeholder">
                </div>
                <button class="btn camera-btn" onclick="scanInvoice()" data-lang="scan_invoice">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
            </div>
            
            <!-- æœ€è¿‘ç™¼ç¥¨è¨˜éŒ„ -->
            <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;" data-lang="recent_invoice_records">ğŸ“‹ æœ€è¿‘ç™¼ç¥¨è¨˜éŒ„</h4>
                <div id="recentInvoices" style="max-height: 200px; overflow-y: auto;">
                    <div style="padding: 10px; text-align: center; color: #666;">
                        <span data-lang="loading">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-lang="settings_title">âš™ï¸ è¨­å®š</h3>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label data-lang="user_profile">ğŸ‘¤ ç”¨æˆ¶æª”æ¡ˆ</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 14px; font-weight: bold;">å¹´é½¡å±¤ï¼š</label>
                        <select id="ageGroup" onchange="updatePersonalizedGoal()" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="">è«‹é¸æ“‡å¹´é½¡å±¤</option>
                            <option value="18-25">18-25æ­²</option>
                            <option value="26-35">26-35æ­²</option>
                            <option value="36-50">36-50æ­²</option>
                            <option value="51-65">51-65æ­²</option>
                            <option value="65+">65æ­²ä»¥ä¸Š</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 14px; font-weight: bold;">å±…ä½å€åŸŸï¼š</label>
                        <select id="residenceType" onchange="updatePersonalizedGoal()" style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="">è«‹é¸æ“‡å±…ä½å€åŸŸ</option>
                            <option value="urban">éƒ½å¸‚</option>
                            <option value="suburban">éƒŠå€</option>
                            <option value="rural">é„‰æ‘</option>
                        </select>
                    </div>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px;">
                        <div style="font-size: 14px; font-weight: bold; color: #2e7d32;">å€‹äººåŒ–ç›®æ¨™ï¼š</div>
                        <div id="personalizedGoalDisplay" style="font-size: 18px; color: #1b5e20; font-weight: bold;">20.0 å…¬æ–¤ COâ‚‚/å¤©</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">åŸºæ–¼æ‚¨çš„å¹´é½¡å±¤å’Œå±…ä½å€åŸŸèª¿æ•´</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label data-lang="daily_goal_kg">æ¯æ—¥ç¢³è¶³è·¡ç›®æ¨™ (å…¬æ–¤)</label>
                <input type="number" id="dailyGoal" value="20" step="0.1" onchange="updateGoalFromInput()">
                <div style="font-size: 12px; color: #666; margin-top: 5px;">æ‰‹å‹•èª¿æ•´ç›®æ¨™æˆ–ä½¿ç”¨å€‹äººåŒ–å»ºè­°</div>
            </div>
            <div class="form-group">
                <label data-lang="gps_positioning">GPSå®šä½</label>
                <select id="gpsEnabled">
                    <option value="true" data-lang="enabled">å•Ÿç”¨</option>
                    <option value="false" data-lang="disabled">åœç”¨</option>
                </select>
            </div>
            <div class="form-group">
                <label data-lang="auto_tracking">è‡ªå‹•è¿½è¹¤</label>
                <select id="autoTrackingSetting">
                    <option value="true" data-lang="enabled">å•Ÿç”¨</option>
                    <option value="false" data-lang="disabled">åœç”¨</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveSettings()" data-lang="save_settings" style="flex: 1;">å„²å­˜è¨­å®š</button>
                <button class="btn" onclick="testPersonalizedGoal()" style="flex: 1; background: #FF9800; color: white;">æ¸¬è©¦å€‹äººåŒ–ç›®æ¨™</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://172.20.10.6:3002';
        
        // é–‹å•Ÿæ¨¡æ…‹æ¡†
        function openModal(type) {
            if (type === 'movement') {
                document.getElementById('movementModal').style.display = 'block';
            } else if (type === 'invoice') {
                document.getElementById('invoiceModal').style.display = 'block';
            } else if (type === 'settings') {
                document.getElementById('settingsModal').style.display = 'block';
            }
        }
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal(modalIdOrElement) {
            let modal;
            if (typeof modalIdOrElement === 'string') {
                // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç•¶ä½œIDè™•ç†
                modal = document.getElementById(modalIdOrElement);
            } else {
                // å¦‚æœæ˜¯å…ƒç´ ï¼Œç•¶ä½œå…ƒç´ è™•ç†
                modal = modalIdOrElement.closest('.modal');
            }
            
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æäº¤ç§»å‹•è¨˜éŒ„
        async function submitMovement() {
            const type = document.getElementById('movementType').value;
            const distance = parseFloat(document.getElementById('distance').value);
            const duration = parseInt(document.getElementById('duration').value);
            
            if (!distance || !duration) {
                alert('è«‹å¡«å¯«å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/movement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type, distance, duration })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('ç§»å‹•è¨˜éŒ„å·²ä¿å­˜ï¼');
                    closeModal('movementModal');
                    updateStats();
                } else {
                    alert('ä¿å­˜å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                alert('ç¶²çµ¡éŒ¯èª¤ï¼š' + error.message);
            }
        }
        
        // é¡¯ç¤ºæ‰‹å‹•æ´»å‹•è¨˜éŒ„è¡¨å–®
        function showManualActivityForm() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ğŸƒ</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;" data-lang="manual_activity_title">æ‰‹å‹•è¨˜éŒ„æ´»å‹•</h3>
                            <div style="font-size: 14px; opacity: 0.9;">è¨˜éŒ„æ‚¨çš„æ‰‹æ©Ÿç„¡æ³•åµæ¸¬åˆ°çš„æ´»å‹•</div>
                        </div>
                        
                        <form id="manualActivityForm" style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="activity_type">æ´»å‹•é¡å‹</label>
                                <select id="activityType" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                    <option value="running" style="color: black;">è·‘æ­¥</option>
                                    <option value="gym" style="color: black;">å¥èº«æˆ¿</option>
                                    <option value="swimming" style="color: black;">æ¸¸æ³³</option>
                                    <option value="hiking" style="color: black;">ç™»å±±å¥è¡Œ</option>
                                    <option value="basketball" style="color: black;">ç±ƒçƒ</option>
                                    <option value="football" style="color: black;">è¶³çƒ</option>
                                    <option value="tennis" style="color: black;">ç¶²çƒ</option>
                                    <option value="yoga" style="color: black;">ç‘œä¼½</option>
                                    <option value="dancing" style="color: black;">èˆè¹ˆ</option>
                                    <option value="other" style="color: black;">å…¶ä»–é‹å‹•</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="activity_duration">æ´»å‹•æ™‚é•· (åˆ†é˜)</label>
                                <input type="number" id="activityDuration" placeholder="ä¾‹å¦‚: 60" required style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                <style>
                                    #activityDuration::placeholder { color: rgba(255,255,255,0.7); }
                                </style>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="activity_intensity">æ´»å‹•å¼·åº¦</label>
                                <select id="activityIntensity" style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                    <option value="low" style="color: black;">ä½å¼·åº¦ - è¼•é¬†æ´»å‹•</option>
                                    <option value="medium" style="color: black;">ä¸­å¼·åº¦ - é©åº¦é‹å‹•</option>
                                    <option value="high" style="color: black;">é«˜å¼·åº¦ - åŠ‡çƒˆé‹å‹•</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button type="button" onclick="submitManualActivity()" data-lang="record_activity" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    è¨˜éŒ„æ´»å‹•
                                </button>
                                <button type="button" onclick="closeModal(this)" data-lang="cancel" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // æäº¤æ‰‹å‹•æ´»å‹•è¨˜éŒ„
        function submitManualActivity() {
            const activityType = document.getElementById('activityType').value;
            const duration = parseFloat(document.getElementById('activityDuration').value);
            const intensity = document.getElementById('activityIntensity').value;
            
            if (!duration) {
                alert('è«‹å¡«å¯«æ´»å‹•æ™‚é•·');
                return;
            }
            
            // è¨ˆç®—æ´»å‹•ç¢³è¶³è·¡ï¼ˆåŸºæ–¼æ´»å‹•é¡å‹å’Œå¼·åº¦ï¼‰
            let carbonFootprint = 0;
            const baseRate = {
                'running': 0.02,
                'gym': 0.015,
                'swimming': 0.012,
                'hiking': 0.018,
                'basketball': 0.025,
                'football': 0.028,
                'tennis': 0.022,
                'yoga': 0.008,
                'dancing': 0.015,
                'other': 0.015
            };
            
            const intensityMultiplier = {
                'low': 0.8,
                'medium': 1.0,
                'high': 1.3
            };
            
            carbonFootprint = (baseRate[activityType] || 0.015) * duration * intensityMultiplier[intensity];
            
            // è¨˜éŒ„åˆ°ç™¼ç¥¨æ•¸æ“šä¸­
            const activityNames = {
                'running': 'è·‘æ­¥',
                'gym': 'å¥èº«æˆ¿é‹å‹•',
                'swimming': 'æ¸¸æ³³',
                'hiking': 'ç™»å±±å¥è¡Œ',
                'basketball': 'ç±ƒçƒ',
                'football': 'è¶³çƒ',
                'tennis': 'ç¶²çƒ',
                'yoga': 'ç‘œä¼½',
                'dancing': 'èˆè¹ˆ',
                'other': 'å…¶ä»–é‹å‹•'
            };
            
            const invoice = {
                id: Date.now(),
                storeName: activityNames[activityType] || 'é‹å‹•æ´»å‹•',
                amount: duration,
                carbonFootprint: carbonFootprint,
                category: 'activity',
                date: new Date().toISOString(),
                type: 'manual_activity',
                activityType: activityType,
                intensity: intensity
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // æ›´æ–°é¡¯ç¤º
            updateRealTimeDisplay();
            closeModal(document.querySelector('.modal'));
            
            alert(`æ´»å‹•è¨˜éŒ„å·²ä¿å­˜ï¼\n${activityNames[activityType]} ${duration}åˆ†é˜\nç¢³è¶³è·¡ï¼š${carbonFootprint.toFixed(3)} kg COâ‚‚`);
        }
        
        // æƒæç™¼ç¥¨
        async function scanInvoice() {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æŒç›¸æ©Ÿ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒç›¸æ©ŸåŠŸèƒ½ï¼Œè«‹ä½¿ç”¨Chromeæˆ–Safari');
                    return;
                }

                // å‰µå»ºç›¸æ©Ÿæ¨¡æ…‹æ¡†
                const cameraModal = document.createElement('div');
                cameraModal.className = 'modal';
                cameraModal.style.display = 'block';
                cameraModal.innerHTML = `
                    <div class="modal-content" style="max-width: 90%; height: 85vh;">
                        <div class="modal-header">
                            <h3>ğŸ“· é€£çºŒæƒæç™¼ç¥¨</h3>
                            <button class="close-btn" onclick="closeCamera()">&times;</button>
                        </div>
                        <div style="background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 8px; text-align: center;">
                            <div style="color: #4CAF50; font-weight: bold;">ğŸ’¡ é€£çºŒæƒææ¨¡å¼</div>
                            <div style="font-size: 14px; color: #666;">å¯ä»¥é€£çºŒæƒæå¤šå¼µç™¼ç¥¨ï¼Œæ¯å¼µéƒ½æœƒè‡ªå‹•ç´¯è¨ˆç¢³è¶³è·¡</div>
                        </div>
                        <div style="text-align: center; margin: 20px 0;">
                            <video id="cameraVideo" autoplay style="width: 100%; max-width: 400px; border-radius: 8px; border: 2px solid #4CAF50;"></video>
                            <canvas id="cameraCanvas" style="display: none;"></canvas>
                        </div>
                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn" onclick="capturePhoto()" style="background: #4CAF50; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                                ğŸ“· æƒæç™¼ç¥¨
                            </button>
                        </div>
                        <div style="text-align: center; margin: 10px 0;">
                            <button class="btn" onclick="closeCamera()" style="background: #6c757d; color: white; padding: 10px 20px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer;">
                                âœ… å®Œæˆæƒæ
                            </button>
                        </div>
                        <div id="scanResult" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>æƒæçµæœï¼š</h4>
                            <div id="scanText"></div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 8px; font-size: 14px;">
                            <div style="font-weight: bold; margin-bottom: 10px;">ğŸ“‹ æƒææµç¨‹ï¼š</div>
                            <div>â€¢ å°‡ç™¼ç¥¨å°æº–ç›¸æ©Ÿç•«é¢</div>
                            <div>â€¢ é»æ“Šã€ŒğŸ“· æƒæç™¼ç¥¨ã€é€²è¡Œè­˜åˆ¥</div>
                            <div>â€¢ ç³»çµ±è‡ªå‹•åµæ¸¬ç™¼ç¥¨å…§å®¹</div>
                            <div>â€¢ è‡ªå‹•è¨ˆç®—ç¢³è¶³è·¡ä¸¦é¡¯ç¤ºçµæœ</div>
                            <div>â€¢ è‡ªå‹•ç´¯è¨ˆåˆ°ç•¶æ—¥ç¢³è¶³è·¡è¨˜éŒ„</div>
                            <div>â€¢ å¯é€£çºŒæƒæå¤šå¼µç™¼ç¥¨</div>
                            <div>â€¢ å®Œæˆå¾Œé»æ“Šã€Œâœ… å®Œæˆæƒæã€é—œé–‰ç›¸æ©Ÿ</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(cameraModal);

                // é–‹å•Ÿç›¸æ©Ÿ
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // ä½¿ç”¨å¾Œç½®ç›¸æ©Ÿ
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                
                // å„²å­˜streamä»¥ä¾¿å¾ŒçºŒé—œé–‰
                window.cameraStream = stream;
                
            } catch (error) {
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š' + error.message + '\n\nè«‹ç¢ºä¿ï¼š\n1. å…è¨±ç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿ\n2. ä½¿ç”¨HTTPSæˆ–localhost\n3. ä½¿ç”¨Chromeæˆ–Safariç€è¦½å™¨');
            }
        }
        
        // æƒæç™¼ç¥¨ï¼ˆé€£çºŒæƒææ¨¡å¼ï¼‰
        async function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­ç½®canvaså°ºå¯¸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ç¹ªè£½è¦–é »å¹€åˆ°canvas
            ctx.drawImage(video, 0, 0);
            
            // ç²å–åœ–ç‰‡æ•¸æ“š
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // é¡¯ç¤ºæƒæä¸­æŒ‡ç¤ºå™¨
            showScanningIndicator();
            
            try {
                // æ¨¡æ“¬OCRè­˜åˆ¥ç™¼ç¥¨å…§å®¹
                const invoiceData = await analyzeInvoice(imageData);
                
                // ç§»é™¤æƒæä¸­æŒ‡ç¤ºå™¨
                hideScanningIndicator();
                
                // è¨ˆç®—ç¢³è¶³è·¡
                const carbonFootprint = calculateInvoiceCarbonFootprint(invoiceData);
                
                // è‡ªå‹•å¡«å…¥è¡¨å–®
                fillInvoiceForm(invoiceData, carbonFootprint);
                
                // è‡ªå‹•è¨˜éŒ„åˆ°ç•¶æ—¥ç¢³è¶³è·¡è¨˜éŒ„
                await recordInvoiceToDaily(invoiceData, carbonFootprint);
                
                // é¡¯ç¤ºç´¯è¨ˆæˆåŠŸé€šçŸ¥
                showAccumulationNotification(invoiceData, carbonFootprint);
                
            } catch (error) {
                // ç§»é™¤æƒæä¸­æŒ‡ç¤ºå™¨
                hideScanningIndicator();
                
                // å¦‚æœè‡ªå‹•è­˜åˆ¥å¤±æ•—ï¼Œé¡¯ç¤ºæ‰‹å‹•è¼¸å…¥é¸é …
                showManualInputOption(imageData);
            }
        }
        
        // é¡¯ç¤ºæƒæä¸­æŒ‡ç¤ºå™¨
        function showScanningIndicator() {
            // ç§»é™¤ç¾æœ‰çš„æŒ‡ç¤ºå™¨
            hideScanningIndicator();
            
            const indicator = document.createElement('div');
            indicator.id = 'scanningIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                z-index: 10000;
                font-size: 16px;
            `;
            indicator.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
                <div>ğŸ” æ­£åœ¨åˆ†æç™¼ç¥¨...</div>
                <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">è«‹ä¿æŒç›¸æ©Ÿç©©å®š</div>
            `;
            document.body.appendChild(indicator);
        }
        
        // éš±è—æƒæä¸­æŒ‡ç¤ºå™¨
        function hideScanningIndicator() {
            const indicator = document.getElementById('scanningIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // é¡¯ç¤ºæƒæçµæœå’Œç¢³è¶³è·¡
        function showScanResult(invoiceData, carbonFootprint) {
            const resultModal = document.createElement('div');
            resultModal.id = 'scanResultModal';
            resultModal.className = 'modal';
            resultModal.style.display = 'block';
            resultModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>ğŸ“· æƒæçµæœ</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #4CAF50; margin-bottom: 10px;">ğŸ“‹ ç™¼ç¥¨ä¿¡æ¯</h4>
                            <div style="margin-bottom: 8px;">
                                <strong>å•†åº—ï¼š</strong>${invoiceData.storeName}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>é‡‘é¡ï¼š</strong>NT$ ${invoiceData.amount.toFixed(2)}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>å•†å“ï¼š</strong>${invoiceData.items.join(', ')}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>è­˜åˆ¥ä¿¡å¿ƒåº¦ï¼š</strong>${(invoiceData.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">ğŸŒ± ç¢³è¶³è·¡è¨ˆç®—</h4>
                            <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                                ${carbonFootprint.toFixed(2)} kg COâ‚‚
                            </div>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; text-align: center; font-size: 14px; color: #1976d2;">
                            ğŸ’¡ å·²è‡ªå‹•ç´¯è¨ˆåˆ°ä»Šæ—¥ç¢³è¶³è·¡è¨˜éŒ„
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn" onclick="this.closest('.modal').remove()">ç¹¼çºŒæƒæ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(resultModal);
            
            // 5ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                if (resultModal.parentNode) {
                    resultModal.remove();
                }
            }, 5000);
        }
        
        // é¡¯ç¤ºç´¯è¨ˆæˆåŠŸé€šçŸ¥
        function showAccumulationNotification(invoiceData, carbonFootprint) {
            const notification = document.createElement('div');
            notification.id = 'accumulationNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 20px;">âœ…</div>
                    <div>
                        <div style="font-weight: bold;">æƒææˆåŠŸï¼</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                            ${invoiceData.storeName}
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            NT$ ${invoiceData.amount.toFixed(2)} â†’ ${carbonFootprint.toFixed(2)} kg COâ‚‚
                        </div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                            å·²ç´¯è¨ˆåˆ°ä»Šæ—¥è¨˜éŒ„
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // 4ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }
        
        // è‡ªå‹•å¡«å…¥ç™¼ç¥¨è¡¨å–®
        function fillInvoiceForm(invoiceData, carbonFootprint) {
            // å¡«å…¥å•†åº—åç¨±
            const storeNameInput = document.getElementById('storeName');
            if (storeNameInput) {
                storeNameInput.value = invoiceData.storeName;
            }
            
            // å¡«å…¥æ¶ˆè²»é‡‘é¡
            const amountInput = document.getElementById('amount');
            if (amountInput) {
                amountInput.value = invoiceData.amount.toFixed(2);
            }
            
            // å¡«å…¥ç¢³è¶³è·¡
            const carbonInput = document.getElementById('carbonFootprint');
            if (carbonInput) {
                carbonInput.value = `${carbonFootprint.toFixed(2)} kg COâ‚‚`;
            }
            
            console.log('âœ… è¡¨å–®å·²è‡ªå‹•å¡«å…¥:', {
                store: invoiceData.storeName,
                amount: invoiceData.amount,
                carbon: carbonFootprint
            });
        }
        
        // è¨˜éŒ„ç™¼ç¥¨åˆ°æ¯æ—¥ç¢³è¶³è·¡è¨˜éŒ„
        async function recordInvoiceToDaily(invoiceData, carbonFootprint) {
            try {
                // å‰µå»ºç™¼ç¥¨è¨˜éŒ„
                const invoice = {
                    id: 'inv_' + Date.now(),
                    storeName: invoiceData.storeName,
                    amount: invoiceData.amount,
                    date: new Date().toISOString(),
                    items: invoiceData.items,
                    carbonFootprint: carbonFootprint,
                    source: 'camera_scan',
                    confidence: invoiceData.confidence
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
                const existingInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                existingInvoices.unshift(invoice);
                localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                
                // æ›´æ–°æ¯æ—¥ç¢³è¶³è·¡è¨˜éŒ„
                updateDailyCarbonRecord(carbonFootprint);
                
                // æ›´æ–°å¯¦æ™‚æ•¸æ“š
                realTimeData.shopping += carbonFootprint;
                updateRealTimeDisplay();
                
                // é‡æ–°è¼‰å…¥ç™¼ç¥¨è¨˜éŒ„
                loadRecentInvoices();
                
                console.log('âœ… ç™¼ç¥¨å·²è¨˜éŒ„åˆ°æ¯æ—¥ç¢³è¶³è·¡:', {
                    store: invoiceData.storeName,
                    amount: invoiceData.amount,
                    carbon: carbonFootprint,
                    totalToday: realTimeData.shopping
                });
                
            } catch (error) {
                console.error('âŒ è¨˜éŒ„ç™¼ç¥¨åˆ°æ¯æ—¥ç¢³è¶³è·¡å¤±æ•—:', error);
                alert('âŒ ç™¼ç¥¨è¨˜éŒ„å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }
        
        // åˆ†æç™¼ç¥¨ï¼ˆçœŸå¯¦OCRåŠŸèƒ½ï¼‰
        async function analyzeInvoice(imageData) {
            // å¯¦éš›è™•ç†æ™‚é–“
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // èª¿ç”¨çœŸå¯¦OCR APIï¼ˆéœ€è¦å¾Œç«¯æœå‹™ï¼‰
            try {
                const response = await fetch('http://localhost:3001/api/ocr/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageData: imageData })
                });
                
                if (!response.ok) {
                    throw new Error('OCR APIèª¿ç”¨å¤±æ•—');
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('âŒ OCRè­˜åˆ¥å¤±æ•—:', error);
                throw new Error('ç„¡æ³•è­˜åˆ¥ç™¼ç¥¨å…§å®¹ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–é‡è©¦');
            }
        }
        
        
        // è¨ˆç®—ç™¼ç¥¨ç¢³è¶³è·¡
        function calculateInvoiceCarbonFootprint(invoiceData) {
            let baseCarbon = invoiceData.amount * 0.01; // åŸºç¤ç¢³è¶³è·¡ï¼šé‡‘é¡çš„1%
            
            // æ ¹æ“šå•†åº—é¡å‹èª¿æ•´ç¢³è¶³è·¡ä¿‚æ•¸
            const storeTypeMultiplier = {
                'å…¨è¯ç¦åˆ©ä¸­å¿ƒ': 0.8,  // è¶…å¸‚ï¼Œç›¸å°ç’°ä¿
                'å®¶æ¨‚ç¦': 0.8,
                '7-ELEVEN': 1.2,     // ä¾¿åˆ©å•†åº—ï¼ŒåŒ…è£è¼ƒå¤š
                'å±ˆè‡£æ°': 1.1,       // è—¥å¦åº—
                'æ˜Ÿå·´å…‹': 1.5,       // å’–å•¡åº—ï¼Œå¤–å¸¶åŒ…è£
                'éº¥ç•¶å‹': 1.3,       // é€Ÿé£Ÿåº—
                'è‚¯å¾·åŸº': 1.3
            };
            
            // æ ¹æ“šå•†å“é¡å‹èª¿æ•´
            const itemTypeMultiplier = {
                'ç‰›å¥¶': 1.2,         // ä¹³è£½å“ç¢³è¶³è·¡è¼ƒé«˜
                'è‚‰é¡': 1.5,         // è‚‰é¡ç¢³è¶³è·¡æœ€é«˜
                'è”¬èœ': 0.6,         // è”¬èœç›¸å°ç’°ä¿
                'æ°´æœ': 0.7,
                'å’–å•¡': 1.3,         // å’–å•¡ç¨®æ¤å’Œé‹è¼¸
                'éºµåŒ…': 0.9,
                'æ—¥ç”¨å“': 1.0
            };
            
            // æ‡‰ç”¨å•†åº—é¡å‹ä¿‚æ•¸
            for (const store in storeTypeMultiplier) {
                if (invoiceData.storeName.includes(store)) {
                    baseCarbon *= storeTypeMultiplier[store];
                    break;
                }
            }
            
            // æ‡‰ç”¨å•†å“é¡å‹ä¿‚æ•¸
            let itemMultiplier = 1.0;
            for (const item of invoiceData.items) {
                for (const type in itemTypeMultiplier) {
                    if (item.includes(type)) {
                        itemMultiplier = Math.max(itemMultiplier, itemTypeMultiplier[type]);
                    }
                }
            }
            baseCarbon *= itemMultiplier;
            
            return Math.max(baseCarbon, 0.01); // æœ€å°0.01kg
        }
        
        // é¡¯ç¤ºæ‰‹å‹•è¼¸å…¥é¸é …ï¼ˆä¸é—œé–‰ç›¸æ©Ÿï¼‰
        function showManualInputOption(imageData) {
            const manualModal = document.createElement('div');
            manualModal.className = 'modal';
            manualModal.style.display = 'block';
            manualModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>ğŸ“· æ‰‹å‹•è¼¸å…¥ç™¼ç¥¨</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <div style="color: #856404; font-size: 14px;">âš ï¸ è‡ªå‹•è­˜åˆ¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç™¼ç¥¨ä¿¡æ¯</div>
                        </div>
                        <div class="form-group">
                            <label>å•†åº—åç¨±</label>
                            <input type="text" id="manualStoreName" placeholder="ä¾‹å¦‚: å…¨è¯ç¦åˆ©ä¸­å¿ƒ">
                        </div>
                        <div class="form-group">
                            <label>æ¶ˆè²»é‡‘é¡</label>
                            <input type="number" id="manualAmount" placeholder="ä¾‹å¦‚: 150" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>å•†å“é …ç›®ï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="manualItems" placeholder="ä¾‹å¦‚: ç‰›å¥¶, éºµåŒ…, æ°´æœ">
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn" onclick="submitManualInvoice()">ç¢ºèªè¨˜éŒ„</button>
                        <button class="btn" style="background: #6c757d; margin-left: 10px;" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(manualModal);
        }
        
        // æäº¤æ‰‹å‹•è¼¸å…¥çš„ç™¼ç¥¨
        async function submitManualInvoice() {
            const storeName = document.getElementById('manualStoreName').value;
            const amount = parseFloat(document.getElementById('manualAmount').value);
            const itemsText = document.getElementById('manualItems').value;
            
            if (!storeName || !amount) {
                alert('è«‹å¡«å¯«å•†åº—åç¨±å’Œæ¶ˆè²»é‡‘é¡');
                return;
            }
            
            const items = itemsText ? itemsText.split(',').map(item => item.trim()) : [];
            
            const invoiceData = {
                storeName: storeName,
                amount: amount,
                items: items,
                confidence: 1.0 // æ‰‹å‹•è¼¸å…¥ï¼Œä¿¡å¿ƒåº¦100%
            };
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            document.querySelector('.modal').remove();
            
            // è¨ˆç®—ç¢³è¶³è·¡
            const carbonFootprint = calculateInvoiceCarbonFootprint(invoiceData);
            
            // è‡ªå‹•å¡«å…¥è¡¨å–®
            fillInvoiceForm(invoiceData, carbonFootprint);
            
            // è¨˜éŒ„åˆ°æ¯æ—¥ç¢³è¶³è·¡
            await recordInvoiceToDaily(invoiceData, carbonFootprint);
            
            // é¡¯ç¤ºç´¯è¨ˆé€šçŸ¥
            showAccumulationNotification(invoiceData, carbonFootprint);
        }
        
        // æ›´æ–°æ¯æ—¥ç¢³è¶³è·¡è¨˜éŒ„
        function updateDailyCarbonRecord(carbonFootprint) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            if (!dailyRecords[today]) {
                dailyRecords[today] = {
                    date: today,
                    totalCarbon: 0,
                    shopping: 0,
                    transport: 0,
                    activity: 0,
                    other: 0,
                    invoiceCount: 0
                };
            }
            
            // æ›´æ–°ä»Šæ—¥è¨˜éŒ„
            dailyRecords[today].totalCarbon += carbonFootprint;
            dailyRecords[today].shopping += carbonFootprint;
            dailyRecords[today].invoiceCount += 1;
            
            // æ¸…ç†è¶…éåŠå¹´çš„æ•¸æ“š
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const cutoffDate = sixMonthsAgo.toISOString().split('T')[0];
            
            Object.keys(dailyRecords).forEach(date => {
                if (date < cutoffDate) {
                    delete dailyRecords[date];
                }
            });
            
            // ä¿å­˜æ›´æ–°å¾Œçš„è¨˜éŒ„
            localStorage.setItem('dailyCarbonRecords', JSON.stringify(dailyRecords));
            
            // æ›´æ–°æ¯æ—¥çµ±è¨ˆé¡¯ç¤º
            updateDailyStatsDisplay();
        }
        
        // æ›´æ–°æ¯æ—¥çµ±è¨ˆé¡¯ç¤º
        function updateDailyStatsDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const todayRecord = dailyRecords[today];
            
            if (todayRecord) {
                // æ›´æ–°å¯¦æ™‚é¡¯ç¤ºä¸­çš„ä»Šæ—¥ç¸½è¨ˆ
                const totalTodayElement = document.getElementById('totalToday');
                if (totalTodayElement) {
                    totalTodayElement.textContent = todayRecord.totalCarbon.toFixed(2);
                }
                
                // æ›´æ–°ä»Šæ—¥ç™¼ç¥¨æ•¸é‡
                const invoiceCountElement = document.getElementById('invoiceCount');
                if (invoiceCountElement) {
                    invoiceCountElement.textContent = todayRecord.invoiceCount;
                }
            }
        }
        
        // ç²å–æ¯æ—¥ç¢³è¶³è·¡çµ±è¨ˆ
        function getDailyCarbonStats(days = 7) {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const dates = Object.keys(dailyRecords).sort().slice(-days);
            
            return dates.map(date => ({
                date: date,
                totalCarbon: dailyRecords[date].totalCarbon,
                shopping: dailyRecords[date].shopping,
                transport: dailyRecords[date].transport,
                activity: dailyRecords[date].activity,
                invoiceCount: dailyRecords[date].invoiceCount
            }));
        }
        
        // ç²å–æœˆåº¦ç¢³è¶³è·¡çµ±è¨ˆ
        function getMonthlyCarbonStats() {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const monthlyStats = {};
            
            Object.values(dailyRecords).forEach(record => {
                const month = record.date.substring(0, 7); // YYYY-MM
                if (!monthlyStats[month]) {
                    monthlyStats[month] = {
                        month: month,
                        totalCarbon: 0,
                        shopping: 0,
                        transport: 0,
                        activity: 0,
                        invoiceCount: 0,
                        dayCount: 0
                    };
                }
                
                monthlyStats[month].totalCarbon += record.totalCarbon;
                monthlyStats[month].shopping += record.shopping;
                monthlyStats[month].transport += record.transport;
                monthlyStats[month].activity += record.activity;
                monthlyStats[month].invoiceCount += record.invoiceCount;
                monthlyStats[month].dayCount += 1;
            });
            
            return Object.values(monthlyStats).sort((a, b) => a.month.localeCompare(b.month));
        }
        
        // è¨­ç½®æ¯æ—¥24:00è‡ªå‹•è¨˜éŒ„
        function setupDailyAutoRecord() {
            // è¨ˆç®—åˆ°ä»Šæ™š24:00çš„æ¯«ç§’æ•¸
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0); // è¨­ç½®åˆ°ä»Šæ™š24:00
            
            const timeUntilMidnight = midnight.getTime() - now.getTime();
            
            console.log('â° è¨­ç½®æ¯æ—¥è‡ªå‹•è¨˜éŒ„ï¼Œè·é›¢ä¸‹æ¬¡è¨˜éŒ„é‚„æœ‰:', Math.round(timeUntilMidnight / 1000 / 60), 'åˆ†é˜');
            
            // è¨­ç½®å®šæ™‚å™¨åˆ°ä»Šæ™š24:00
            setTimeout(() => {
                performDailyAutoRecord();
                
                // è¨­ç½®æ¯æ—¥é‡è¤‡çš„å®šæ™‚å™¨ï¼ˆæ¯24å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼‰
                setInterval(performDailyAutoRecord, 24 * 60 * 60 * 1000);
                
            }, timeUntilMidnight);
        }
        
        // åŸ·è¡Œæ¯æ—¥è‡ªå‹•è¨˜éŒ„
        function performDailyAutoRecord() {
            console.log('ğŸ•› åŸ·è¡Œæ¯æ—¥24:00è‡ªå‹•è¨˜éŒ„...');
            
            const today = new Date().toISOString().split('T')[0];
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            // ç¢ºä¿ä»Šæ—¥è¨˜éŒ„å­˜åœ¨
            if (!dailyRecords[today]) {
                dailyRecords[today] = {
                    date: today,
                    totalCarbon: 0,
                    shopping: 0,
                    transport: 0,
                    activity: 0,
                    other: 0,
                    invoiceCount: 0
                };
            }
            
            // å¾å¯¦æ™‚æ•¸æ“šä¸­ç²å–ä»Šæ—¥ç´¯è¨ˆçš„ç¢³è¶³è·¡
            const todayRecord = dailyRecords[today];
            
            // æ›´æ–°ä»Šæ—¥è¨˜éŒ„ï¼ˆå¦‚æœå¯¦æ™‚æ•¸æ“šæœ‰æ›´æ–°ï¼‰
            todayRecord.totalCarbon = realTimeData.shopping + realTimeData.transport + realTimeData.activity + realTimeData.sensor + realTimeData.location;
            todayRecord.shopping = realTimeData.shopping;
            todayRecord.transport = realTimeData.transport;
            todayRecord.activity = realTimeData.activity;
            todayRecord.other = realTimeData.sensor + realTimeData.location;
            
            // è¨ˆç®—ä»Šæ—¥ç™¼ç¥¨æ•¸é‡
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const todayInvoices = invoices.filter(inv => 
                new Date(inv.date).toISOString().split('T')[0] === today
            );
            todayRecord.invoiceCount = todayInvoices.length;
            
            // ä¿å­˜æ›´æ–°å¾Œçš„è¨˜éŒ„
            dailyRecords[today] = todayRecord;
            localStorage.setItem('dailyCarbonRecords', JSON.stringify(dailyRecords));
            
            // æ¸…ç†è¶…éåŠå¹´çš„æ•¸æ“š
            cleanupOldRecords();
            
            // é¡¯ç¤ºæ¯æ—¥è¨˜éŒ„å®Œæˆé€šçŸ¥
            showDailyRecordNotification(todayRecord);
            
            // é‡ç½®å¯¦æ™‚æ•¸æ“šï¼ˆç‚ºæ–°çš„ä¸€å¤©åšæº–å‚™ï¼‰
            resetRealTimeDataForNewDay();
            
            console.log('âœ… æ¯æ—¥è‡ªå‹•è¨˜éŒ„å®Œæˆ:', todayRecord);
        }
        
        // æ¸…ç†è¶…éåŠå¹´çš„æ•¸æ“š
        function cleanupOldRecords() {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const cutoffDate = sixMonthsAgo.toISOString().split('T')[0];
            
            let deletedCount = 0;
            Object.keys(dailyRecords).forEach(date => {
                if (date < cutoffDate) {
                    delete dailyRecords[date];
                    deletedCount++;
                }
            });
            
            if (deletedCount > 0) {
                localStorage.setItem('dailyCarbonRecords', JSON.stringify(dailyRecords));
                console.log(`ğŸ—‘ï¸ æ¸…ç†äº† ${deletedCount} å¤©çš„èˆŠæ•¸æ“šï¼ˆè¶…é6å€‹æœˆï¼‰`);
            }
        }
        
        // é¡¯ç¤ºæ¯æ—¥è¨˜éŒ„å®Œæˆé€šçŸ¥
        function showDailyRecordNotification(todayRecord) {
            // å‰µå»ºé€šçŸ¥æ¨¡æ…‹æ¡†
            const notificationModal = document.createElement('div');
            notificationModal.className = 'modal';
            notificationModal.style.display = 'block';
            notificationModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>ğŸ•› æ¯æ—¥è¨˜éŒ„å®Œæˆ</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
                            <h4 style="color: #4CAF50; margin: 0;" data-lang="daily_stats_title">ä»Šæ—¥ç¢³è¶³è·¡çµ±è¨ˆ</h4>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_shopping">ğŸ›’ è³¼ç‰©æ¶ˆè²»:</span>
                                <strong>${todayRecord.shopping.toFixed(2)} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_transport">ğŸš— äº¤é€šç§»å‹•:</span>
                                <strong>${todayRecord.transport.toFixed(2)} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_activity">ğŸƒ æ´»å‹•æ„Ÿæ‡‰:</span>
                                <strong>${todayRecord.activity.toFixed(2)} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span data-lang="daily_other">ğŸ“± å…¶ä»–ä¾†æº:</span>
                                <strong>${todayRecord.other.toFixed(2)} kg</strong>
                            </div>
                            <hr style="margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #4CAF50;">
                                <span data-lang="daily_invoice_count">ğŸ“‹ ç™¼ç¥¨æ•¸é‡:</span>
                                <strong>${todayRecord.invoiceCount} å¼µ</strong>
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">ğŸŒ± ä»Šæ—¥ç¸½ç¢³è¶³è·¡</h4>
                            <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                                ${todayRecord.totalCarbon.toFixed(2)} kg COâ‚‚
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                            ğŸ’¡ æ•¸æ“šå·²è‡ªå‹•ä¿å­˜ï¼Œæ–°çš„ä¸€å¤©é–‹å§‹äº†ï¼
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <button class="btn" onclick="this.closest('.modal').remove()">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notificationModal);
            
            // 5ç§’å¾Œè‡ªå‹•é—œé–‰é€šçŸ¥
            setTimeout(() => {
                if (notificationModal.parentNode) {
                    notificationModal.remove();
                }
            }, 5000);
        }
        
        // é‡ç½®å¯¦æ™‚æ•¸æ“šç‚ºæ–°çš„ä¸€å¤©åšæº–å‚™
        function resetRealTimeDataForNewDay() {
            // é‡ç½®å¯¦æ™‚æ•¸æ“š
            realTimeData = {
                shopping: 0,
                transport: 0,
                activity: 0,
                sensor: 0,
                location: 0
            };
            
            // æ›´æ–°é¡¯ç¤º
            updateRealTimeDisplay();
            
            console.log('ğŸ”„ å¯¦æ™‚æ•¸æ“šå·²é‡ç½®ï¼Œæº–å‚™æ–°çš„ä¸€å¤©');
        }
        
        // æ¨¡æ“¬OCRè­˜åˆ¥ï¼ˆä¿ç•™èˆŠå‡½æ•¸ä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰
        function simulateOCR() {
            const stores = ['å…¨è¯ç¦åˆ©ä¸­å¿ƒ', '7-ELEVEN', 'å®¶æ¨‚ç¦', 'Costco', 'å¤§æ½¤ç™¼'];
            const amounts = [85.5, 120.0, 250.0, 180.0, 95.0];
            
            const randomStore = stores[Math.floor(Math.random() * stores.length)];
            const randomAmount = amounts[Math.floor(Math.random() * amounts.length)];
            
            return `
                <p><strong>å•†åº—ï¼š</strong>${randomStore}</p>
                <p><strong>é‡‘é¡ï¼š</strong>NT$ ${randomAmount}</p>
                <p><strong>æ—¥æœŸï¼š</strong>${new Date().toLocaleDateString()}</p>
                <p><strong>ç‹€æ…‹ï¼š</strong>âœ… è­˜åˆ¥æˆåŠŸ</p>
                <button class="btn" onclick="useScanResult('${randomStore}', ${randomAmount})" style="margin-top: 10px;">
                    ä½¿ç”¨æ­¤çµæœ
                </button>
            `;
        }
        
        // ä½¿ç”¨æƒæçµæœ
        function useScanResult(storeName, amount) {
            document.getElementById('storeName').value = storeName;
            document.getElementById('amount').value = amount;
            closeCamera();
            alert('âœ… ç™¼ç¥¨ä¿¡æ¯å·²è‡ªå‹•å¡«å…¥ï¼');
        }
        
        // é—œé–‰ç›¸æ©Ÿ
        function closeCamera() {
            if (window.cameraStream) {
                window.cameraStream.getTracks().forEach(track => track.stop());
                window.cameraStream = null;
            }
            // ä½¿ç”¨çµ±ä¸€çš„é—œé–‰é‚è¼¯
            const cameraModal = document.querySelector('.modal:last-child');
            if (cameraModal) {
                cameraModal.style.display = 'none';
            }
        }
        
        // é›»å­ç™¼ç¥¨è¼‰å…·åŠŸèƒ½
        let carrierInfo = null;
        let autoSyncEnabled = true;
        
        // ç¶å®šé›»å­ç™¼ç¥¨è¼‰å…·
        function bindCarrier() {
            const carrierModal = document.createElement('div');
            carrierModal.className = 'modal';
            carrierModal.style.display = 'block';
            carrierModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ğŸ”— ç¶å®šé›»å­ç™¼ç¥¨è¼‰å…·</h3>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div style="background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 8px; text-align: center;">
                        <div style="color: #4CAF50; font-weight: bold;">ğŸ’¡ ç¶å®šå¾Œè‡ªå‹•åµæ¸¬</div>
                        <div style="font-size: 14px; color: #666;">ç¶å®šå¾Œåœ¨ä¾¿åˆ©åº—æ¶ˆè²»æ™‚æœƒè‡ªå‹•åµæ¸¬ç™¼ç¥¨å…§å®¹ä¸¦è¨ˆç®—ç¢³è¶³è·¡</div>
                    </div>
                    <div class="form-group">
                        <label>è¼‰å…·é¡å‹</label>
                        <select id="carrierType">
                            <option value="mobile">æ‰‹æ©Ÿæ¢ç¢¼</option>
                            <option value="citizen">è‡ªç„¶äººæ†‘è­‰</option>
                            <option value="love">æ„›å¿ƒç¢¼</option>
                            <option value="company">å…¬å¸çµ±ç·¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¼‰å…·è™Ÿç¢¼/æ¢ç¢¼</label>
                        <input type="text" id="carrierCode" placeholder="è«‹è¼¸å…¥è¼‰å…·è™Ÿç¢¼æˆ–æ¢ç¢¼">
                    </div>
                    <div class="form-group">
                        <label>è¼‰å…·åç¨±ï¼ˆå¯é¸ï¼‰</label>
                        <input type="text" id="carrierName" placeholder="ä¾‹å¦‚: æˆ‘çš„æ‰‹æ©Ÿæ¢ç¢¼">
                    </div>
                    <button class="btn" onclick="saveCarrier()" style="background: #4CAF50;">
                        ğŸ’¾ ä¿å­˜è¼‰å…·
                    </button>
                    <button class="btn" onclick="scanCarrierQR()" style="background: #FF9800; margin-top: 10px;">
                        ğŸ“· æƒæè¼‰å…·æ¢ç¢¼
                    </button>
                </div>
            `;
            document.body.appendChild(carrierModal);
        }
        
        // æƒæè¼‰å…·æ¢ç¢¼
        function scanCarrierQR() {
            alert('ğŸ“· è¼‰å…·æ¢ç¢¼æƒæåŠŸèƒ½\n\nåœ¨å®Œæ•´ç‰ˆæœ¬ä¸­ï¼Œé€™è£¡æœƒé–‹å•Ÿç›¸æ©Ÿæƒæé›»å­ç™¼ç¥¨è¼‰å…·æ¢ç¢¼\n\næ¨¡æ“¬æƒæçµæœï¼š\nè¼‰å…·é¡å‹ï¼šæ‰‹æ©Ÿæ¢ç¢¼\nè¼‰å…·è™Ÿç¢¼ï¼š/ABC1234');
            
            // æ¨¡æ“¬æƒæçµæœ
            document.getElementById('carrierType').value = 'mobile';
            document.getElementById('carrierCode').value = '/ABC1234';
            document.getElementById('carrierName').value = 'æˆ‘çš„æ‰‹æ©Ÿæ¢ç¢¼';
        }
        
        // ä¿å­˜è¼‰å…·
        function saveCarrier() {
            const type = document.getElementById('carrierType').value;
            const code = document.getElementById('carrierCode').value;
            const name = document.getElementById('carrierName').value;
            
            if (!code) {
                alert('è«‹è¼¸å…¥è¼‰å…·è™Ÿç¢¼');
                return;
            }
            
            carrierInfo = {
                type: type,
                code: code,
                name: name || 'æˆ‘çš„è¼‰å…·',
                bindTime: new Date().toISOString(),
                autoDetectEnabled: true // å•Ÿç”¨è‡ªå‹•åµæ¸¬
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('carrierInfo', JSON.stringify(carrierInfo));
            
            updateCarrierStatus();
            closeCarrierModal();
            
            // å•Ÿå‹•è‡ªå‹•åµæ¸¬åŠŸèƒ½
            startAutoInvoiceDetection();
            
            alert('âœ… è¼‰å…·ç¶å®šæˆåŠŸï¼\n\nè¼‰å…·åç¨±ï¼š' + carrierInfo.name + '\nè¼‰å…·è™Ÿç¢¼ï¼š' + carrierInfo.code + '\n\nğŸ’¡ å·²å•Ÿç”¨è‡ªå‹•åµæ¸¬åŠŸèƒ½ï¼Œä¾¿åˆ©åº—æ¶ˆè²»æ™‚æœƒè‡ªå‹•åµæ¸¬ç™¼ç¥¨å…§å®¹ä¸¦è¨ˆç®—ç¢³è¶³è·¡');
        }
        
        // å•Ÿå‹•è‡ªå‹•ç™¼ç¥¨åµæ¸¬åŠŸèƒ½
        function startAutoInvoiceDetection() {
            console.log('ğŸš€ å•Ÿå‹•è‡ªå‹•ç™¼ç¥¨åµæ¸¬åŠŸèƒ½...');
            
            // æ¨¡æ“¬å®šæœŸæª¢æŸ¥æ–°ç™¼ç¥¨ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æœƒèª¿ç”¨é›»å­ç™¼ç¥¨APIï¼‰
            setInterval(async () => {
                if (carrierInfo && carrierInfo.autoDetectEnabled) {
                    await checkForNewInvoices();
                }
            }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
            
            console.log('âœ… è‡ªå‹•ç™¼ç¥¨åµæ¸¬å·²å•Ÿå‹•ï¼Œæ¯30ç§’æª¢æŸ¥ä¸€æ¬¡æ–°ç™¼ç¥¨');
        }
        
        // æª¢æŸ¥æ–°ç™¼ç¥¨
        async function checkForNewInvoices() {
            try {
                // èª¿ç”¨çœŸå¯¦APIæª¢æŸ¥æ–°ç™¼ç¥¨
                const newInvoices = await checkNewInvoices();
                
                if (newInvoices && newInvoices.length > 0) {
                    console.log('ğŸ“‹ ç™¼ç¾æ–°ç™¼ç¥¨:', newInvoices.length, 'å¼µ');
                    
                    for (const invoiceData of newInvoices) {
                        // è¨ˆç®—ç¢³è¶³è·¡
                        const carbonFootprint = calculateInvoiceCarbonFootprint(invoiceData);
                        
                        // è‡ªå‹•å¡«å…¥è¡¨å–®
                        fillInvoiceForm(invoiceData, carbonFootprint);
                        
                        // è¨˜éŒ„åˆ°æ¯æ—¥ç¢³è¶³è·¡
                        await recordInvoiceToDaily(invoiceData, carbonFootprint);
                        
                        // é¡¯ç¤ºè‡ªå‹•åµæ¸¬é€šçŸ¥
                        showAutoDetectionNotification(invoiceData, carbonFootprint);
                    }
                }
            } catch (error) {
                console.error('âŒ æª¢æŸ¥æ–°ç™¼ç¥¨å¤±æ•—:', error);
            }
        }
        
        // æª¢æŸ¥æ–°ç™¼ç¥¨ï¼ˆçœŸå¯¦APIèª¿ç”¨ï¼‰
        async function checkNewInvoices() {
            // èª¿ç”¨çœŸå¯¦é›»å­ç™¼ç¥¨API
            try {
                const response = await fetch('http://localhost:3001/api/invoice/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        carrierCode: carrierInfo.code,
                        lastCheckTime: carrierInfo.lastCheckTime || new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ç™¼ç¥¨APIèª¿ç”¨å¤±æ•—');
                }
                
                const result = await response.json();
                
                // æ›´æ–°æœ€å¾Œæª¢æŸ¥æ™‚é–“
                if (carrierInfo && result.invoices && result.invoices.length > 0) {
                    carrierInfo.lastCheckTime = new Date().toISOString();
                    localStorage.setItem('carrierInfo', JSON.stringify(carrierInfo));
                }
                
                return result.invoices || [];
            } catch (error) {
                console.error('âŒ æª¢æŸ¥æ–°ç™¼ç¥¨å¤±æ•—:', error);
                return [];
            }
        }
        
        // é¡¯ç¤ºè‡ªå‹•åµæ¸¬é€šçŸ¥
        function showAutoDetectionNotification(invoiceData, carbonFootprint) {
            const notification = document.createElement('div');
            notification.id = 'autoDetectionNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: #2196F3;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 20px;">ğŸ¤–</div>
                    <div>
                        <div style="font-weight: bold;">è‡ªå‹•åµæ¸¬åˆ°ç™¼ç¥¨ï¼</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                            ${invoiceData.storeName}
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            NT$ ${invoiceData.amount.toFixed(2)} â†’ ${carbonFootprint.toFixed(2)} kg COâ‚‚
                        </div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                            å·²è‡ªå‹•ç´¯è¨ˆåˆ°ä»Šæ—¥è¨˜éŒ„
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // 5ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // é—œé–‰è¼‰å…·æ¨¡æ…‹æ¡†
        
        // æ›´æ–°è¼‰å…·ç‹€æ…‹
        function updateCarrierStatus() {
            const carrierInfoElement = document.getElementById('carrierInfo');
            const syncStatusElement = document.getElementById('syncStatus');
            
            if (carrierInfo) {
                const autoDetectStatus = carrierInfo.autoDetectEnabled ? ' | ğŸ¤– è‡ªå‹•åµæ¸¬å·²å•Ÿç”¨' : '';
                carrierInfoElement.innerHTML = `
                    âœ… å·²ç¶å®šï¼š${carrierInfo.name}<br>
                    <small>é¡å‹ï¼š${getCarrierTypeName(carrierInfo.type)} | è™Ÿç¢¼ï¼š${carrierInfo.code}${autoDetectStatus}</small>
                `;
                syncStatusElement.textContent = autoSyncEnabled ? t('sync_enabled') : t('sync_disabled');
            } else {
                carrierInfoElement.textContent = t('carrier_not_bound');
                syncStatusElement.textContent = t('sync_disabled');
            }
        }
        
        // ç²å–è¼‰å…·é¡å‹åç¨±
        function getCarrierTypeName(type) {
            const types = {
                'mobile': 'æ‰‹æ©Ÿæ¢ç¢¼',
                'citizen': 'è‡ªç„¶äººæ†‘è­‰',
                'love': 'æ„›å¿ƒç¢¼',
                'company': 'å…¬å¸çµ±ç·¨'
            };
            return types[type] || type;
        }
        
        // åŒæ­¥è¼‰å…·ç™¼ç¥¨
        async function checkCarrierInvoices() {
            if (!carrierInfo) {
                alert('è«‹å…ˆç¶å®šé›»å­ç™¼ç¥¨è¼‰å…·');
                return;
            }
            
            const syncButton = event.target;
            const originalText = syncButton.textContent;
            syncButton.textContent = 'ğŸ”„ åŒæ­¥ä¸­...';
            syncButton.disabled = true;
            
            try {
                // æ¨¡æ“¬APIèª¿ç”¨
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // æ¨¡æ“¬ç²å–åˆ°çš„ç™¼ç¥¨æ•¸æ“š
                const mockInvoices = [
                    {
                        id: 'inv_' + Date.now(),
                        storeName: 'å…¨è¯ç¦åˆ©ä¸­å¿ƒ',
                        amount: 285.0,
                        date: new Date().toISOString(),
                        items: ['ç‰›å¥¶', 'éºµåŒ…', 'æ°´æœ'],
                        carbonFootprint: 2.85
                    },
                    {
                        id: 'inv_' + (Date.now() + 1),
                        storeName: '7-ELEVEN',
                        amount: 120.0,
                        date: new Date(Date.now() - 86400000).toISOString(),
                        items: ['å’–å•¡', 'ä¸‰æ˜æ²»'],
                        carbonFootprint: 1.20
                    }
                ];
                
                // ä¿å­˜ç™¼ç¥¨åˆ°æœ¬åœ°
                const existingInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                const newInvoices = mockInvoices.filter(inv => 
                    !existingInvoices.some(existing => existing.id === inv.id)
                );
                
                if (newInvoices.length > 0) {
                    existingInvoices.unshift(...newInvoices);
                    localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                    
                    // æ›´æ–°å¯¦æ™‚æ•¸æ“š
                    const totalCarbon = newInvoices.reduce((sum, inv) => sum + inv.carbonFootprint, 0);
                    realTimeData.shopping += totalCarbon;
                    updateRealTimeDisplay();
                    
                    alert(`âœ… åŒæ­¥å®Œæˆï¼\n\næ–°å¢ ${newInvoices.length} å¼µç™¼ç¥¨\nç¸½é‡‘é¡ï¼šNT$ ${newInvoices.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2)}\næ–°å¢ç¢³è¶³è·¡ï¼š${totalCarbon.toFixed(2)} kg`);
                    
                    loadRecentInvoices();
                } else {
                    alert('ğŸ“‹ æ²’æœ‰æ–°çš„ç™¼ç¥¨è¨˜éŒ„');
                }
                
            } catch (error) {
                alert('âŒ åŒæ­¥å¤±æ•—ï¼š' + error.message);
            } finally {
                syncButton.textContent = originalText;
                syncButton.disabled = false;
            }
        }
        
        // è¼‰å…¥æœ€è¿‘ç™¼ç¥¨è¨˜éŒ„
        function loadRecentInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const recentInvoicesElement = document.getElementById('recentInvoices');
            
            if (invoices.length === 0) {
                recentInvoicesElement.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        ğŸ“‹ æš«ç„¡ç™¼ç¥¨è¨˜éŒ„<br>
                        <small>ç¶å®šè¼‰å…·æˆ–æ‰‹å‹•æƒæç™¼ç¥¨é–‹å§‹è¨˜éŒ„</small>
                    </div>
                `;
                return;
            }
            
            const recentInvoices = invoices.slice(0, 5); // é¡¯ç¤ºæœ€è¿‘5ç­†
            recentInvoicesElement.innerHTML = recentInvoices.map(invoice => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${invoice.storeName}</strong><br>
                        <small>NT$ ${invoice.amount.toFixed(2)} | ${new Date(invoice.date).toLocaleDateString()}</small>
                    </div>
                    <div style="text-align: right; color: #4CAF50; font-weight: bold;">
                        ${invoice.carbonFootprint.toFixed(2)} kg
                    </div>
                </div>
            `).join('');
        }
        
        // è‡ªå‹•åŒæ­¥è¼‰å…·ç™¼ç¥¨
        function startAutoSync() {
            if (autoSyncEnabled && carrierInfo) {
                // æ¯5åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ–°ç™¼ç¥¨
                setInterval(async () => {
                    try {
                        await checkCarrierInvoices();
                    } catch (error) {
                        console.log('è‡ªå‹•åŒæ­¥å¤±æ•—ï¼š', error);
                    }
                }, 300000); // 5åˆ†é˜
            }
        }
        
        // æäº¤ç™¼ç¥¨
        async function submitInvoice() {
            const storeName = document.getElementById('storeName').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (!storeName || !amount) {
                alert('è«‹å¡«å¯«å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/invoice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ storeName, totalAmount: amount, items: [] })
                });
                
                const result = await response.json();
                if (result.success) {
                    // è¨ˆç®—ç¢³è¶³è·¡
                    const carbonFootprint = amount * 0.01;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
                    const invoice = {
                        id: 'inv_' + Date.now(),
                        storeName: storeName,
                        amount: amount,
                        date: new Date().toISOString(),
                        items: [],
                        carbonFootprint: carbonFootprint,
                        source: 'manual' // æ‰‹å‹•è¼¸å…¥
                    };
                    
                    const existingInvoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                    existingInvoices.unshift(invoice);
                    localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                    
                    // æ›´æ–°æ¯æ—¥ç¢³è¶³è·¡è¨˜éŒ„
                    updateDailyCarbonRecord(carbonFootprint);
                    
                    // æ›´æ–°å¯¦æ™‚æ•¸æ“š
                    realTimeData.shopping += carbonFootprint;
                    updateRealTimeDisplay();
                    
                    alert('âœ… ç™¼ç¥¨è¨˜éŒ„å·²ä¿å­˜ï¼\n\nå•†åº—ï¼š' + storeName + '\né‡‘é¡ï¼šNT$ ' + amount.toFixed(2) + '\nç¢³è¶³è·¡ï¼š' + carbonFootprint.toFixed(2) + ' kg');
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('storeName').value = '';
                    document.getElementById('amount').value = '';
                    
                    closeModal('invoiceModal');
                    loadRecentInvoices();
                } else {
                    alert('ä¿å­˜å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                alert('ç¶²çµ¡éŒ¯èª¤ï¼š' + error.message);
            }
        }
        
        // æ›´æ–°å€‹äººåŒ–ç›®æ¨™
        function updatePersonalizedGoal() {
            const ageGroup = document.getElementById('ageGroup').value;
            const residenceType = document.getElementById('residenceType').value;
            
            userProfile.ageGroup = ageGroup;
            userProfile.residenceType = residenceType;
            
            const personalizedGoal = calculatePersonalizedGoal();
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('personalizedGoalDisplay').textContent = `${personalizedGoal.toFixed(1)} å…¬æ–¤ COâ‚‚/å¤©`;
            
            // æ›´æ–°æ¯æ—¥ç›®æ¨™è¼¸å…¥æ¡†
            document.getElementById('dailyGoal').value = personalizedGoal.toFixed(1);
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // æ›´æ–°å¯¦æ™‚é¡¯ç¤º
            updateRealTimeDisplay();
        }
        
        // å¾è¼¸å…¥æ¡†æ›´æ–°ç›®æ¨™
        function updateGoalFromInput() {
            const manualGoal = parseFloat(document.getElementById('dailyGoal').value);
            userProfile.personalizedGoal = manualGoal;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateRealTimeDisplay();
        }
        
        // ç°¡åŒ–çš„å€‹äººåŒ–ç›®æ¨™è¨­ç½®ï¼ˆä¸»ç•Œé¢ç›´æ¥èª¿ç”¨ï¼‰
        function showPersonalizedGoalSetup() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 25px;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¯</div>
                            <h3 style="margin: 0 0 10px 0; color: #333; font-size: 20px;">è¨­å®šå€‹äººåŒ–ç›®æ¨™</h3>
                            <div style="font-size: 14px; color: #666;">æ ¹æ“šæ‚¨çš„å¹´é½¡å’Œå±…ä½åœ°ï¼Œç‚ºæ‚¨è¨ˆç®—æœ€é©åˆçš„ç¢³è¶³è·¡ç›®æ¨™</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">å¹´é½¡å±¤</label>
                            <select id="quickAgeGroup" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="">è«‹é¸æ“‡å¹´é½¡å±¤</option>
                                <option value="18-25">18-25æ­²</option>
                                <option value="26-35">26-35æ­²</option>
                                <option value="36-50">36-50æ­²</option>
                                <option value="51-65">51-65æ­²</option>
                                <option value="65+">65æ­²ä»¥ä¸Š</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">å±…ä½å€åŸŸ</label>
                            <select id="quickResidenceType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                                <option value="">è«‹é¸æ“‡å±…ä½å€åŸŸ</option>
                                <option value="urban">éƒ½å¸‚</option>
                                <option value="suburban">éƒŠå€</option>
                                <option value="rural">é„‰æ‘</option>
                            </select>
                        </div>
                        
                        <div id="goalPreview" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #2e7d32; margin-bottom: 5px;">æ‚¨çš„å€‹äººåŒ–ç›®æ¨™</div>
                            <div id="previewGoal" style="font-size: 24px; font-weight: bold; color: #1b5e20;"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">åŸºæ–¼æ‚¨çš„å¹´é½¡å±¤å’Œå±…ä½å€åŸŸè¨ˆç®—</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-direction: column;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="closeModal(this)" style="
                                    flex: 1;
                                    background: #f5f5f5;
                                    color: #666;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                ">å–æ¶ˆ</button>
                                <button onclick="applyPersonalizedGoal()" style="
                                    flex: 1;
                                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    font-weight: bold;
                                ">ç¢ºèªè¨­å®š</button>
                            </div>
                            <button onclick="closeModal(this); showAdvancedSettings()" style="
                                width: 100%;
                                background: transparent;
                                color: #666;
                                border: 1px solid #ddd;
                                padding: 8px;
                                border-radius: 6px;
                                font-size: 14px;
                                cursor: pointer;
                                margin-top: 5px;
                            ">âš™ï¸ æ›´å¤šè¨­å®šé¸é …</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ·»åŠ å³æ™‚é è¦½åŠŸèƒ½
            document.getElementById('quickAgeGroup').addEventListener('change', updateGoalPreview);
            document.getElementById('quickResidenceType').addEventListener('change', updateGoalPreview);
            
            // å¦‚æœæœ‰å·²ä¿å­˜çš„è¨­ç½®ï¼Œè‡ªå‹•å¡«å…¥
            if (userProfile.ageGroup) {
                document.getElementById('quickAgeGroup').value = userProfile.ageGroup;
            }
            if (userProfile.residenceType) {
                document.getElementById('quickResidenceType').value = userProfile.residenceType;
            }
            
            updateGoalPreview();
        }
        
        // æ›´æ–°ç›®æ¨™é è¦½
        function updateGoalPreview() {
            const ageGroup = document.getElementById('quickAgeGroup').value;
            const residenceType = document.getElementById('quickResidenceType').value;
            
            if (ageGroup && residenceType) {
                const ageFactor = carbonFactors.ageGroups[ageGroup] || 1.0;
                const residenceFactor = carbonFactors.residenceTypes[residenceType] || 1.0;
                const personalizedGoal = 20.0 * ageFactor * residenceFactor;
                
                document.getElementById('previewGoal').textContent = `${personalizedGoal.toFixed(1)} å…¬æ–¤ COâ‚‚/å¤©`;
                document.getElementById('goalPreview').style.display = 'block';
            } else {
                document.getElementById('goalPreview').style.display = 'none';
            }
        }
        
        // æ‡‰ç”¨å€‹äººåŒ–ç›®æ¨™
        function applyPersonalizedGoal() {
            const ageGroup = document.getElementById('quickAgeGroup').value;
            const residenceType = document.getElementById('quickResidenceType').value;
            
            if (!ageGroup || !residenceType) {
                alert('è«‹é¸æ“‡å¹´é½¡å±¤å’Œå±…ä½å€åŸŸ');
                return;
            }
            
            userProfile.ageGroup = ageGroup;
            userProfile.residenceType = residenceType;
            
            const personalizedGoal = calculatePersonalizedGoal();
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // æ›´æ–°ä¸»ç•Œé¢é¡¯ç¤º
            updateRealTimeDisplay();
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            closeModal(document.querySelector('.modal'));
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            alert(`âœ… å€‹äººåŒ–ç›®æ¨™è¨­ç½®æˆåŠŸï¼\n\nå¹´é½¡å±¤: ${ageGroup.replace('-', '-')}æ­²\nå±…ä½å€åŸŸ: ${getResidenceTypeText()}\nå€‹äººåŒ–ç›®æ¨™: ${personalizedGoal.toFixed(1)} kg/å¤©\n\nä¸»ç•Œé¢ç›®æ¨™å·²æ›´æ–°ï¼`);
        }
        
        // é¦–æ¬¡ä½¿ç”¨å¼•å°
        function showFirstTimeGuide() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 25px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘‹</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;">æ­¡è¿ä½¿ç”¨æ¸›ç¢³æ—¥è¨˜ï¼</h3>
                            <div style="font-size: 14px; opacity: 0.9;">è®“æˆ‘å€‘ç‚ºæ‚¨è¨­å®šå€‹äººåŒ–çš„ç¢³è¶³è·¡ç›®æ¨™</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; margin-bottom: 8px;">ğŸ’¡ ç‚ºä»€éº¼éœ€è¦å€‹äººåŒ–ç›®æ¨™ï¼Ÿ</div>
                            <div style="font-size: 12px; opacity: 0.9; line-height: 1.4;">
                                ä¸åŒå¹´é½¡å’Œå±…ä½åœ°çš„äººï¼Œç¢³è¶³è·¡å·®ç•°å¾ˆå¤§ã€‚<br>
                                å¹´è¼•äººé€šå‹¤å¤šï¼Œéƒ½å¸‚äººæ¶ˆè²»é »ç¹ï¼Œ<br>
                                å€‹äººåŒ–ç›®æ¨™æ›´è²¼è¿‘æ‚¨çš„å¯¦éš›æƒ…æ³ï¼
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeModal(this); skipPersonalizedSetup()" style="
                                flex: 1;
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: 2px solid white;
                                padding: 12px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                            ">ç¨å¾Œè¨­å®š</button>
                            <button onclick="closeModal(this); showPersonalizedGoalSetup()" style="
                                flex: 1;
                                background: white;
                                color: #4CAF50;
                                border: none;
                                padding: 12px;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                                font-weight: bold;
                            ">ç«‹å³è¨­å®š</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // è·³éå€‹äººåŒ–è¨­ç½®
        function skipPersonalizedSetup() {
            // è¨˜éŒ„ç”¨æˆ¶é¸æ“‡è·³éï¼Œé¿å…é‡è¤‡å½ˆå‡º
            localStorage.setItem('skipPersonalizedSetup', 'true');
        }
        
        // é¡¯ç¤ºé«˜ç´šè¨­å®š
        function showAdvancedSettings() {
            // é¡¯ç¤ºåŸæœ¬çš„è¨­å®šæ¨¡æ…‹æ¡†
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        // æ¸¬è©¦å€‹äººåŒ–ç›®æ¨™
        function testPersonalizedGoal() {
            // è¨­ç½®æ¸¬è©¦æ•¸æ“š
            userProfile.ageGroup = '26-35';
            userProfile.residenceType = 'urban';
            
            // è¨ˆç®—å€‹äººåŒ–ç›®æ¨™
            const personalizedGoal = calculatePersonalizedGoal();
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('ageGroup').value = userProfile.ageGroup;
            document.getElementById('residenceType').value = userProfile.residenceType;
            document.getElementById('dailyGoal').value = personalizedGoal.toFixed(1);
            document.getElementById('personalizedGoalDisplay').textContent = `${personalizedGoal.toFixed(1)} å…¬æ–¤ COâ‚‚/å¤©`;
            
            // æ›´æ–°å¯¦æ™‚é¡¯ç¤º
            updateRealTimeDisplay();
            
            alert(`æ¸¬è©¦å€‹äººåŒ–ç›®æ¨™è¨­ç½®æˆåŠŸï¼\n\nå¹´é½¡å±¤: 26-35æ­²\nå±…ä½å€åŸŸ: éƒ½å¸‚\nå€‹äººåŒ–ç›®æ¨™: ${personalizedGoal.toFixed(1)} kg/å¤©\n\nä¸»ç•Œé¢ç›®æ¨™å·²æ›´æ–°ï¼`);
        }
        
        // å„²å­˜è¨­å®š
        function saveSettings() {
            const dailyGoal = document.getElementById('dailyGoal').value;
            const gpsEnabled = document.getElementById('gpsEnabled').value;
            const autoTracking = document.getElementById('autoTrackingSetting').value;
            
            // ä¿å­˜ç”¨æˆ¶æª”æ¡ˆ
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            alert(t('settings_saved') + '\n\n' + t('daily_goal_kg').replace(' (å…¬æ–¤)', '') + 'ï¼š' + dailyGoal + ' kg\nGPSï¼š' + (gpsEnabled === 'true' ? t('enabled') : t('disabled')) + '\n' + t('auto_tracking') + 'ï¼š' + (autoTracking === 'true' ? t('enabled') : t('disabled')));
            closeModal('settingsModal');
        }
        
        // é¡¯ç¤ºåˆ†æ
        function showAnalytics() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // ç²å–çœŸå¯¦æ•¸æ“š
            const analyticsData = getAnalyticsData();
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“Š</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 20px;" data-lang="analytics_feature">æ•¸æ“šåˆ†æåŠŸèƒ½</h3>
                            <div style="font-size: 14px; opacity: 0.9;" data-lang="real_time_analytics">åŸºæ–¼æ‚¨çš„è‡ªå‹•åµæ¸¬æ•¸æ“š</div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="today_summary">ä»Šæ—¥æ‘˜è¦</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${analyticsData.todayTotal}</div>
                                    <div style="font-size: 12px; opacity: 0.8;" data-lang="today_carbon">ä»Šæ—¥ç¢³è¶³è·¡ (kg)</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold;">${analyticsData.goalProgress}%</div>
                                    <div style="font-size: 12px; opacity: 0.8;" data-lang="goal_progress">ç›®æ¨™é€²åº¦</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="category_breakdown">åˆ†é¡çµ±è¨ˆ</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>ğŸ›’ <span data-lang="shopping_label">è³¼ç‰©</span>: ${analyticsData.categories.shopping} kg</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>ğŸš— <span data-lang="transport_label">äº¤é€š</span>: ${analyticsData.categories.transport} kg</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>ğŸ“± <span data-lang="activity_label">æ‰‹æ©Ÿä½¿ç”¨</span>: ${analyticsData.categories.activity} kg</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; font-size: 12px;">
                                    <div>ğŸ“ <span data-lang="location_label">ç§»å‹•è»Œè·¡</span>: ${analyticsData.categories.location} kg</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="weekly_trends">è¿‘7å¤©è¶¨å‹¢</h4>
                            <div style="display: flex; justify-content: space-between; align-items: end; height: 80px; margin: 10px 0;">
                                ${analyticsData.weeklyData.map((day, index) => 
                                    `<div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                        <div style="background: rgba(255,255,255,0.3); width: 20px; height: ${Math.max(day.value * 2, 4)}px; border-radius: 2px; margin-bottom: 5px;"></div>
                                        <div style="font-size: 10px; opacity: 0.8;">${day.day}</div>
                                        <div style="font-size: 10px; opacity: 0.6;">${day.value}</div>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">ğŸ“Š å€‹äººåŒ–æ¯”è¼ƒ</h4>
                            <div style="font-size: 14px; line-height: 1.4;">
                                ${(() => {
                                    const feedback = generatePersonalizedFeedback();
                                    return `
                                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ“ˆ èˆ‡åŒé½¡åŒå€æ¯”è¼ƒ</div>
                                            <div style="margin-bottom: 5px;">ç•¶å‰: ${feedback.current} kg</div>
                                            <div style="margin-bottom: 5px;">åŒé½¡å¹³å‡: ${feedback.average} kg</div>
                                            <div style="margin-bottom: 5px;">å€‹äººç›®æ¨™: ${feedback.goal} kg</div>
                                            <div style="color: #FFEB3B; font-weight: bold;">${feedback.comparison}</div>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                                            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¯ å€‹äººè¡¨ç¾è©•ä¼°</div>
                                            <div style="color: #4CAF50;">${feedback.feedback}</div>
                                        </div>
                                    `;
                                })()}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;" data-lang="eco_suggestions">ç’°ä¿å»ºè­°</h4>
                            <div style="font-size: 14px; line-height: 1.4;">
                                ${analyticsData.suggestions.map(suggestion => 
                                    `<div style="margin-bottom: 8px;">ğŸ’¡ ${suggestion}</div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeModal(this)" data-lang="confirm" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                ç¢ºå®š
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ç²å–åˆ†ææ•¸æ“š
        function getAnalyticsData() {
            // ç²å–ä»Šæ—¥æ•¸æ“š
            const today = new Date().toDateString();
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const todayInvoices = invoices.filter(inv => new Date(inv.date).toDateString() === today);
            
            // è¨ˆç®—ä»Šæ—¥ç¸½ç¢³è¶³è·¡
            const todayTotal = todayInvoices.reduce((sum, inv) => sum + (parseFloat(inv.carbonFootprint) || 0), 0);
            
            // ç²å–æ¯æ—¥ç›®æ¨™
            const dailyGoal = parseFloat(localStorage.getItem('dailyGoal') || '20');
            const goalProgress = Math.round((todayTotal / dailyGoal) * 100);
            
            // åˆ†é¡çµ±è¨ˆ
            const categories = {
                shopping: 0,
                transport: 0,
                activity: 0,
                location: 0
            };
            
            todayInvoices.forEach(inv => {
                const carbon = parseFloat(inv.carbonFootprint) || 0;
                if (inv.category === 'shopping') categories.shopping += carbon;
                else if (inv.category === 'transport') categories.transport += carbon;
                else if (inv.category === 'activity') categories.activity += carbon;
                else categories.location += carbon;
            });
            
            // è¿‘7å¤©æ•¸æ“š
            const weeklyData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayDate = date.toDateString();
                const dayInvoices = invoices.filter(inv => new Date(inv.date).toDateString() === dayDate);
                const dayTotal = dayInvoices.reduce((sum, inv) => sum + (parseFloat(inv.carbonFootprint) || 0), 0);
                
                weeklyData.push({
                    day: `${date.getMonth() + 1}/${date.getDate()}`,
                    value: dayTotal.toFixed(1)
                });
            }
            
            // ç’°ä¿å»ºè­° - åŸºæ–¼çœŸå¯¦æ•¸æ“šçš„æ™ºèƒ½åˆ†æ
            const suggestions = [];
            
            // åˆ†æä»Šæ—¥æ•¸æ“š
            const totalCategories = categories.shopping + categories.transport + categories.activity + categories.location;
            const shoppingPercentage = totalCategories > 0 ? (categories.shopping / totalCategories) * 100 : 0;
            const transportPercentage = totalCategories > 0 ? (categories.transport / totalCategories) * 100 : 0;
            const activityPercentage = totalCategories > 0 ? (categories.activity / totalCategories) * 100 : 0;
            
            // åˆ†æè¿‘7å¤©è¶¨å‹¢
            const weeklyTotals = weeklyData.map(day => parseFloat(day.value));
            const avgWeekly = weeklyTotals.reduce((sum, val) => sum + val, 0) / 7;
            const maxDay = Math.max(...weeklyTotals);
            const minDay = Math.min(...weeklyTotals);
            
            // åŸºæ–¼ç›®æ¨™é”æˆæƒ…æ³çš„å»ºè­°
            if (todayTotal > dailyGoal * 1.2) {
                suggestions.push(`ä»Šæ—¥ç¢³è¶³è·¡ ${todayTotal}kg è¶…å‡ºç›®æ¨™ ${dailyGoal}kg é” ${goalProgress}%ï¼Œå»ºè­°æ¸›å°‘éå¿…è¦æ¶ˆè²»`);
            } else if (todayTotal > dailyGoal) {
                suggestions.push(`ä»Šæ—¥ç¢³è¶³è·¡ ${todayTotal}kg ç•¥è¶…ç›®æ¨™ï¼Œå»ºè­°æ§åˆ¶æ¶ˆè²»é »ç‡`);
            } else if (todayTotal === 0) {
                suggestions.push('ä»Šæ—¥å°šæœªè¨˜éŒ„ç¢³è¶³è·¡ï¼Œå»ºè­°é–‹å§‹è¨˜éŒ„æ‚¨çš„æ¶ˆè²»è¡Œç‚º');
            } else if (goalProgress < 50) {
                suggestions.push(`ä»Šæ—¥ç¢³è¶³è·¡ ${todayTotal}kgï¼Œé€²åº¦è‰¯å¥½ï¼å»ºè­°ä¿æŒç•¶å‰æ¶ˆè²»æ¨¡å¼`);
            }
            
            // åŸºæ–¼åˆ†é¡çµ±è¨ˆçš„å»ºè­°
            if (shoppingPercentage > 60) {
                suggestions.push(`è³¼ç‰©ç¢³è¶³è·¡ä½” ${shoppingPercentage.toFixed(1)}%ï¼Œå»ºè­°æ¸›å°‘è¡å‹•æ¶ˆè²»ï¼Œå„ªå…ˆè³¼è²·å¿…éœ€å“`);
            } else if (shoppingPercentage > 40) {
                suggestions.push(`è³¼ç‰©ç¢³è¶³è·¡ä½” ${shoppingPercentage.toFixed(1)}%ï¼Œå»ºè­°é¸æ“‡ç’°ä¿åŒ…è£å•†å“`);
            }
            
            if (transportPercentage > 50) {
                suggestions.push(`äº¤é€šç¢³è¶³è·¡ä½” ${transportPercentage.toFixed(1)}%ï¼Œå»ºè­°å¤šä½¿ç”¨å¤§çœ¾é‹è¼¸æˆ–æ­¥è¡Œ`);
            } else if (transportPercentage > 30) {
                suggestions.push(`äº¤é€šç¢³è¶³è·¡ä½” ${transportPercentage.toFixed(1)}%ï¼Œå»ºè­°è¦åŠƒæ›´ç’°ä¿çš„å‡ºè¡Œè·¯ç·š`);
            }
            
            // åŸºæ–¼é€±è¶¨å‹¢çš„å»ºè­°
            if (maxDay > avgWeekly * 1.5) {
                const maxDayIndex = weeklyTotals.indexOf(maxDay);
                const maxDayDate = weeklyData[maxDayIndex].day;
                suggestions.push(`${maxDayDate} ç¢³è¶³è·¡ç•°å¸¸é«˜é” ${maxDay}kgï¼Œå»ºè­°å›é¡§ç•¶æ—¥æ¶ˆè²»è¡Œç‚º`);
            }
            
            if (minDay === 0 && avgWeekly > 0) {
                suggestions.push('è¿‘7å¤©ä¸­æœ‰é›¶ç¢³è¶³è·¡æ—¥ï¼Œå»ºè­°å°‡ç’°ä¿ç¿’æ…£æ¨å»£åˆ°æ›´å¤šå¤©');
            }
            
            // åŸºæ–¼æ‰‹æ©Ÿä½¿ç”¨æ•¸æ“šçš„å»ºè­°
            if (categories.activity > 0) {
                suggestions.push(`æ‰‹æ©Ÿä½¿ç”¨ç¢³è¶³è·¡ ${categories.activity}kgï¼Œå»ºè­°æ¸›å°‘ä¸å¿…è¦çš„è¢å¹•ä½¿ç”¨æ™‚é–“`);
            }
            
            // åŸºæ–¼ç§»å‹•è»Œè·¡æ•¸æ“šçš„å»ºè­°
            if (categories.location > 0) {
                suggestions.push(`ç§»å‹•è»Œè·¡ç¢³è¶³è·¡ ${categories.location}kgï¼Œå»ºè­°æ¸›å°‘ä¸å¿…è¦çš„ç§»å‹•`);
            }
            
            // å¦‚æœæ²’æœ‰ä»»ä½•å…·é«”å»ºè­°ï¼Œæä¾›åŸºæ–¼æ•´é«”è¡¨ç¾çš„å»ºè­°
            if (suggestions.length === 0) {
                if (avgWeekly < dailyGoal * 0.5) {
                    suggestions.push(`è¿‘7å¤©å¹³å‡ç¢³è¶³è·¡ ${avgWeekly.toFixed(1)}kgï¼Œè¡¨ç¾å„ªç§€ï¼ç¹¼çºŒä¿æŒç’°ä¿ç”Ÿæ´»ç¿’æ…£`);
                } else if (avgWeekly < dailyGoal) {
                    suggestions.push(`è¿‘7å¤©å¹³å‡ç¢³è¶³è·¡ ${avgWeekly.toFixed(1)}kgï¼Œè¡¨ç¾è‰¯å¥½ï¼Œå¯é€²ä¸€æ­¥å„ªåŒ–æ¶ˆè²»é¸æ“‡`);
                } else {
                    suggestions.push(`è¿‘7å¤©å¹³å‡ç¢³è¶³è·¡ ${avgWeekly.toFixed(1)}kgï¼Œå»ºè­°åˆ¶å®šæ›´åš´æ ¼çš„ç’°ä¿ç›®æ¨™`);
                }
            }
            
            // é™åˆ¶å»ºè­°æ•¸é‡ï¼Œå„ªå…ˆé¡¯ç¤ºæœ€é‡è¦çš„
            if (suggestions.length > 3) {
                suggestions.splice(3);
            }
            
            return {
                todayTotal: todayTotal.toFixed(1),
                goalProgress: Math.min(goalProgress, 100),
                categories: {
                    shopping: categories.shopping.toFixed(1),
                    transport: categories.transport.toFixed(1),
                    activity: categories.activity.toFixed(1),
                    location: categories.location.toFixed(1)
                },
                weeklyData: weeklyData,
                suggestions: suggestions
            };
        }
        
        // åˆå§‹åŒ–å¯¦æ™‚æ•¸æ“šï¼ˆè¼‰å…¥æ­·å²æ•¸æ“šï¼‰
        function initializeRealTimeData() {
            // è¼‰å…¥ä»Šæ—¥ç™¼ç¥¨æ•¸æ“š
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const today = new Date().toDateString();
            
            const todayInvoices = invoices.filter(inv => 
                new Date(inv.date).toDateString() === today
            );
            
            realTimeData.shopping = todayInvoices.reduce((sum, inv) => sum + inv.carbonFootprint, 0);
            
            // è¼‰å…¥ç§»å‹•æ­·å²æ•¸æ“š
            const movements = JSON.parse(localStorage.getItem('movements') || '[]');
            const todayMovements = movements.filter(mov => 
                new Date(mov.timestamp).toDateString() === today
            );
            
            realTimeData.transport = todayMovements.reduce((sum, mov) => sum + mov.carbonFootprint, 0);
            
            // æ›´æ–°é¡¯ç¤º
            updateRealTimeDisplay();
            
        // åˆå§‹åŒ–æ¯æ—¥çµ±è¨ˆé¡¯ç¤º
        updateDailyStatsDisplay();
        
        // è¨­ç½®æ¯æ—¥24:00è‡ªå‹•è¨˜éŒ„
        setupDailyAutoRecord();
        }
        
        // GPSå®šä½å’Œç§»å‹•è¿½è¹¤
        let watchId = null;
        let lastPosition = null;
        let totalDistance = 0;
        let isTracking = false;
        
        // å¯¦æ™‚ç¢³è¶³è·¡æ•¸æ“š
        let realTimeData = {
            transport: 0,      // äº¤é€šé‹è¼¸ç¢³è¶³è·¡
            shopping: 0,       // è³¼ç‰©æ¶ˆè²»ç¢³è¶³è·¡
            activity: 0,       // æ´»å‹•åµæ¸¬ç¢³è¶³è·¡
            location: 0,       // ä½ç½®è®ŠåŒ–ç¢³è¶³è·¡
            sensor: 0,         // æ„Ÿæ‡‰å™¨æ•¸æ“šç¢³è¶³è·¡
            total: 0           // ç¸½ç¢³è¶³è·¡
        };
        
        // ç”¨æˆ¶æª”æ¡ˆæ•¸æ“š
        let userProfile = {
            ageGroup: '', // '18-25', '26-35', '36-50', '51-65', '65+'
            residenceType: '', // 'urban', 'suburban', 'rural'
            personalizedGoal: 20.0, // å€‹äººåŒ–ç›®æ¨™
            baselineGoal: 20.0 // åŸºæº–ç›®æ¨™
        };
        
        // å¹´é½¡å±¤å’Œå±…ä½å€åŸŸçš„ç¢³è¶³è·¡ä¿‚æ•¸
        const carbonFactors = {
            ageGroups: {
                '18-25': 1.15, // å¹´è¼•äººç¢³è¶³è·¡è¼ƒé«˜
                '26-35': 1.10,
                '36-50': 1.05,
                '51-65': 0.95,
                '65+': 0.85
            },
            residenceTypes: {
                'urban': 1.10, // éƒ½å¸‚ç¢³è¶³è·¡è¼ƒé«˜
                'suburban': 1.00,
                'rural': 0.85 // é„‰æ‘ç¢³è¶³è·¡è¼ƒä½
            }
        };
        
        // åŒé½¡åŒå€å¹³å‡æ•¸æ“šï¼ˆæ¨¡æ“¬æ•¸æ“šï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯å¾æœå‹™å™¨ç²å–ï¼‰
        const averageData = {
            '18-25_urban': 22.0,
            '18-25_suburban': 20.0,
            '18-25_rural': 17.0,
            '26-35_urban': 21.0,
            '26-35_suburban': 19.0,
            '26-35_rural': 16.0,
            '36-50_urban': 20.0,
            '36-50_suburban': 18.0,
            '36-50_rural': 15.5,
            '51-65_urban': 18.5,
            '51-65_suburban': 16.5,
            '51-65_rural': 14.0,
            '65+_urban': 16.5,
            '65+_suburban': 15.0,
            '65+_rural': 12.5
        };
        
        // ç§»å‹•æ­·å²è¨˜éŒ„
        let movementHistory = [];
        let activityHistory = [];
        
        // è¨ˆç®—å€‹äººåŒ–ç›®æ¨™
        function calculatePersonalizedGoal() {
            if (!userProfile.ageGroup || !userProfile.residenceType) {
                return userProfile.baselineGoal;
            }
            
            const ageFactor = carbonFactors.ageGroups[userProfile.ageGroup] || 1.0;
            const residenceFactor = carbonFactors.residenceTypes[userProfile.residenceType] || 1.0;
            
            userProfile.personalizedGoal = userProfile.baselineGoal * ageFactor * residenceFactor;
            return userProfile.personalizedGoal;
        }
        
        // ç²å–åŒé½¡åŒå€å¹³å‡æ•¸æ“š
        function getAverageCarbonFootprint() {
            if (!userProfile.ageGroup || !userProfile.residenceType) {
                return 20.0; // é»˜èªå¹³å‡å€¼
            }
            
            const key = `${userProfile.ageGroup}_${userProfile.residenceType}`;
            return averageData[key] || 20.0;
        }
        
        // ç”Ÿæˆå€‹äººåŒ–åé¥‹
        function generatePersonalizedFeedback() {
            const currentTotal = realTimeData.total;
            const average = getAverageCarbonFootprint();
            const personalizedGoal = userProfile.personalizedGoal;
            
            let feedback = '';
            let comparison = '';
            
            // èˆ‡åŒé½¡åŒå€å¹³å‡æ¯”è¼ƒ
            if (currentTotal < average) {
                const percentage = Math.round(((average - currentTotal) / average) * 100);
                comparison = `ä½ æ¯”${getResidenceTypeText()}åŒé½¡äººä½${percentage}%ï¼Œå¾ˆæ£’ï¼`;
            } else if (currentTotal > average) {
                const percentage = Math.round(((currentTotal - average) / average) * 100);
                const suggestion = getImprovementSuggestion();
                comparison = `ä½ é«˜æ–¼${getResidenceTypeText()}å¹³å‡${percentage}%ï¼Œ${suggestion}`;
            } else {
                comparison = `ä½ çš„è¡¨ç¾èˆ‡${getResidenceTypeText()}åŒé½¡äººç›¸ç•¶ï¼`;
            }
            
            // èˆ‡å€‹äººç›®æ¨™æ¯”è¼ƒ
            if (currentTotal < personalizedGoal * 0.8) {
                feedback = 'è¡¨ç¾å„ªç§€ï¼ä½ é ä½æ–¼å€‹äººç›®æ¨™ã€‚';
            } else if (currentTotal < personalizedGoal) {
                feedback = 'è¡¨ç¾è‰¯å¥½ï¼ä½ æ­£åœ¨æ¥è¿‘å€‹äººç›®æ¨™ã€‚';
            } else if (currentTotal < personalizedGoal * 1.2) {
                feedback = 'æ¥è¿‘ç›®æ¨™ï¼Œç¹¼çºŒåŠªåŠ›ï¼';
            } else {
                feedback = 'éœ€è¦èª¿æ•´ç”Ÿæ´»æ–¹å¼ä¾†é™ä½ç¢³è¶³è·¡ã€‚';
            }
            
            return {
                comparison: comparison,
                feedback: feedback,
                current: currentTotal.toFixed(2),
                average: average.toFixed(2),
                goal: personalizedGoal.toFixed(2)
            };
        }
        
        // ç²å–å±…ä½å€åŸŸä¸­æ–‡æè¿°
        function getResidenceTypeText() {
            const residenceTexts = {
                'urban': 'éƒ½å¸‚',
                'suburban': 'éƒŠå€',
                'rural': 'é„‰æ‘'
            };
            return residenceTexts[userProfile.residenceType] || '';
        }
        
        // ç²å–æ”¹å–„å»ºè­°
        function getImprovementSuggestion() {
            const suggestions = [
                'å»ºè­°æ¸›å°‘é–‹è»Šé‡Œç¨‹ï¼Œæ¯å¤©å¯çœä¸‹2-3kg COâ‚‚',
                'å˜—è©¦ä½¿ç”¨å¤§çœ¾é‹è¼¸å·¥å…·ï¼Œå¯é™ä½30%äº¤é€šç¢³è¶³è·¡',
                'é¸æ“‡æ­¥è¡Œæˆ–é¨è‡ªè¡Œè»ŠçŸ­é€”å‡ºè¡Œ',
                'æ¸›å°‘ä¸å¿…è¦çš„è³¼ç‰©ï¼Œé¸æ“‡ç’°ä¿ç”¢å“',
                'å„ªåŒ–å®¶å±…èƒ½æºä½¿ç”¨ï¼Œç¯€çœç”¨é›»'
            ];
            return suggestions[Math.floor(Math.random() * suggestions.length)];
        }
        
        // é–‹å§‹GPSè¿½è¹¤
        function startGPSTracking() {
            if (!navigator.geolocation) {
                console.log('ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½');
                document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                document.getElementById('gpsStatus').textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½';
                return;
            }
            
            // å¦‚æœå·²ç¶“æœ‰GPSç›£è½åœ¨é‹è¡Œï¼Œå…ˆæ¸…é™¤
            if (window.gpsWatchId) {
                navigator.geolocation.clearWatch(window.gpsWatchId);
                console.log('æ¸…é™¤ä¹‹å‰çš„GPSç›£è½');
            }
            
            console.log('é–‹å§‹GPSè¿½è¹¤...');
            
            // å…ˆè«‹æ±‚ä¸€æ¬¡ä½ç½®ä¾†è§¸ç™¼æ¬Šé™å°è©±æ¡†
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('âœ… GPSæ¬Šé™å·²ç²å¾—ï¼Œé–‹å§‹æŒçºŒè¿½è¹¤');
                    document.getElementById('locationStatusText').textContent = t('gps_success_status');
                    document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                    
                    // é–‹å§‹æŒçºŒè¿½è¹¤
                    window.gpsWatchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            console.log('ğŸ“ GPS æ›´æ–°:', pos.coords.latitude, pos.coords.longitude);
                            
                            if (lastPosition && isTracking) {
                                const distance = calculateDistance(lastPosition, pos);
                                totalDistance += distance;
                                updateMovementData(distance, pos);
                            }
                            lastPosition = pos;
                            isTracking = true;
                            
                            // æ›´æ–°å¯¦æ™‚é¡¯ç¤º
                            updateRealTimeDisplay();
                        },
                        function(error) {
                            console.log('âŒ GPS ç›£è½å¤±æ•—:', error.message);
                            document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                            document.getElementById('gpsStatus').textContent = 'âŒ GPSç›£è½å¤±æ•—: ' + error.message;
                        },
                        { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                    );
                    
                    isTracking = true;
                },
                function(error) {
                    console.log('âŒ GPS æ¬Šé™è¢«æ‹’çµ•:', error.message);
                    document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                    document.getElementById('gpsStatus').textContent = 'âŒ GPSå®šä½å¤±æ•—: ' + error.message;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // åœæ­¢GPSè¿½è¹¤
        function stopGPSTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
            updateLocationStatus(null, 'GPSè¿½è¹¤å·²åœæ­¢');
        }
        
        // æ›´æ–°ä½ç½®ç‹€æ…‹
        function updateLocationStatus(position, message) {
            const statusElement = document.getElementById('locationStatusText');
            const gpsStatusElement = document.getElementById('gpsStatus');
            
            if (position) {
                // GPSå®šä½æˆåŠŸ - çœŸå¯¦æ•¸æ“š
                const statusText = `ğŸ“ GPSå®šä½æˆåŠŸ | æ­£åœ¨è¿½è¹¤æ‚¨çš„ç§»å‹•`;
                const gpsText = `âœ… GPSå®šä½æˆåŠŸ (ç²¾åº¦: ${position.coords.accuracy.toFixed(0)}ç±³)`;
                
                if (statusElement) statusElement.textContent = statusText;
                if (gpsStatusElement) gpsStatusElement.textContent = gpsText;
            } else if (message && message.trim() !== '') {
                // æœ‰éŒ¯èª¤è¨Šæ¯ - çœŸå¯¦ç‹€æ…‹
                let statusText = '';
                let gpsText = message;
                
                if (message.includes('âœ…') || message.includes('æˆåŠŸ')) {
                    statusText = t('gps_status');
                } else if (message.includes('âŒ') || message.includes('å¤±æ•—') || message.includes('éŒ¯èª¤') || message.includes('æ‹’çµ•')) {
                    statusText = t('gps_failed');
                    gpsText = `âŒ ${message.replace('âŒ ', '')}`;
                } else if (message.includes('â“') || message.includes('æª¢æ¸¬ä¸­')) {
                    statusText = t('gps_status_checking');
                    gpsText = `â“ ${message.replace('â“ ', '')}`;
                } else if (message.includes('ğŸ”„') || message.includes('å®šä½ä¸­') || message.includes('å•Ÿå‹•')) {
                    statusText = t('gps_positioning');
                    gpsText = `ğŸ”„ ${message.replace('ğŸ”„ ', '')}`;
                } else {
                    statusText = 'ğŸ“ ' + message;
                    gpsText = message;
                }
                
                if (statusElement) statusElement.textContent = statusText;
                if (gpsStatusElement) gpsStatusElement.textContent = gpsText;
            } else {
                // ç©ºç™½ç‹€æ…‹ - ç­‰å¾…çœŸå¯¦æª¢æ¸¬çµæœ
                if (statusElement) statusElement.textContent = '';
                if (gpsStatusElement) gpsStatusElement.textContent = '';
            }
        }
        
        // è¨ˆç®—å…©é»é–“è·é›¢ï¼ˆç±³ï¼‰
        function calculateDistance(pos1, pos2) {
            const R = 6371e3; // åœ°çƒåŠå¾‘ï¼ˆç±³ï¼‰
            const Ï†1 = pos1.coords.latitude * Math.PI/180;
            const Ï†2 = pos2.coords.latitude * Math.PI/180;
            const Î”Ï† = (pos2.coords.latitude - pos1.coords.latitude) * Math.PI/180;
            const Î”Î» = (pos2.coords.longitude - pos1.coords.longitude) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // è·é›¢ï¼ˆç±³ï¼‰
        }
        
        // æ›´æ–°ç§»å‹•æ•¸æ“š
        function updateMovementData(distance, position) {
            // æ ¹æ“šç§»å‹•é€Ÿåº¦åˆ¤æ–·äº¤é€šæ–¹å¼
            const speed = position.coords.speed || 0; // m/s
            let transportType = 'walking';
            let carbonFactor = 0.05; // kg CO2/km
            
            if (speed > 15) {
                transportType = 'driving';
                carbonFactor = 0.192; // æ±½è»Š
            } else if (speed > 5) {
                transportType = 'cycling';
                carbonFactor = 0.021; // è‡ªè¡Œè»Š
            } else if (speed > 1) {
                transportType = 'walking';
                carbonFactor = 0.05; // æ­¥è¡Œ
            }
            
            // è¨ˆç®—ç¢³è¶³è·¡
            const distanceKm = distance / 1000;
            const carbonFootprint = distanceKm * carbonFactor;
            
            // è¨˜éŒ„ç§»å‹•æ­·å²
            const movement = {
                timestamp: new Date().toISOString(),
                type: transportType,
                distance: distanceKm,
                speed: speed,
                carbonFootprint: carbonFootprint,
                position: {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                }
            };
            
            movementHistory.push(movement);
            
            // æ›´æ–°å¯¦æ™‚æ•¸æ“š
            realTimeData.transport += carbonFootprint;
            realTimeData.location += carbonFootprint * 0.1; // ä½ç½®è®ŠåŒ–é¡å¤–ç¢³è¶³è·¡
            
            // è‡ªå‹•è¨˜éŒ„ç§»å‹•
            if (distance > 10) { // ç§»å‹•è¶…é10ç±³æ‰è¨˜éŒ„
                autoRecordMovement(transportType, distanceKm, carbonFootprint);
            }
            
            // æ›´æ–°é¡¯ç¤º
            updateRealTimeDisplay();
        }
        
        // è‡ªå‹•è¨˜éŒ„ç§»å‹•
        async function autoRecordMovement(type, distance, carbonFootprint) {
            try {
                const response = await fetch(`${API_BASE}/api/movement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        type: type, 
                        distance: distance.toFixed(2),
                        duration: 1,
                        carbonFootprint: carbonFootprint
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('è‡ªå‹•è¨˜éŒ„ç§»å‹•ï¼š', result.data);
                    // ä¸èª¿ç”¨updateStatsï¼Œä½¿ç”¨å¯¦æ™‚æ•¸æ“š
                }
            } catch (error) {
                console.error('è‡ªå‹•è¨˜éŒ„å¤±æ•—ï¼š', error);
            }
        }
        
        // æ„Ÿæ‡‰å™¨æ•¸æ“šæ”¶é›†
        function startSensorTracking() {
            console.log('é–‹å§‹å•Ÿç”¨æ„Ÿæ‡‰å™¨...');
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæ„Ÿåº”å™¨
            if (!window.DeviceMotionEvent) {
                console.log('ç€è¦½å™¨ä¸æ”¯æ´æ„Ÿæ‡‰å™¨');
                document.getElementById('sensorStatus').textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´æ„Ÿæ‡‰å™¨';
                return;
            }
            
            // è¯·æ±‚æ„Ÿåº”å™¨æƒé™
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ éœ€è¦æƒé™è¯·æ±‚
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        console.log('âœ… iOS æ„Ÿæ‡‰å™¨æ¬Šé™å·²å…è¨±');
                        document.getElementById('sensorStatus').textContent = 'âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...';
                        startMotionListening();
                    } else {
                        console.log('âŒ iOS æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•');
                        document.getElementById('sensorStatus').textContent = 'âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•';
                    }
                }).catch(error => {
                    console.log('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—:', error);
                    document.getElementById('sensorStatus').textContent = 'âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—';
                });
            } else {
                // Android/æ¡Œé¢æµè§ˆå™¨ç›´æ¥å¯åŠ¨
                console.log('âœ… Android/æ¡Œé¢ å·²å•Ÿç”¨æ„Ÿæ‡‰å™¨ç›£è½');
                document.getElementById('sensorStatus').textContent = 'âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...';
                startMotionListening();
            }
        }
        
        function startMotionListening() {
            window.addEventListener('devicemotion', function(e) {
                if (e.acceleration) {
                    console.log("ğŸ“± devicemotion: åŠ é€Ÿåº¦X=" + e.acceleration.x);
                    handleMotion(e);
                }
            });
        }
        
        // è™•ç†åŠ é€Ÿåº¦è¨ˆæ•¸æ“š
        function handleMotion(event) {
            const acceleration = event.acceleration;
            const rotation = event.rotationRate;
            const sensorStatusElement = document.getElementById('sensorStatus');
            
            // æª¢æ¸¬ç§»å‹•æ¨¡å¼
            const totalAcceleration = Math.sqrt(
                acceleration.x * acceleration.x + 
                acceleration.y * acceleration.y + 
                acceleration.z * acceleration.z
            );
            
            // æ›´æ–°æ„Ÿæ‡‰å™¨ç‹€æ…‹
            sensorStatusElement.innerHTML = t('sensor_normal').replace('{acceleration}', totalAcceleration.toFixed(2));
            
            // æ ¹æ“šåŠ é€Ÿåº¦åˆ¤æ–·æ´»å‹•é¡å‹ä¸¦è¨ˆç®—ç¢³è¶³è·¡
            let activityType = 'éœæ­¢';
            let carbonFootprint = 0;
            
            if (totalAcceleration > 3) {
                activityType = 'åŠ‡çƒˆæ´»å‹•';
                carbonFootprint = 0.01; // åŠ‡çƒˆæ´»å‹•å¢åŠ ç¢³è¶³è·¡
                sensorStatusElement.innerHTML = `ğŸƒ åŠ‡çƒˆæ´»å‹• (åŠ é€Ÿåº¦: ${totalAcceleration.toFixed(2)}m/sÂ²)`;
            } else if (totalAcceleration > 2) {
                activityType = 'ä¸­åº¦æ´»å‹•';
                carbonFootprint = 0.005;
                sensorStatusElement.innerHTML = `ğŸš¶ ä¸­åº¦æ´»å‹• (åŠ é€Ÿåº¦: ${totalAcceleration.toFixed(2)}m/sÂ²)`;
            } else if (totalAcceleration > 1) {
                activityType = 'è¼•åº¦æ´»å‹•';
                carbonFootprint = 0.002;
                sensorStatusElement.innerHTML = `ğŸ‘¤ è¼•åº¦æ´»å‹• (åŠ é€Ÿåº¦: ${totalAcceleration.toFixed(2)}m/sÂ²)`;
            }
            
            // è¨˜éŒ„æ´»å‹•æ­·å²
            const activity = {
                timestamp: new Date().toISOString(),
                type: activityType,
                acceleration: totalAcceleration,
                carbonFootprint: carbonFootprint
            };
            
            activityHistory.push(activity);
            
            // æ›´æ–°å¯¦æ™‚æ•¸æ“š
            realTimeData.activity += carbonFootprint;
            realTimeData.sensor += carbonFootprint;
            
            // æ›´æ–°é¡¯ç¤º
            updateRealTimeDisplay();
        }
        
        // è™•ç†é™€èºå„€æ•¸æ“š
        function handleOrientation(event) {
            const alpha = event.alpha; // ç¹Zè»¸æ—‹è½‰
            const beta = event.beta;   // ç¹Xè»¸æ—‹è½‰
            const gamma = event.gamma; // ç¹Yè»¸æ—‹è½‰
            
            // å¯ä»¥æ ¹æ“šæ—‹è½‰æ•¸æ“šåˆ¤æ–·ç”¨æˆ¶è¡Œç‚º
        }
        
        // æ›´æ–°å¯¦æ™‚é¡¯ç¤º
        function updateRealTimeDisplay() {
            // è¨ˆç®—ç¸½ç¢³è¶³è·¡
            realTimeData.total = realTimeData.transport + realTimeData.shopping + 
                                realTimeData.activity + realTimeData.location + realTimeData.sensor;
            
            // æ›´æ–°ä¸»é¡¯ç¤º
            document.getElementById('realTimeCarbon').textContent = realTimeData.total.toFixed(2);
            
            // ä½¿ç”¨å€‹äººåŒ–ç›®æ¨™
            const dailyGoal = userProfile.personalizedGoal || 20.0;
            const progress = (realTimeData.total / dailyGoal) * 100;
            document.getElementById('realTimeProgress').style.width = Math.min(progress, 100) + '%';
            const goalText = t('daily_target').replace('20.0', dailyGoal.toFixed(1)).replace('0.0%', `${progress.toFixed(1)}%`);
            document.getElementById('realTimeGoal').textContent = goalText;
            
            // æ›´æ–°åˆ†è§£æ•¸æ“š
            document.getElementById('transportCarbon').textContent = realTimeData.transport.toFixed(2) + ' kg';
            document.getElementById('shoppingCarbon').textContent = realTimeData.shopping.toFixed(2) + ' kg';
            document.getElementById('activityCarbon').textContent = realTimeData.activity.toFixed(2) + ' kg';
            document.getElementById('locationCarbon').textContent = realTimeData.location.toFixed(2) + ' kg';
            document.getElementById('sensorCarbon').textContent = realTimeData.sensor.toFixed(2) + ' kg';
        }
        
        // å¯¦æ™‚æ•¸æ“šæ›´æ–°
        function startRealTimeUpdates() {
            // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ä½ç½®ä¿¡æ¯
            setInterval(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            updateLocationStatus(position);
                        },
                        function(error) {
                            console.log('ä½ç½®æ›´æ–°å¤±æ•—ï¼š', error);
                        },
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 10000 }
                    );
                }
            }, 5000);
            
            // æ¯10ç§’æ›´æ–°ä¸€æ¬¡å¯¦æ™‚é¡¯ç¤º
            setInterval(updateRealTimeDisplay, 10000);
        }
        
        // é é¢è¼‰å…¥æ™‚æ›´æ–°æ•¸æ“š
        window.onload = function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–å¤šèªè¨€ç³»çµ±');
            console.log('ç•¶å‰èªè¨€è¨­å®š:', currentLanguage);
            // åˆå§‹åŒ–å¤šèªè¨€ç³»çµ±
            updateLanguage();
            
            // åˆå§‹åŒ–è¼‰å…·ä¿¡æ¯
            const savedCarrierInfo = localStorage.getItem('carrierInfo');
            if (savedCarrierInfo) {
                carrierInfo = JSON.parse(savedCarrierInfo);
            }
            
            // åˆå§‹åŒ–ç”¨æˆ¶æª”æ¡ˆï¼ˆå¿…é ˆåœ¨initializeRealTimeDataä¹‹å‰ï¼‰
            const savedUserProfile = localStorage.getItem('userProfile');
            if (savedUserProfile) {
                userProfile = JSON.parse(savedUserProfile);
                // æ›´æ–°è¨­ç½®ç•Œé¢
                if (userProfile.ageGroup) {
                    document.getElementById('ageGroup').value = userProfile.ageGroup;
                }
                if (userProfile.residenceType) {
                    document.getElementById('residenceType').value = userProfile.residenceType;
                }
                if (userProfile.personalizedGoal) {
                    document.getElementById('dailyGoal').value = userProfile.personalizedGoal.toFixed(1);
                    document.getElementById('personalizedGoalDisplay').textContent = `${userProfile.personalizedGoal.toFixed(1)} å…¬æ–¤ COâ‚‚/å¤©`;
                }
            } else {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œæª¢æŸ¥æ˜¯å¦å·²è·³éå¼•å°
                const skipGuide = localStorage.getItem('skipPersonalizedSetup');
                if (!skipGuide) {
                    setTimeout(() => {
                        showFirstTimeGuide();
                    }, 2000);
                }
            }
            
            // åˆå§‹åŒ–å¯¦æ™‚æ•¸æ“š
            initializeRealTimeData();
            
            // åˆå§‹åŒ–ç‹€æ…‹é¡¯ç¤ºï¼ˆé‡ç½®ç‚ºæœªçŸ¥ç‹€æ…‹ï¼‰
            initializeStatusDisplay();
            
            updateCarrierStatus();
            loadRecentInvoices();
            
            // å¦‚æœå·²ç¶å®šè¼‰å…·ï¼Œå•Ÿå‹•è‡ªå‹•åµæ¸¬
            if (carrierInfo && carrierInfo.autoDetectEnabled) {
                startAutoInvoiceDetection();
            }
            
            // è‡ªå‹•å•Ÿå‹•GPSå’Œæ„Ÿæ‡‰å™¨ï¼ˆç„¡éœ€ç”¨æˆ¶äº¤äº’ï¼‰
            autoStartGPSAndSensor();
            
            startRealTimeUpdates();
            startAutoSync();
            
            // æ”¹å–„æ‰‹æ©Ÿé«”é©—
            improveMobileTouch();
            optimizeScrolling();
            
            // GPSæ¬Šé™è«‹æ±‚å·²ç§»è‡³ autoStartGPSAndSensor() ä¸­è™•ç†ï¼Œé¿å…é‡è¤‡è«‹æ±‚
            
            // é¡¯ç¤ºæ­¡è¿ä¿¡æ¯
            setTimeout(() => {
                const features = [
                    'å¯¦æ™‚GPSå®šä½è¿½è¹¤',
                    'ç›¸æ©Ÿæƒæç™¼ç¥¨',
                    'é›»å­ç™¼ç¥¨è¼‰å…·ç¶å®š',
                    'æ„Ÿæ‡‰å™¨æ´»å‹•ç›£æ¸¬',
                    'è‡ªå‹•ç§»å‹•è¨˜éŒ„',
                    'å¯¦æ™‚ç¢³è¶³è·¡è¨ˆç®—'
                ];
                
                alert(`ğŸŒ± æ­¡è¿ä½¿ç”¨ç¢³è¶³è·¡è¿½è¹¤å™¨ï¼\n\nâœ… å¯¦æ™‚åµæ¸¬åŠŸèƒ½å·²å•Ÿç”¨ï¼š\n${features.map(f => 'â€¢ ' + f).join('\n')}\n\nğŸ“Š æ‰€æœ‰æ•¸æ“šéƒ½æ˜¯å¯¦æ™‚åµæ¸¬çš„çœŸå¯¦æ•¸æ“šï¼\n\nè«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ä½ç½®å’Œç›¸æ©Ÿæ¬Šé™ä»¥ç²å¾—æœ€ä½³é«”é©—ï¼`);
            }, 2000);
        };
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
        
        // æ”¹å–„æ‰‹æ©Ÿè§¸æ§é«”é©—
        function improveMobileTouch() {
            // æª¢æ¸¬æ˜¯å¦ç‚ºiPhone Chrome
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            if (isIOS && isChrome) {
                // iPhone Chromeç‰¹æ®Šè™•ç†
                console.log('æª¢æ¸¬åˆ°iPhone Chromeï¼Œå•Ÿç”¨ç‰¹æ®Šå„ªåŒ–');
                
                // å¼·åˆ¶å•Ÿç”¨æ»¾å‹•
                document.body.style.overflow = 'auto';
                document.body.style.webkitOverflowScrolling = 'touch';
                
                // ç§»é™¤å¯èƒ½é˜»ç¤™æ»¾å‹•çš„æ¨£å¼
                document.body.style.position = 'relative';
                document.body.style.height = 'auto';
                
                // æ·»åŠ iPhone Chromeå°ˆç”¨æ»¾å‹•ä¿®å¾©
                document.addEventListener('touchstart', function(e) {
                    // ç¢ºä¿æ»¾å‹•å®¹å™¨
                    if (e.target.closest('.container')) {
                        e.target.closest('.container').style.webkitOverflowScrolling = 'touch';
                    }
                }, {passive: true});
                
            } else if (isIOS && isSafari) {
                // Safariæ­£å¸¸è™•ç†
                console.log('æª¢æ¸¬åˆ°Safariï¼Œä½¿ç”¨æ¨™æº–å„ªåŒ–');
            }
            
            // é€šç”¨æ»¾å‹•å„ªåŒ–
            document.addEventListener('touchstart', function() {}, {passive: true});
            document.addEventListener('touchmove', function() {}, {passive: true});
            document.addEventListener('touchend', function() {}, {passive: true});
            
            // å…è¨±æ¨¡æ…‹æ¡†å…§éƒ¨æ²å‹•
            document.addEventListener('touchmove', function(e) {
                // åªåœ¨æ¨¡æ…‹æ¡†å¤–éƒ¨æ™‚é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ
                if (e.target.closest('.modal-content')) {
                    // å…è¨±æ¨¡æ…‹æ¡†å…§å®¹æ²å‹•
                    return;
                }
                if (e.target.closest('.modal')) {
                    e.preventDefault();
                }
            }, {passive: false});
            
            // æ”¹å–„æŒ‰éˆ•è§¸æ§åé¥‹
            const buttons = document.querySelectorAll('.btn, .menu-item');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
                
                button.addEventListener('touchcancel', function() {
                    this.style.transform = '';
                });
            });
        }
        
        // å„ªåŒ–æ»¾å‹•æ€§èƒ½
        function optimizeScrolling() {
            // ä½¿ç”¨ requestAnimationFrame å„ªåŒ–æ»¾å‹•
            let ticking = false;
            
            function updateScroll() {
                // æ»¾å‹•æ™‚çš„å„ªåŒ–è™•ç†
                ticking = false;
            }
            
            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateScroll);
                    ticking = true;
                }
            }
            
            window.addEventListener('scroll', requestTick, {passive: true});
        }
        
        
        
        
        
        function getIOSLocationTroubleshooting(isIOS) {
            if (isIOS) {
                return `
                <div style="text-align: left; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">ğŸ“± iPhone GPSæ•…éšœæ’é™¤ï¼š</h4>
                    <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>æª¢æŸ¥ç³»çµ±è¨­å®š</strong>ï¼šè¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨æ€§ â†’ å®šä½æœå‹™</li>
                        <li><strong>ç¢ºä¿å®šä½æœå‹™å·²é–‹å•Ÿ</strong></li>
                        <li><strong>æª¢æŸ¥ç€è¦½å™¨æ¬Šé™</strong>ï¼šæ‰¾åˆ°Safariæˆ–Chrome â†’ é¸æ“‡ã€Œä½¿ç”¨AppæœŸé–“ã€</li>
                        <li><strong>å˜—è©¦é‡æ–°å•Ÿå‹•ç€è¦½å™¨</strong></li>
                        <li><strong>æª¢æŸ¥ç¶²è·¯é€£ç·š</strong>ï¼šGPSéœ€è¦ç¶²è·¯è¼”åŠ©å®šä½</li>
                        <li><strong>å˜—è©¦åˆ°æˆ¶å¤–é–‹é—Šåœ°å¸¶</strong>ï¼šå®¤å…§å¯èƒ½å½±éŸ¿GPSä¿¡è™Ÿ</li>
                    </ol>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #1976d2; margin: 0; font-weight: bold;">ğŸ’¡ å¦‚æœå•é¡ŒæŒçºŒï¼š</p>
                        <ul style="color: #1976d2; margin: 5px 0 0 0; padding-left: 20px;">
                            <li>å˜—è©¦ä½¿ç”¨Safariç€è¦½å™¨</li>
                            <li>é‡æ–°å•Ÿå‹•iPhone</li>
                            <li>æ›´æ–°iOSç³»çµ±</li>
                        </ul>
                    </div>
                </div>
                `;
            }
            return '';
        }
        
        function getTimeoutInstructions(isIOS) {
            if (isIOS) {
                return `
                <div style="text-align: left; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">â±ï¸ GPSå®šä½è¶…æ™‚è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                    <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>æª¢æŸ¥ç¶²è·¯é€£ç·š</strong>ï¼šç¢ºä¿WiFiæˆ–è¡Œå‹•æ•¸æ“šæ­£å¸¸</li>
                        <li><strong>åˆ°æˆ¶å¤–é–‹é—Šåœ°å¸¶</strong>ï¼šé é›¢å»ºç¯‰ç‰©å’Œé®è”½ç‰©</li>
                        <li><strong>ç­‰å¾…æ›´é•·æ™‚é–“</strong>ï¼šé¦–æ¬¡å®šä½å¯èƒ½éœ€è¦30ç§’-2åˆ†é˜</li>
                        <li><strong>é‡æ–°æ•´ç†é é¢</strong>å¾Œé‡è©¦</li>
                        <li><strong>å˜—è©¦ä½¿ç”¨Safari</strong>ï¼šSafariçš„GPSæ”¯æ´æ›´ç©©å®š</li>
                    </ol>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #2e7d32; margin: 0; font-weight: bold;">ğŸ”„ é‡æ–°å˜—è©¦ï¼š</p>
                        <button onclick="checkPermissions()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 5px;">
                            å†æ¬¡æª¢æŸ¥æ¬Šé™
                        </button>
                    </div>
                </div>
                `;
            }
            return '';
        }
        
        function showPermissionResult(message, type, isIOS, isChrome, isSafari, instructions = '') {
            const resultDiv = document.getElementById('permission-result');
            if (resultDiv) {
                resultDiv.innerHTML = `
                    <div style="padding: 15px; margin: 10px 0; border-radius: 8px; 
                                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#fff3cd'}; 
                                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#856404'}; 
                                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#ffeaa7'};">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                            ${message}
                        </div>
                        ${instructions}
                    </div>
                `;
            }
        }
        
        
        
        // åˆå§‹åŒ–ç‹€æ…‹é¡¯ç¤ºï¼ˆé‡ç½®ç‚ºæœªçŸ¥ç‹€æ…‹ï¼‰
        function initializeStatusDisplay() {
            console.log('åˆå§‹åŒ–ç‹€æ…‹é¡¯ç¤º - Web Appéœ€è¦ç”¨æˆ¶ä¸»å‹•å•Ÿç”¨');
            
            // è¨­ç½®åˆå§‹ç‹€æ…‹ - Web Appéœ€è¦ç”¨æˆ¶ä¸»å‹•å•Ÿç”¨
            document.getElementById('locationStatusText').textContent = 'ğŸ“ é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨GPSå®šä½';
            document.getElementById('gpsStatus').textContent = 'âš ï¸ GPSéœ€è¦æ‰‹å‹•å•Ÿç”¨ï¼Œè«‹é»æ“ŠæŒ‰éˆ•å…è¨±ä½ç½®æ¬Šé™';
            document.getElementById('sensorStatus').textContent = 'âš ï¸ æ„Ÿæ‡‰å™¨éœ€è¦æ‰‹å‹•å•Ÿç”¨ï¼Œè«‹é»æ“ŠæŒ‰éˆ•å…è¨±å‹•ä½œæ¬Šé™';
            document.getElementById('autoTracking').textContent = 'âš ï¸ è«‹å…ˆå•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½';
        }
        
        // å¼·åˆ¶è«‹æ±‚æ¬Šé™ï¼ˆæœ€ç°¡åŒ–ç‰ˆæœ¬ï¼‰
        function forceRequestPermissions() {
            console.log('ğŸ‘‰ é–‹å§‹è«‹æ±‚ GPS + æ„Ÿæ‡‰å™¨æ¬Šé™...');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const enableBtn = document.getElementById('enableBtn');
            if (enableBtn) {
                enableBtn.innerHTML = 'ğŸ”„ æ­£åœ¨è«‹æ±‚æ¬Šé™...';
                enableBtn.disabled = true;
                enableBtn.style.background = '#6c757d';
            }
            
            // é‡ç½®ç‹€æ…‹
            updateLocationStatus(null, 'ğŸ”„ æ­£åœ¨è«‹æ±‚GPSæ¬Šé™...');
            updateSensorStatus('ğŸ”„ æ­£åœ¨è«‹æ±‚æ„Ÿæ‡‰å™¨æ¬Šé™...');
            
            // === GPS æ¬Šé™ ===
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('âœ… GPS å•Ÿç”¨æˆåŠŸ:', position.coords.latitude, position.coords.longitude);
                        updateLocationStatus(position, null);
                        startGPSTracking();
                    },
                    function(error) {
                        console.log('âŒ GPS å•Ÿç”¨å¤±æ•—:', error.message);
                        if (error.code === 1) {
                            updateLocationStatus(null, 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹æ‰‹å‹•å…è¨±ä½ç½®æ¬Šé™');
                        } else if (error.code === 2) {
                            updateLocationStatus(null, 'âŒ GPSä½ç½®ä¸å¯ç”¨');
                        } else if (error.code === 3) {
                            updateLocationStatus(null, 'âŒ GPSå®šä½è¶…æ™‚');
                        } else {
                            updateLocationStatus(null, 'âŒ GPSå®šä½å¤±æ•—');
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´ GPS API');
                updateLocationStatus(null, 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½');
            }
            
            // === æ„Ÿæ‡‰å™¨æ¬Šé™ ===
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === "granted") {
                        console.log("âœ… iOS æ„Ÿæ‡‰å™¨æ¬Šé™å·²å…è¨±");
                        updateSensorStatus('âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...');
                        startSensorTracking();
                    } else {
                        console.log("âŒ iOS æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•");
                        updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•');
                    }
                }).catch(error => {
                    console.log("âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—:", error);
                    updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•');
                });
            } else {
                // Android / æ¡Œé¢ Chrome ç›´æ¥ç›£è½
                console.log("âœ… Android/æ¡Œé¢ å·²å•Ÿç”¨æ„Ÿæ‡‰å™¨ç›£è½");
                updateSensorStatus('âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...');
                startSensorTracking();
            }
            
            // è‡ªå‹•è¿½è¹¤åŠŸèƒ½
            updateAutoTrackingStatus(t('auto_tracking_enabled'));
            
            // 3ç§’å¾Œæ¢å¾©æŒ‰éˆ•
            setTimeout(() => {
                if (enableBtn) {
                    enableBtn.innerHTML = 'ğŸš€ å¼·åˆ¶è«‹æ±‚æ¬Šé™';
                    enableBtn.disabled = false;
                    enableBtn.style.background = '#28a745';
                }
            }, 3000);
        }
        
        // æœ€ç°¡å–®çš„GPSæ¸¬è©¦
        function testGPSOnly() {
            console.log('ğŸ‘‰ é–‹å§‹æ¸¬è©¦GPSæ¬Šé™...');
            
            const enableBtn = document.getElementById('enableBtn');
            if (enableBtn) {
                enableBtn.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦GPS...';
                enableBtn.disabled = true;
                enableBtn.style.background = '#6c757d';
            }
            
            updateLocationStatus(null, 'ğŸ”„ æ­£åœ¨æ¸¬è©¦GPSæ¬Šé™...');
            
            if (!navigator.geolocation) {
                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´GPS');
                updateLocationStatus(null, 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPS');
                if (enableBtn) {
                    enableBtn.innerHTML = 'âŒ ä¸æ”¯æ´GPS';
                    setTimeout(() => {
                        enableBtn.innerHTML = 'ğŸš€ æ¸¬è©¦GPSæ¬Šé™';
                        enableBtn.disabled = false;
                        enableBtn.style.background = '#28a745';
                    }, 3000);
                }
                return;
            }
            
            // ç›´æ¥åœ¨ç”¨æˆ¶é»æ“Šäº‹ä»¶ä¸­è«‹æ±‚GPSæ¬Šé™
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('âœ… GPSæ¬Šé™æˆåŠŸï¼');
                    console.log('åº§æ¨™:', position.coords.latitude, position.coords.longitude);
                    updateLocationStatus(position, null);
                    
                    if (enableBtn) {
                        enableBtn.innerHTML = 'âœ… GPSæˆåŠŸï¼';
                        enableBtn.style.background = '#28a745';
                        setTimeout(() => {
                            enableBtn.innerHTML = 'ğŸš€ æ¸¬è©¦GPSæ¬Šé™';
                            enableBtn.disabled = false;
                        }, 3000);
                    }
                },
                function(error) {
                    console.log('âŒ GPSæ¬Šé™å¤±æ•—:', error.message);
                    console.log('éŒ¯èª¤ä»£ç¢¼:', error.code);
                    
                    if (error.code === 1) {
                        updateLocationStatus(null, 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ä½ç½®æ¬Šé™');
                        console.log('ğŸ’¡ è«‹æª¢æŸ¥ç€è¦½å™¨ä½ç½®æ¬Šé™è¨­å®š');
                    } else if (error.code === 2) {
                        updateLocationStatus(null, 'âŒ GPSä½ç½®ä¸å¯ç”¨');
                    } else if (error.code === 3) {
                        updateLocationStatus(null, 'âŒ GPSå®šä½è¶…æ™‚');
                    } else {
                        updateLocationStatus(null, 'âŒ GPSå®šä½å¤±æ•—');
                    }
                    
                    if (enableBtn) {
                        enableBtn.innerHTML = 'âŒ GPSå¤±æ•—';
                        enableBtn.style.background = '#dc3545';
                        setTimeout(() => {
                            enableBtn.innerHTML = 'ğŸš€ æ¸¬è©¦GPSæ¬Šé™';
                            enableBtn.disabled = false;
                            enableBtn.style.background = '#28a745';
                        }, 3000);
                    }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // åˆå§‹åŒ–GPSå’Œæ„Ÿæ‡‰å™¨ç‹€æ…‹ï¼ˆWeb Appéœ€è¦ç”¨æˆ¶ä¸»å‹•å•Ÿç”¨ï¼‰
        function autoStartGPSAndSensor() {
            console.log('ğŸš€ åˆå§‹åŒ–GPSå’Œæ„Ÿæ‡‰å™¨ç‹€æ…‹...');
            
            // è¨­ç½®åˆå§‹ç‹€æ…‹ - å¼•å°ç”¨æˆ¶ä¸»å‹•å•Ÿç”¨
            document.getElementById('locationStatusText').textContent = 'ğŸ“ é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨GPSå®šä½';
            document.getElementById('gpsStatus').textContent = 'âš ï¸ GPSéœ€è¦æ‰‹å‹•å•Ÿç”¨ï¼Œè«‹é»æ“ŠæŒ‰éˆ•å…è¨±ä½ç½®æ¬Šé™';
            document.getElementById('sensorStatus').textContent = 'âš ï¸ æ„Ÿæ‡‰å™¨éœ€è¦æ‰‹å‹•å•Ÿç”¨ï¼Œè«‹é»æ“ŠæŒ‰éˆ•å…è¨±å‹•ä½œæ¬Šé™';
            document.getElementById('autoTracking').textContent = 'âš ï¸ è«‹å…ˆå•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½';
            
            // é¡¯ç¤ºå•Ÿç”¨æŒ‰éˆ•
            document.getElementById('enableBtn').style.display = 'block';
            document.getElementById('statusMessage').textContent = 'ğŸ“ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½';
        }

        // å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½
        function enableGPSAndSensor() {
            console.log('ğŸš€ ç”¨æˆ¶é»æ“Šå•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½');
            
            const button = document.querySelector('#enableBtn button');
            const statusMessage = document.getElementById('statusMessage');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            button.innerHTML = 'ğŸ”„ æ­£åœ¨å•Ÿç”¨åŠŸèƒ½...';
            button.disabled = true;
            
            // æ›´æ–°ç‹€æ…‹æ¶ˆæ¯
            statusMessage.textContent = 'ğŸ”„ æ­£åœ¨è«‹æ±‚GPSå’Œæ„Ÿæ‡‰å™¨æ¬Šé™...';
            
            // å…ˆå•Ÿå‹•æ„Ÿæ‡‰å™¨
            startSensorTracking();
            
            // å†å•Ÿå‹•GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('ğŸ“ GPSæ¬Šé™ç²å¾—ï¼Œé–‹å§‹è¿½è¹¤');
                        document.getElementById('locationStatusText').textContent = t('gps_success_status');
                        document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                        
                        // è¨­ç½®åˆå§‹ä½ç½®
                        lastPosition = position;
                        isTracking = true;
                        
                        // é–‹å§‹æŒçºŒè¿½è¹¤
                        window.gpsWatchId = navigator.geolocation.watchPosition(
                            function(pos) {
                                if (lastPosition && isTracking) {
                                    const distance = calculateDistance(lastPosition, pos);
                                    totalDistance += distance;
                                    updateMovementData(distance, pos);
                                }
                                lastPosition = pos;
                                updateRealTimeDisplay();
                            },
                            function(error) {
                                console.log('âŒ GPS ç›£è½å¤±æ•—:', error.message);
                            },
                            { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
                        );
                        
                        // æª¢æŸ¥æ„Ÿæ‡‰å™¨ç‹€æ…‹ä¸¦æ›´æ–°æŒ‰éˆ•
                        setTimeout(() => {
                            const sensorStatus = document.getElementById('sensorStatus').textContent;
                            // æ£€æŸ¥æ„Ÿåº”å™¨æ˜¯å¦æ­£å¸¸ï¼ˆåŒ…å«"æ­£å¸¸"ã€"ğŸ“Š"æˆ–"âœ…"éƒ½è¡¨ç¤ºæˆåŠŸï¼‰
                            if (sensorStatus.includes('âœ…') || sensorStatus.includes('æ­£å¸¸') || sensorStatus.includes('å·²å•Ÿç”¨') || sensorStatus.includes('ğŸ“Š')) {
                                document.getElementById('autoTracking').textContent = t('auto_tracking_enabled');
                                statusMessage.textContent = t('gps_sensor_monitoring');
                                button.style.display = 'none'; // éš±è—æŒ‰éˆ•
                            } else {
                                document.getElementById('autoTracking').textContent = t('gps_waiting_sensor');
                                statusMessage.textContent = t('gps_waiting_permission');
                                
                                // æ¢å¾©æŒ‰éˆ•ç‚ºå¯ç”¨ç‹€æ…‹ï¼Œä½†ä¿æŒéš±è—ï¼ˆå› ç‚ºGPSå·²æˆåŠŸï¼‰
                                button.innerHTML = 'ğŸš€ é‡æ–°å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½';
                                button.disabled = false;
                                button.style.display = 'none';
                            }
                        }, 3000); // å¢åŠ ç­‰å¾…æ—¶é—´åˆ°3ç§’
                    },
                    function(error) {
                        console.log('âŒ GPSæ¬Šé™è¢«æ‹’çµ•:', error.message);
                        let errorMsg = 'âŒ GPSå®šä½å¤±æ•—: ' + error.message;
                        if (error.code === error.TIMEOUT) {
                            errorMsg = 'âŒ GPSå®šä½è¶…æ™‚ï¼Œè«‹é‡è©¦';
                        } else if (error.code === error.PERMISSION_DENIED) {
                            errorMsg = 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ä½ç½®æ¬Šé™';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg = 'âŒ GPSä½ç½®ä¸å¯ç”¨ï¼Œè«‹æª¢æŸ¥GPSè¨­å®š';
                        }
                        document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                        document.getElementById('gpsStatus').textContent = errorMsg;
                        statusMessage.textContent = 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é‡æ–°é»æ“ŠæŒ‰éˆ•ä¸¦å…è¨±æ¬Šé™';
                        
                        // æ¢å¾©æŒ‰éˆ•
                        button.innerHTML = 'ğŸš€ é‡æ–°å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½';
                        button.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
                );
            } else {
                document.getElementById('gpsStatus').textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPS';
                statusMessage.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSåŠŸèƒ½';
                button.innerHTML = 'ğŸš€ é‡æ–°å•Ÿç”¨GPSå’Œæ„Ÿæ‡‰å™¨åŠŸèƒ½';
                button.disabled = false;
            }
        }

        // Chromeå°ˆç”¨GPSæ¬Šé™è«‹æ±‚
        function requestChromeGPSPermission() {
            console.log('ğŸ“ Chrome GPSæ¬Šé™è«‹æ±‚...');
            
            const button = document.querySelector('#chromeGPSButton button');
            const statusMessage = document.getElementById('statusMessage');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            button.innerHTML = 'ğŸ”„ æ­£åœ¨è«‹æ±‚GPSæ¬Šé™...';
            button.disabled = true;
            button.style.background = '#6c757d';
            
            if (!navigator.geolocation) {
                statusMessage.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½';
                button.innerHTML = 'âŒ ä¸æ”¯æ´GPS';
                return;
            }
            
            // è«‹æ±‚GPSæ¬Šé™
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('âœ… Chrome GPSæ¬Šé™ç²å¾—æˆåŠŸï¼');
                    
                    // æ›´æ–°ç‹€æ…‹
                    document.getElementById('locationStatusText').textContent = t('gps_success_status');
                    document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                    statusMessage.textContent = 'âœ… Chrome GPSå®šä½å·²å•Ÿç”¨ï¼Œæ­£åœ¨ç›£æ¸¬æ‚¨çš„ç¢³è¶³è·¡';
                    
                    // éš±è—æŒ‰éˆ•
                    document.getElementById('chromeGPSButton').style.display = 'none';
                    
                    // é–‹å§‹æŒçºŒè¿½è¹¤
                    window.gpsWatchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            if (lastPosition && isTracking) {
                                const distance = calculateDistance(lastPosition, pos);
                                totalDistance += distance;
                                updateMovementData(distance, pos);
                            }
                            lastPosition = pos;
                            isTracking = true;
                            updateRealTimeDisplay();
                        },
                        function(error) {
                            console.log('âŒ GPS ç›£è½å¤±æ•—:', error.message);
                        },
                        { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
                    );
                    
                    isTracking = true;
                },
                function(error) {
                    console.log('âŒ Chrome GPSæ¬Šé™è¢«æ‹’çµ•:', error.message);
                    
                    let errorMsg = 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±ä½ç½®æ¬Šé™';
                    } else if (error.code === error.TIMEOUT) {
                        errorMsg = 'âŒ GPSå®šä½è¶…æ™‚ï¼Œè«‹é‡è©¦';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMsg = 'âŒ GPSä½ç½®ä¸å¯ç”¨ï¼Œè«‹æª¢æŸ¥GPSè¨­å®š';
                    }
                    
                    document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                    document.getElementById('gpsStatus').textContent = errorMsg;
                    statusMessage.textContent = 'âŒ GPSå®šä½å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–ä½¿ç”¨Safariç€è¦½å™¨';
                    
                    // æ¢å¾©æŒ‰éˆ•
                    button.innerHTML = 'ğŸ“ é‡æ–°å˜—è©¦å•Ÿç”¨GPS';
                    button.disabled = false;
                    button.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%)';
                },
                { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
            );
        }

        // æ¸¬è©¦GPSå®šä½
        function testGPS() {
            console.log('ğŸ“ æ¸¬è©¦GPSå®šä½...');
            
            const gpsBtn = document.getElementById('gpsBtn');
            if (gpsBtn) {
                gpsBtn.innerHTML = 'ğŸ”„ æ­£åœ¨è«‹æ±‚GPSæ¬Šé™...';
                gpsBtn.disabled = true;
                gpsBtn.style.background = '#6c757d';
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('âœ… GPSå®šä½æˆåŠŸï¼');
                        document.getElementById('locationStatusText').textContent = t('gps_success_status');
                        document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                        
                        // é–‹å§‹GPSè¿½è¹¤
                        startGPSTracking();
                        
                        if (gpsBtn) {
                            gpsBtn.innerHTML = 'âœ… GPSå·²å•Ÿç”¨';
                            gpsBtn.style.background = '#28a745';
                            setTimeout(() => {
                                gpsBtn.innerHTML = 'ğŸ“ å•Ÿç”¨GPSå®šä½';
                                gpsBtn.disabled = false;
                            }, 2000);
                        }
                    },
                    function(error) {
                        console.log('âŒ GPSå®šä½å¤±æ•—:', error.message);
                        document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                        document.getElementById('gpsStatus').textContent = 'âŒ GPSå®šä½å¤±æ•—: ' + error.message;
                        
                        if (gpsBtn) {
                            gpsBtn.innerHTML = 'âŒ GPSå¤±æ•—';
                            gpsBtn.style.background = '#dc3545';
                            setTimeout(() => {
                                gpsBtn.innerHTML = 'ğŸ“ å•Ÿç”¨GPSå®šä½';
                                gpsBtn.disabled = false;
                                gpsBtn.style.background = '#28a745';
                            }, 2000);
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´GPS');
                document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                document.getElementById('gpsStatus').textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½';
                
                if (gpsBtn) {
                    gpsBtn.innerHTML = 'âŒ ä¸æ”¯æ´GPS';
                    setTimeout(() => {
                        gpsBtn.innerHTML = 'ğŸ“ å•Ÿç”¨GPSå®šä½';
                        gpsBtn.disabled = false;
                        gpsBtn.style.background = '#28a745';
                    }, 2000);
                }
            }
        }

        // åŒæ™‚æ¸¬è©¦GPSå’Œæ„Ÿæ‡‰å™¨æ¬Šé™
        function testBothPermissions() {
            console.log('ğŸ‘‰ é–‹å§‹æ¸¬è©¦GPSå’Œæ„Ÿæ‡‰å™¨æ¬Šé™...');
            
            const enableBtn = document.getElementById('enableBtn');
            if (enableBtn) {
                enableBtn.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦æ¬Šé™...';
                enableBtn.disabled = true;
                enableBtn.style.background = '#6c757d';
            }
            
            // æ¸…é™¤ä¹‹å‰çš„GPSç›£è½ï¼Œé¿å…è¡çª
            if (window.gpsWatchId) {
                navigator.geolocation.clearWatch(window.gpsWatchId);
                window.gpsWatchId = null;
            }
            
            // ç›´æ¥æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            document.getElementById('locationStatusText').textContent = 'ğŸ”„ æ­£åœ¨è«‹æ±‚GPSæ¬Šé™...';
            document.getElementById('gpsStatus').textContent = 'ğŸ”„ æ­£åœ¨è«‹æ±‚GPSæ¬Šé™...';
            document.getElementById('sensorStatus').textContent = 'ğŸ”„ æ­£åœ¨è«‹æ±‚æ„Ÿæ‡‰å™¨æ¬Šé™...';
            
            // === GPS æ¬Šé™ ===
            if (navigator.geolocation) {
                console.log('é–‹å§‹è«‹æ±‚GPSæ¬Šé™...');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('âœ… GPSæ¬Šé™æˆåŠŸï¼');
                        console.log('åº§æ¨™:', position.coords.latitude, position.coords.longitude);
                        
                        // ç›´æ¥æ›´æ–°ç‹€æ…‹
                        document.getElementById('locationStatusText').textContent = t('gps_success_status');
                        document.getElementById('gpsStatus').textContent = t('gps_success_accuracy').replace('{accuracy}', position.coords.accuracy.toFixed(0));
                        
                        // é–‹å§‹GPSè¿½è¹¤ï¼ˆä¸é‡è¤‡å•Ÿå‹•ï¼‰
                        if (!window.gpsWatchId) {
                            startGPSTracking();
                        }
                        
                        if (enableBtn) {
                            enableBtn.innerHTML = 'âœ… GPSæˆåŠŸï¼';
                            enableBtn.style.background = '#28a745';
                            setTimeout(() => {
                                enableBtn.innerHTML = 'ğŸš€ æ¸¬è©¦GPSå’Œæ„Ÿæ‡‰å™¨æ¬Šé™';
                                enableBtn.disabled = false;
                            }, 2000);
                        }
                    },
                    function(error) {
                        console.log('âŒ GPSæ¬Šé™å¤±æ•—:', error.message);
                        console.log('éŒ¯èª¤ä»£ç¢¼:', error.code);
                        
                        let errorMsg = '';
                        if (error.code === 1) {
                            errorMsg = 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ä½ç½®æ¬Šé™';
                        } else if (error.code === 2) {
                            errorMsg = 'âŒ GPSä½ç½®ä¸å¯ç”¨';
                        } else if (error.code === 3) {
                            errorMsg = 'âŒ GPSå®šä½è¶…æ™‚';
                        } else {
                            errorMsg = 'âŒ GPSå®šä½å¤±æ•—';
                        }
                        
                        // ç›´æ¥æ›´æ–°ç‹€æ…‹
                        document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                        document.getElementById('gpsStatus').textContent = errorMsg;
                        
                        if (enableBtn) {
                            enableBtn.innerHTML = 'âŒ GPSå¤±æ•—';
                            enableBtn.style.background = '#dc3545';
                            setTimeout(() => {
                                enableBtn.innerHTML = 'ğŸš€ æ¸¬è©¦GPSå’Œæ„Ÿæ‡‰å™¨æ¬Šé™';
                                enableBtn.disabled = false;
                                enableBtn.style.background = '#28a745';
                            }, 2000);
                        }
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´GPS');
                document.getElementById('locationStatusText').textContent = 'ğŸ“ GPSå®šä½å¤±æ•— | è«‹æª¢æŸ¥æ¬Šé™è¨­å®š';
                document.getElementById('gpsStatus').textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPS';
                
                if (enableBtn) {
                    enableBtn.innerHTML = 'âŒ ä¸æ”¯æ´GPS';
                    setTimeout(() => {
                        enableBtn.innerHTML = 'ğŸš€ æ¸¬è©¦GPSå’Œæ„Ÿæ‡‰å™¨æ¬Šé™';
                        enableBtn.disabled = false;
                        enableBtn.style.background = '#28a745';
                    }, 2000);
                }
            }
            
            // === æ„Ÿæ‡‰å™¨æ¬Šé™ ===
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                console.log('æ­£åœ¨è«‹æ±‚æ„Ÿæ‡‰å™¨æ¬Šé™...');
                DeviceMotionEvent.requestPermission().then(response => {
                    console.log('æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚çµæœ:', response);
                    if (response === "granted") {
                        console.log("âœ… æ„Ÿæ‡‰å™¨æ¬Šé™å·²å…è¨±");
                        document.getElementById('sensorStatus').textContent = t('sensor_enabled');
                        startSensorTracking();
                    } else {
                        console.log("âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•");
                        document.getElementById('sensorStatus').textContent = t('sensor_permission_denied');
                    }
                }).catch(error => {
                    console.log("âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—:", error);
                    document.getElementById('sensorStatus').textContent = t('sensor_permission_failed');
                });
            } else {
                // Android / æ¡Œé¢ Chrome ç›´æ¥ç›£è½
                console.log("âœ… Android/æ¡Œé¢ å·²å•Ÿç”¨æ„Ÿæ‡‰å™¨ç›£è½");
                document.getElementById('sensorStatus').textContent = t('sensor_enabled');
                startSensorTracking();
            }
            
            // è‡ªå‹•è¿½è¹¤åŠŸèƒ½
            document.getElementById('autoTracking').textContent = t('auto_tracking_enabled');
        }
        
        
        // é¡¯ç¤ºæ¯æ—¥è¨˜éŒ„
        function triggerDailyRecord() {
            const today = new Date().toISOString().split('T')[0];
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            // ç²å–ä»Šæ—¥è¨˜éŒ„
            const todayRecord = dailyRecords[today];
            
            // å‰µå»ºç¾è§€çš„æ¨¡æ…‹æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“…</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">${t('daily_stats')}</h3>
                            <div style="font-size: 14px; opacity: 0.9;">${t('today_total')} + ${t('select_range')}</div>
                        </div>
                        
                        <!-- ä»Šæ—¥è¨˜éŒ„ -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center;">ğŸ“… ä»Šæ—¥è¨˜éŒ„ (${today})</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>ğŸª è³¼ç‰©:</span>
                                <span>${(todayRecord && todayRecord.shopping) ? todayRecord.shopping.toFixed(2) : '0.00'} kg COâ‚‚</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>ğŸš— äº¤é€š:</span>
                                <span>${(todayRecord && todayRecord.transport) ? todayRecord.transport.toFixed(2) : '0.00'} kg COâ‚‚</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                                <span>ğŸƒ æ´»å‹•:</span>
                                <span>${(todayRecord && todayRecord.activity) ? todayRecord.activity.toFixed(2) : '0.00'} kg COâ‚‚</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                <span>ğŸ“‹ å…¶ä»–:</span>
                                <span>${(todayRecord && todayRecord.other) ? todayRecord.other.toFixed(2) : '0.00'} kg COâ‚‚</span>
                            </div>
                            <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 15px; font-weight: bold;">
                                <span>ğŸ“Š ä»Šæ—¥ç¸½è¨ˆ:</span>
                                <span>${(todayRecord && todayRecord.totalCarbon) ? todayRecord.totalCarbon.toFixed(2) : '0.00'} kg COâ‚‚</span>
                            </div>
                            ${!todayRecord || todayRecord.totalCarbon === 0 ? `
                                <div style="text-align: center; font-size: 12px; opacity: 0.7; margin-top: 8px;">ğŸ’¡ è«‹å…ˆæƒæç™¼ç¥¨æˆ–è¨˜éŒ„ç§»å‹•è»Œè·¡ä¾†é–‹å§‹è¿½è¹¤</div>
                            ` : ''}
                        </div>
                        
                        <!-- æ™‚é–“ç¯„åœé¸æ“‡ -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center;" data-lang="select_range">â° é¸æ“‡çµ±è¨ˆæ™‚é–“ç¯„åœ</div>
                            
                            <!-- å¿«é€Ÿé¸é … -->
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 14px; margin-bottom: 8px; text-align: center;" data-lang="common_ranges">å¸¸ç”¨æ™‚é–“ç¯„åœ</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;">
                                    <button onclick="quickSelectDays(3)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_3')}</button>
                                    <button onclick="quickSelectDays(7)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_7')}</button>
                                    <button onclick="quickSelectDays(30)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_30')}</button>
                                    <button onclick="quickSelectDays(60)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_60_alt">è¿‘2å€‹æœˆ</button>
                                    <button onclick="quickSelectDays(90)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_90">è¿‘3å€‹æœˆ</button>
                                    <button onclick="quickSelectDays(120)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_120">è¿‘4å€‹æœˆ</button>
                                    <button onclick="quickSelectDays(150)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;" data-lang="days_150">è¿‘5å€‹æœˆ</button>
                                    <button onclick="quickSelectDays(180)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 10px;">${t('days_180')}</button>
                                </div>
                            </div>
                            
                            <!-- è‡ªå®šç¾©è¼¸å…¥ -->
                            <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                <span style="font-size: 13px;">${t('custom_days')}ï¼š</span>
                                <input type="number" id="daysInput" value="7" min="1" max="180" style="width: 50px; padding: 4px; border: 1px solid white; border-radius: 4px; background: rgba(255,255,255,0.2); color: white; text-align: center; font-size: 12px;">
                                <span style="font-size: 13px;">å¤©</span>
                                <button onclick="showCustomPeriodStats()" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">æŸ¥çœ‹</button>
                            </div>
                            <div style="font-size: 11px; opacity: 0.8; text-align: center; margin-top: 5px;">å¯è¨­å®š1-180å¤©</div>
                        </div>
                        
                        <!-- çµ±è¨ˆçµæœå€åŸŸ -->
                        <div id="periodStats" style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px; display: none;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center;" id="periodTitle">ğŸ“ˆ çµ±è¨ˆçµæœ</div>
                            <div id="periodContent"></div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeModal(this)" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 30px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">${t('close')}</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // å¿«é€Ÿé¸æ“‡å¤©æ•¸
        function quickSelectDays(days) {
            const daysInput = document.getElementById('daysInput');
            daysInput.value = days;
            showPeriodStats(days);
        }
        
        // é¡¯ç¤ºç”¨æˆ¶è‡ªå®šç¾©æ™‚é–“ç¯„åœçš„çµ±è¨ˆ
        function showCustomPeriodStats() {
            const daysInput = document.getElementById('daysInput');
            const days = parseInt(daysInput.value);
            
            if (isNaN(days) || days < 1) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å¤©æ•¸ï¼ˆ1-180å¤©ï¼‰');
                return;
            }
            
            if (days > 180) {
                alert('æœ€å¤šåªèƒ½æŸ¥çœ‹180å¤©ï¼ˆ6å€‹æœˆï¼‰çš„çµ±è¨ˆ');
                daysInput.value = 180;
                return;
            }
            
            showPeriodStats(days);
        }
        
        // é¡¯ç¤ºæŒ‡å®šæ™‚é–“ç¯„åœçš„çµ±è¨ˆ
        function showPeriodStats(days) {
            const dailyRecords = JSON.parse(localStorage.getItem('dailyCarbonRecords') || '{}');
            
            // è¨ˆç®—æŒ‡å®šå¤©æ•¸å‰çš„æ—¥æœŸ
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days + 1);
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            let totalShopping = 0;
            let totalTransport = 0;
            let totalActivity = 0;
            let totalOther = 0;
            let totalCarbon = 0;
            let totalInvoices = 0;
            let recordDays = 0;
            
            // è¨ˆç®—æŒ‡å®šæ™‚é–“ç¯„åœå…§çš„ç´¯ç©æ•¸æ“š
            Object.keys(dailyRecords).forEach(date => {
                if (date >= startDateStr && date <= endDateStr) {
                    const record = dailyRecords[date];
                    totalShopping += record.shopping || 0;
                    totalTransport += record.transport || 0;
                    totalActivity += record.activity || 0;
                    totalOther += record.other || 0;
                    totalCarbon += record.totalCarbon || 0;
                    totalInvoices += record.invoiceCount || 0;
                    recordDays++;
                }
            });
            
            // æ›´æ–°çµ±è¨ˆçµæœå€åŸŸ
            const periodStats = document.getElementById('periodStats');
            const periodTitle = document.getElementById('periodTitle');
            const periodContent = document.getElementById('periodContent');
            
            periodTitle.textContent = `ğŸ“ˆ è¿‘${days}å¤©çµ±è¨ˆ (${startDateStr} ~ ${endDateStr})`;
            
            periodContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>ğŸª è³¼ç‰©ç¸½è¨ˆ:</span>
                    <span style="font-weight: bold;">${totalShopping.toFixed(2)} kg COâ‚‚</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>ğŸš— äº¤é€šç¸½è¨ˆ:</span>
                    <span style="font-weight: bold;">${totalTransport.toFixed(2)} kg COâ‚‚</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>ğŸƒ æ´»å‹•ç¸½è¨ˆ:</span>
                    <span style="font-weight: bold;">${totalActivity.toFixed(2)} kg COâ‚‚</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span>ğŸ“‹ å…¶ä»–ç¸½è¨ˆ:</span>
                    <span style="font-weight: bold;">${totalOther.toFixed(2)} kg COâ‚‚</span>
                </div>
                <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 12px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 16px; font-weight: bold;">ğŸ“Š ç¸½ç¢³è¶³è·¡:</span>
                    <span style="font-size: 16px; font-weight: bold;">${totalCarbon.toFixed(2)} kg COâ‚‚</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>ğŸ“„ ç¸½ç™¼ç¥¨æ•¸:</span>
                    <span style="font-weight: bold;">${totalInvoices} å¼µ</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>ğŸ“… è¨˜éŒ„å¤©æ•¸:</span>
                    <span style="font-weight: bold;">${recordDays} å¤©</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>ğŸ“Š å¹³å‡æ¯æ—¥:</span>
                    <span style="font-weight: bold;">${recordDays > 0 ? (totalCarbon / recordDays).toFixed(2) : '0.00'} kg COâ‚‚</span>
                </div>
            `;
            
            periodStats.style.display = 'block';
        }
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        
        // æ¸¬è©¦æ„Ÿæ‡‰å™¨åŠŸèƒ½ï¼ˆåŸºæ–¼æ­£ç¢ºçš„ç”¨æˆ¶äº’å‹•äº‹ä»¶ï¼‰
        function testSensor() {
            console.log('ğŸ‘‰ æ¸¬è©¦æ„Ÿæ‡‰å™¨åŠŸèƒ½');
            const testBtn = document.getElementById('testSensorBtn');
            if (testBtn) {
                testBtn.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦...';
                testBtn.disabled = true;
                testBtn.style.background = '#6c757d';
            }
            
            if (!window.DeviceMotionEvent) {
                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´æ„Ÿæ‡‰å™¨');
                updateSensorStatus('âŒ ç€è¦½å™¨ä¸æ”¯æ´æ„Ÿæ‡‰å™¨');
                if (testBtn) {
                    testBtn.innerHTML = 'âŒ ä¸æ”¯æ´æ„Ÿæ‡‰å™¨';
                    setTimeout(() => {
                        testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨';
                        testBtn.disabled = false;
                        testBtn.style.background = '#007bff';
                    }, 3000);
                }
                return;
            }
            
            // ç›´æ¥åœ¨ç”¨æˆ¶äº’å‹•äº‹ä»¶ä¸­è«‹æ±‚æ„Ÿæ‡‰å™¨æ¬Šé™
            try {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    console.log('æ„Ÿæ‡‰å™¨éœ€è¦æ¬Šé™è«‹æ±‚ï¼Œæ­£åœ¨è«‹æ±‚...');
                    DeviceMotionEvent.requestPermission().then(response => {
                        console.log('æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚çµæœ:', response);
                        if (response === 'granted') {
                            console.log('âœ… æ„Ÿæ‡‰å™¨æ¬Šé™å·²æˆäºˆï¼Œé–‹å§‹æ¸¬è©¦');
                            updateSensorStatus('âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...');
                            
                            // é–‹å§‹æ„Ÿæ‡‰å™¨ç›£è½
                            window.addEventListener("devicemotion", function(e) {
                                if (e.acceleration) {
                                    console.log("ğŸ“± devicemotion: åŠ é€Ÿåº¦X=" + e.acceleration.x);
                                    handleMotion(e);
                                }
                            });
                            
                            if (testBtn) {
                                testBtn.innerHTML = 'âœ… æ¸¬è©¦æˆåŠŸï¼';
                                testBtn.style.background = '#28a745';
                                setTimeout(() => {
                                    testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨';
                                    testBtn.disabled = false;
                                    testBtn.style.background = '#007bff';
                                }, 3000);
                            }
                        } else {
                            console.log('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•');
                            updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•');
                            if (testBtn) {
                                testBtn.innerHTML = 'âŒ æ¬Šé™è¢«æ‹’çµ•';
                                setTimeout(() => {
                                    testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨';
                                    testBtn.disabled = false;
                                    testBtn.style.background = '#007bff';
                                }, 3000);
                            }
                        }
                    }).catch(error => {
                        console.log('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—:', error);
                        updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨æ¸¬è©¦å¤±æ•—');
                        if (testBtn) {
                            testBtn.innerHTML = 'âŒ æ¸¬è©¦å¤±æ•—';
                            setTimeout(() => {
                                testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨';
                                testBtn.disabled = false;
                                testBtn.style.background = '#007bff';
                            }, 3000);
                        }
                    });
                } else {
                    // Android / æ¡Œé¢ Chrome ç›´æ¥ç›£è½
                    console.log('âœ… Android/æ¡Œé¢ å·²å•Ÿç”¨æ„Ÿæ‡‰å™¨ç›£è½');
                    updateSensorStatus('âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨ï¼ŒæŒçºŒç›£è½ä¸­...');
                    
                    window.addEventListener("devicemotion", function(e) {
                        if (e.acceleration) {
                            console.log("ğŸ“± devicemotion: åŠ é€Ÿåº¦X=" + e.acceleration.x);
                            handleMotion(e);
                        }
                    });
                    
                    if (testBtn) {
                        testBtn.innerHTML = 'âœ… æ¸¬è©¦æˆåŠŸï¼';
                        testBtn.style.background = '#28a745';
                        setTimeout(() => {
                            testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨';
                            testBtn.disabled = false;
                            testBtn.style.background = '#007bff';
                        }, 3000);
                    }
                }
            } catch (e) {
                console.log("âŒ æ„Ÿæ‡‰å™¨å•Ÿç”¨éŒ¯èª¤:", e);
                updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨å•Ÿç”¨éŒ¯èª¤: ' + e.message);
                if (testBtn) {
                    testBtn.innerHTML = 'âŒ å•Ÿç”¨éŒ¯èª¤';
                    setTimeout(() => {
                        testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨';
                        testBtn.disabled = false;
                        testBtn.style.background = '#007bff';
                    }, 3000);
                }
            }
        }
        
        // é–‹å§‹æ„Ÿæ‡‰å™¨æ¸¬è©¦
        function startSensorTest() {
            let motionCount = 0;
            let lastMotionTime = 0;
            
            const motionHandler = function(event) {
                const now = Date.now();
                if (now - lastMotionTime < 100) return; // é˜²æ­¢éæ–¼é »ç¹
                lastMotionTime = now;
                
                const acceleration = event.accelerationIncludingGravity;
                if (acceleration) {
                    const totalAcceleration = Math.sqrt(
                        acceleration.x * acceleration.x +
                        acceleration.y * acceleration.y +
                        acceleration.z * acceleration.z
                    );
                    
                    if (totalAcceleration > 15) { // æª¢æ¸¬åˆ°æ˜é¡¯çš„æ–å‹•
                        motionCount++;
                        console.log('æª¢æ¸¬åˆ°æ–å‹•:', totalAcceleration, 'æ¬¡æ•¸:', motionCount);
                        
                        if (motionCount >= 3) {
                            updateSensorStatus('âœ… æ„Ÿæ‡‰å™¨é‹ä½œæ­£å¸¸ï¼æª¢æ¸¬åˆ° ' + motionCount + ' æ¬¡æ–å‹•');
                            window.removeEventListener('devicemotion', motionHandler);
                            
                            const testBtn = document.getElementById('testSensorBtn');
                            if (testBtn) {
                                testBtn.innerHTML = 'âœ… æ¸¬è©¦æˆåŠŸï¼';
                                testBtn.style.background = '#28a745';
                                setTimeout(() => {
                                    testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨ï¼ˆæ–å‹•æ‰‹æ©Ÿï¼‰';
                                    testBtn.disabled = false;
                                    testBtn.style.background = '#007bff';
                                }, 3000);
                            }
                            
                            // é–‹å§‹æ­£å¸¸çš„æ„Ÿæ‡‰å™¨è¿½è¹¤
                            startSensorTracking();
                        }
                    }
                }
            };
            
            window.addEventListener('devicemotion', motionHandler);
            
            // 10ç§’å¾Œåœæ­¢æ¸¬è©¦
            setTimeout(() => {
                window.removeEventListener('devicemotion', motionHandler);
                if (motionCount < 3) {
                    updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨æ¸¬è©¦å¤±æ•—ï¼šè«‹æ–å‹•æ‰‹æ©Ÿ');
                    const testBtn = document.getElementById('testSensorBtn');
                    if (testBtn) {
                        testBtn.innerHTML = 'âŒ è«‹æ–å‹•æ‰‹æ©Ÿ';
                        setTimeout(() => {
                            testBtn.innerHTML = 'ğŸ“± æ¸¬è©¦æ„Ÿæ‡‰å™¨ï¼ˆæ–å‹•æ‰‹æ©Ÿï¼‰';
                            testBtn.disabled = false;
                            testBtn.style.background = '#007bff';
                        }, 3000);
                    }
                }
            }, 10000);
        }
        
        // æ¸¬è©¦GPSåŠŸèƒ½ï¼ˆåŸºæ–¼æ­£ç¢ºçš„ç”¨æˆ¶äº’å‹•äº‹ä»¶ï¼‰
        function testGPS() {
            console.log('ğŸ‘‰ æ¸¬è©¦GPSåŠŸèƒ½');
            const testBtn = document.getElementById('testGPSBtn');
            if (testBtn) {
                testBtn.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦...';
                testBtn.disabled = true;
                testBtn.style.background = '#6c757d';
            }
            
            if (!navigator.geolocation) {
                console.log('âŒ ç€è¦½å™¨ä¸æ”¯æ´ GPS API');
                updateLocationStatus(null, 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½');
                if (testBtn) {
                    testBtn.innerHTML = 'âŒ ä¸æ”¯æ´GPS';
                    setTimeout(() => {
                        testBtn.innerHTML = 'ğŸ“ æ¸¬è©¦GPS';
                        testBtn.disabled = false;
                        testBtn.style.background = '#dc3545';
                    }, 3000);
                }
                return;
            }
            
            console.log('é–‹å§‹GPSæ¸¬è©¦...');
            updateLocationStatus(null, 'ğŸ”„ æ­£åœ¨æ¸¬è©¦GPS...');
            
            // ç›´æ¥åœ¨ç”¨æˆ¶äº’å‹•äº‹ä»¶ä¸­è«‹æ±‚GPSæ¬Šé™
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('âœ… GPS æ¸¬è©¦æˆåŠŸ:', position.coords.latitude, position.coords.longitude);
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const accuracy = position.coords.accuracy.toFixed(2);
                    
                    updateLocationStatus(position, null);
                    
                    if (testBtn) {
                        testBtn.innerHTML = 'âœ… æ¸¬è©¦æˆåŠŸï¼';
                        testBtn.style.background = '#28a745';
                        setTimeout(() => {
                            testBtn.innerHTML = 'ğŸ“ æ¸¬è©¦GPS';
                            testBtn.disabled = false;
                            testBtn.style.background = '#dc3545';
                        }, 3000);
                    }
                    
                    // é–‹å§‹æŒçºŒGPSç›£è½
                    navigator.geolocation.watchPosition(
                        function(p) {
                            console.log('ğŸ“ GPS æ›´æ–°:', p.coords.latitude, p.coords.longitude);
                            updateLocationStatus(p, null);
                            updateMovementData(p);
                            updateRealTimeDisplay();
                        },
                        function(err) {
                            console.log('âŒ GPS ç›£è½å¤±æ•—:', err.message);
                            updateLocationStatus(null, 'âŒ GPSç›£è½å¤±æ•—: ' + err.message);
                        },
                        { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                    );
                },
                function(error) {
                    console.log('âŒ GPS æ¸¬è©¦å¤±æ•—:', error.message);
                    if (error.code === error.PERMISSION_DENIED) {
                        updateLocationStatus(null, 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ä½ç½®æ¬Šé™');
                        if (testBtn) {
                            testBtn.innerHTML = 'âŒ æ¬Šé™è¢«æ‹’çµ•';
                            setTimeout(() => {
                                testBtn.innerHTML = 'ğŸ“ æ¸¬è©¦GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        updateLocationStatus(null, 'âŒ GPSä½ç½®ä¸å¯ç”¨');
                        if (testBtn) {
                            testBtn.innerHTML = 'âŒ ä½ç½®ä¸å¯ç”¨';
                            setTimeout(() => {
                                testBtn.innerHTML = 'ğŸ“ æ¸¬è©¦GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    } else if (error.code === error.TIMEOUT) {
                        updateLocationStatus(null, 'âŒ GPSå®šä½è¶…æ™‚');
                        if (testBtn) {
                            testBtn.innerHTML = 'âŒ å®šä½è¶…æ™‚';
                            setTimeout(() => {
                                testBtn.innerHTML = 'ğŸ“ æ¸¬è©¦GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    } else {
                        updateLocationStatus(null, 'âŒ GPSå®šä½å¤±æ•—');
                        if (testBtn) {
                            testBtn.innerHTML = 'âŒ å®šä½å¤±æ•—';
                            setTimeout(() => {
                                testBtn.innerHTML = 'ğŸ“ æ¸¬è©¦GPS';
                                testBtn.disabled = false;
                                testBtn.style.background = '#dc3545';
                            }, 3000);
                        }
                    }
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );
        }
        
        // å•Ÿç”¨GPS
        function autoEnableGPS() {
            if (!navigator.geolocation) {
                updateLocationStatus(null, 'âŒ ç€è¦½å™¨ä¸æ”¯æ´GPSå®šä½');
                return;
            }
            
            console.log('å•Ÿç”¨GPS...');
            updateLocationStatus(null, 'ğŸ”„ GPSæ­£åœ¨å•Ÿå‹•...');
            
            // ä½¿ç”¨æ›´ç©æ¥µçš„GPSè¨­å®šä¾†è§¸ç™¼æ¬Šé™è«‹æ±‚
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('GPSå•Ÿç”¨æˆåŠŸ:', position);
                    updateLocationStatus(position, null);
                    
                    // é–‹å§‹GPSè¿½è¹¤
                    startGPSTracking();
                },
                function(error) {
                    console.log('GPSå•Ÿç”¨å¤±æ•—:', error);
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            updateLocationStatus(null, 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ä½ç½®æ¬Šé™');
                            // å˜—è©¦å¤šæ¬¡è«‹æ±‚æ¬Šé™
                            retryGPSPermission(3);
                            break;
                        case error.POSITION_UNAVAILABLE:
                            updateLocationStatus(null, 'âŒ GPSä½ç½®ä¸å¯ç”¨');
                            break;
                        case error.TIMEOUT:
                            updateLocationStatus(null, 'âŒ GPSå®šä½è¶…æ™‚');
                            break;
                        default:
                            updateLocationStatus(null, 'âŒ GPSå®šä½å¤±æ•—');
                            break;
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                }
            );
        }
        
        // é‡è©¦GPSæ¬Šé™è«‹æ±‚
        function retryGPSPermission(retryCount) {
            if (retryCount <= 0) {
                updateLocationStatus(null, 'âŒ GPSæ¬Šé™è«‹æ±‚å¤±æ•—ï¼Œè«‹æ‰‹å‹•å…è¨±ä½ç½®æ¬Šé™');
                return;
            }
            
            console.log('é‡è©¦GPSæ¬Šé™è«‹æ±‚ï¼Œå‰©é¤˜æ¬¡æ•¸:', retryCount);
            
            setTimeout(() => {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('GPSé‡è©¦æˆåŠŸ:', position);
                        updateLocationStatus(position, null);
                        startGPSTracking();
                    },
                    function(error) {
                        console.log('GPSé‡è©¦å¤±æ•—:', error);
                        if (error.code === error.PERMISSION_DENIED) {
                            updateLocationStatus(null, 'âŒ GPSæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹æ‰‹å‹•å…è¨±ä½ç½®æ¬Šé™');
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            updateLocationStatus(null, 'âŒ GPSä½ç½®ä¸å¯ç”¨');
                        } else if (error.code === error.TIMEOUT) {
                            updateLocationStatus(null, 'âŒ GPSå®šä½è¶…æ™‚');
                        } else {
                            updateLocationStatus(null, 'âŒ GPSå®šä½å¤±æ•—: ' + error.message);
                        }
                    },
                    { 
                        enableHighAccuracy: false, 
                        timeout: 15000, 
                        maximumAge: 300000 
                    }
                );
            }, 2000);
        }
        
        // å•Ÿç”¨æ„Ÿæ‡‰å™¨
        function autoEnableSensor() {
            if (!window.DeviceMotionEvent) {
                updateSensorStatus('âŒ ç€è¦½å™¨ä¸æ”¯æ´æ„Ÿæ‡‰å™¨');
                return;
            }
            
            console.log('å•Ÿç”¨æ„Ÿæ‡‰å™¨...');
            updateSensorStatus('ğŸ”„ æ„Ÿæ‡‰å™¨æ­£åœ¨å•Ÿå‹•...');
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è«‹æ±‚æ¬Šé™
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                console.log('è«‹æ±‚æ„Ÿæ‡‰å™¨æ¬Šé™...');
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            console.log('æ„Ÿæ‡‰å™¨æ¬Šé™å·²æˆäºˆ');
                            updateSensorStatus('âœ… æ„Ÿæ‡‰å™¨å·²å•Ÿç”¨');
                            startSensorTracking();
                        } else {
                            console.log('æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•');
                            updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•');
                        }
                    })
                    .catch(error => {
                        console.log('æ„Ÿæ‡‰å™¨æ¬Šé™è«‹æ±‚å¤±æ•—:', error);
                        updateSensorStatus('âŒ æ„Ÿæ‡‰å™¨å•Ÿç”¨å¤±æ•—ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•');
                    });
            } else {
                console.log('æ„Ÿæ‡‰å™¨ä¸éœ€è¦æ¬Šé™è«‹æ±‚ï¼Œä½†éœ€è¦æ¸¬è©¦');
                updateSensorStatus('ğŸ”„ æ„Ÿæ‡‰å™¨éœ€è¦æ¸¬è©¦ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æ„Ÿæ‡‰å™¨ã€æŒ‰éˆ•');
            }
        }
        
        // æ›´æ–°æ„Ÿæ‡‰å™¨ç‹€æ…‹é¡¯ç¤º
        function updateSensorStatus(status) {
            const sensorStatusElement = document.getElementById('sensorStatus');
            if (sensorStatusElement) {
                if (status) {
                    sensorStatusElement.textContent = status;
                } else {
                    sensorStatusElement.textContent = ''; // ç©ºç™½ç‹€æ…‹
                }
            }
        }
        
        // æ›´æ–°è‡ªå‹•è¿½è¹¤ç‹€æ…‹é¡¯ç¤º
        function updateAutoTrackingStatus(status) {
            const autoTrackingElement = document.getElementById('autoTracking');
            if (autoTrackingElement) {
                if (status) {
                    autoTrackingElement.textContent = status;
                } else {
                    autoTrackingElement.textContent = ''; // ç©ºç™½ç‹€æ…‹
                }
            }
        }
        
        function getEmergencySolution(isIOS, isChrome, isSafari) {
            if (isIOS) {
                return `
                <div style="text-align: left; padding: 15px; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #c62828; margin: 0 0 10px 0;">ğŸš¨ iPhone GPSæ¬Šé™ç·Šæ€¥è§£æ±ºæ–¹æ¡ˆï¼š</h4>
                    <ol style="color: #c62828; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li><strong>å¾è¢å¹•åº•éƒ¨å‘ä¸Šæ»‘å‹•ä¸¦åœç•™</strong></li>
                        <li><strong>æ‰¾åˆ°Safariä¸¦å‘ä¸Šæ»‘å‹•é—œé–‰</strong></li>
                        <li><strong>é‡æ–°é»æ“ŠSafariåœ–æ¨™é–‹å•Ÿ</strong></li>
                        <li><strong>é‡æ–°æ‰“é–‹æ‡‰ç”¨</strong>ï¼šhttp://172.20.10.6:3003/</li>
                        <li><strong>ç«‹å³é»æ“Šã€ŒğŸš€ å¼·åˆ¶è«‹æ±‚GPSæ¬Šé™ã€</strong></li>
                        <li><strong>é¸æ“‡ã€Œå…è¨±ã€</strong></li>
                    </ol>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="color: #2e7d32; margin: 0; font-weight: bold;">ğŸ’¡ å¦‚æœé‚„æ˜¯å¤±æ•—ï¼Œå˜—è©¦ï¼š</p>
                        <ul style="color: #2e7d32; margin: 5px 0 0 0; padding-left: 20px;">
                            <li>åˆ°æˆ¶å¤–é–‹é—Šåœ°å¸¶é‡è©¦</li>
                            <li>ç¢ºä¿WiFiæˆ–è¡Œå‹•æ•¸æ“šæ­£å¸¸</li>
                            <li>é‡æ–°å•Ÿå‹•iPhone</li>
                            <li>æ›´æ–°iOSç³»çµ±</li>
                        </ul>
                    </div>
                </div>
                `;
            }
            return '';
        }
        
        // å‹å–„çš„æˆåŠŸæç¤ºæ¨¡æ…‹æ¡†
        function showSuccessModal(message) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;">
                    <div style="padding: 30px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; line-height: 1.5;">${message}</h3>
                        <button onclick="closeModal(this)" data-lang="confirm" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px;">
                            ç¢ºå®š
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // æ„è¦‹åé¥‹ç³»çµ±
        function showFeedbackForm() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #81C784 0%, #4CAF50 100%); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“</div>
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;" data-lang="feedback">æ„è¦‹åé¥‹</h3>
                            <div style="font-size: 14px; opacity: 0.9;" data-lang="feedback_title">æ‚¨çš„æ„è¦‹è®“æˆ‘å€‘è®Šå¾—æ›´å¥½</div>
                        </div>
                        
                        <form id="feedbackForm" style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="your_email">æ‚¨çš„Emailï¼š</label>
                                <input type="email" id="userEmail" data-lang="email_placeholder" placeholder="è«‹è¼¸å…¥æ‚¨çš„email" required 
                                       style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                                <style>
                                    #userEmail::placeholder { color: black; }
                                </style>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold;" data-lang="feedback_content">æ„è¦‹å…§å®¹ï¼š</label>
                                <textarea id="feedbackContent" data-lang="feedback_placeholder" placeholder="è«‹å‘Šè¨´æˆ‘å€‘æ‚¨çš„æƒ³æ³•ã€å»ºè­°æˆ–é«”é©—çš„è¶£äº‹...(150å­—å…§)" required rows="4"
                                          style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 14px; resize: vertical;"></textarea>
                                <style>
                                    #feedbackContent::placeholder { color: black; }
                                </style>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button type="button" onclick="submitFeedback()" data-lang="send_feedback" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    ç™¼é€åé¥‹
                                </button>
                                <button type="button" onclick="closeModal(this)" data-lang="cancel" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function submitFeedback() {
            const userEmail = document.getElementById('userEmail').value;
            const feedbackContent = document.getElementById('feedbackContent').value;
            
            if (!userEmail || !feedbackContent) {
                alert('è«‹å¡«å¯«å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            // ç›´æ¥ä½¿ç”¨å¾Œç«¯APIç™¼é€éƒµä»¶
            fetch('https://carbon-footprint-tracker-alpha.vercel.app/api/send-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userEmail: userEmail,
                    feedbackContent: feedbackContent
                })
            }).then(response => {
                console.log('APIå›æ‡‰ç‹€æ…‹:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('APIå›æ‡‰æ•¸æ“š:', data);
                if (data.success) {
                    showSuccessModal(t('feedback_success'));
                    closeModal(document.querySelector('.modal'));
                } else {
                    throw new Error(data.error || 'ç™¼é€å¤±æ•—');
                }
            }).catch(error => {
                console.error('ç™¼é€åé¥‹å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack
                });
                
                // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥è¤‡è£½åˆ°å‰ªè²¼æ¿ä¸¦é¡¯ç¤ºè©³ç´°ä¿¡æ¯
                const feedbackText = `ç™¼é€çµ¦: rbben521@gmail.com\nä¸»é¡Œ: æ¸›ç¢³æ—¥è¨˜ - ç”¨æˆ¶æ„è¦‹åé¥‹\n\nç”¨æˆ¶Email: ${userEmail}\n\næ„è¦‹å…§å®¹:\n${feedbackContent}`;
                
                // è¤‡è£½åˆ°å‰ªè²¼æ¿
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(feedbackText).then(function() {
                        alert('âœ… åé¥‹å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\n\nè«‹æ‰“é–‹æ‚¨çš„éƒµä»¶æ‡‰ç”¨ç¨‹å¼ï¼Œè²¼ä¸Šå…§å®¹ä¸¦ç™¼é€çµ¦ï¼š\nrbben521@gmail.com\n\nä¸»é¡Œï¼šæ¸›ç¢³æ—¥è¨˜ - ç”¨æˆ¶æ„è¦‹åé¥‹');
                    }).catch(function() {
                        // å¦‚æœè¤‡è£½å¤±æ•—ï¼Œé¡¯ç¤ºå®Œæ•´ä¿¡æ¯
                        showFallbackInstructions(userEmail, feedbackContent);
                    });
                } else {
                    // å¦‚æœç€è¦½å™¨ä¸æ”¯æ´å‰ªè²¼æ¿APIï¼Œé¡¯ç¤ºå®Œæ•´ä¿¡æ¯
                    showFallbackInstructions(userEmail, feedbackContent);
                }
                
                closeModal(document.querySelector('.modal'));
            });
        }
        
        // é¡¯ç¤ºå‚™ç”¨æ–¹æ¡ˆçš„è©³ç´°èªªæ˜
        function showFallbackInstructions(userEmail, feedbackContent) {
            const instructions = `ğŸ“§ è«‹æ‰‹å‹•ç™¼é€éƒµä»¶è‡³ï¼šrbben521@gmail.com

ğŸ“ éƒµä»¶å…§å®¹ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ”¶ä»¶äººï¼šrbben521@gmail.com
ä¸»é¡Œï¼šæ¸›ç¢³æ—¥è¨˜ - ç”¨æˆ¶æ„è¦‹åé¥‹

ç”¨æˆ¶Emailï¼š${userEmail}

æ„è¦‹å…§å®¹ï¼š
${feedbackContent}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

è«‹è¤‡è£½ä»¥ä¸Šå…§å®¹åˆ°æ‚¨çš„éƒµä»¶æ‡‰ç”¨ç¨‹å¼ä¸¦ç™¼é€ã€‚`;
            
            alert(instructions);
        }
        
    </script>
</body>
</html>
